---
title: "INLA-SPDE All Model"
author: "Andrew Fichera"
date: "24/09/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### R Setup

```{r}
setwd("C:/Users/andre/Desktop/Fish/University/Master of Science (Mathematics and Statistics)/14 - CSC8410/Models/Model 19")
```

### Manage Packages

```{r}
library(dplyr)
library(ggplot2)
library(ggspatial)
library(kableExtra)
library(grid)
library(gridExtra)
library(corrplot)
library(INLA)
library(INLAutils)
library(viridis)
library(RColorBrewer)
library(leaflet)
library(pROC)
library(spdep)
library(lme4)
library(dotwhisker)
library(LPCM)
#library(caret)
library(doParallel)
#library(egg)
library(ggpubr)
library(geoR)
```

# Astrebla pectinata

### Load and Manage Dataset

```{r}
# Load Dataset
load("j2_clay515.Rdata")
j2 <- j2_clay515
remove(j2_clay515)

# Subset Dataset for `Astrebla pectinata`
j2 <- dplyr::select(j2, nitrogen515, awc515, phosphorus515, carbon515, clay515, rain18, tmin18, tmax18, tdiff18, c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees., `Astrebla pectinata`)

# Manage Dataset
# Convert Longitude and Latitude Variables to double type
j2$c3c4.Longitude..Decimal.Degrees. <- as.double(j2$c3c4.Longitude..Decimal.Degrees.)
j2$c3c4.Latitude..Decimal.Degrees. <- as.double(j2$c3c4.Latitude..Decimal.Degrees.)
```

### Rename j2 Variables

```{r}
colnames(j2) <- c("nitr", "awc", "phos", "carb", "clay", "rain", "tmin", "tmax", "tdif", "c3c4.Longitude..Decimal.Degrees.", "c3c4.Latitude..Decimal.Degrees.", "Astrebla pectinata")
```

### Data Cleaning and Preparation

```{r}
# Remove Observations with 'NA' values
j2 <- j2[complete.cases(j2),]
#
# Removal of Anomolous Data points
j2 <- subset(j2, j2$nitr != 0)
#
# Removal of Outliers using the IQR Criterion
#
# Remove Outliers - 'nitr' covariate
ol.quantile.nitr <- quantile(j2$nitr, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.nitr <- IQR(j2$nitr, na.rm = TRUE)
ol.upper.nitr <- ol.quantile.nitr[2] + 1.5*ol.iqr.nitr
ol.lower.nitr <- ol.quantile.nitr[1] - 1.5*ol.iqr.nitr
#
# Remove Outliers - 'awc' covariate
ol.quantile.awc <- quantile(j2$awc, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.awc <- IQR(j2$awc, na.rm = TRUE)
ol.upper.awc <- ol.quantile.awc[2] + 1.5*ol.iqr.awc
ol.lower.awc <- ol.quantile.awc[1] - 1.5*ol.iqr.awc
#
# Remove Outliers - 'phos' covariate
ol.quantile.phos <- quantile(j2$phos, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.phos <- IQR(j2$phos, na.rm = TRUE)
ol.upper.phos <- ol.quantile.phos[2] + 1.5*ol.iqr.phos
ol.lower.phos <- ol.quantile.phos[1] - 1.5*ol.iqr.phos
#
# Remove Outliers - 'carb' covariate
ol.quantile.carb <- quantile(j2$carb, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.carb <- IQR(j2$carb, na.rm = TRUE)
ol.upper.carb <- ol.quantile.carb[2] + 1.5*ol.iqr.carb
ol.lower.carb <- ol.quantile.carb[1] - 1.5*ol.iqr.carb
#
# Remove Outliers - 'clay' covariate
ol.quantile.clay <- quantile(j2$clay, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.clay <- IQR(j2$clay, na.rm = TRUE)
ol.upper.clay <- ol.quantile.clay[2] + 1.5*ol.iqr.clay
ol.lower.clay <- ol.quantile.clay[1] - 1.5*ol.iqr.clay
#
# Remove Outliers - 'rain' covariate
ol.quantile.rain <- quantile(j2$rain, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.rain <- IQR(j2$rain, na.rm = TRUE)
ol.upper.rain <- ol.quantile.rain[2] + 1.5*ol.iqr.rain
ol.lower.rain <- ol.quantile.rain[1] - 1.5*ol.iqr.rain
#
# Remove Outliers - 'tmin' covariate
ol.quantile.tmin <- quantile(j2$tmin, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.tmin <- IQR(j2$tmin, na.rm = TRUE)
ol.upper.tmin <- ol.quantile.tmin[2] + 1.5*ol.iqr.tmin
ol.lower.tmin <- ol.quantile.tmin[1] - 1.5*ol.iqr.tmin
#
# Remove Outliers - 'tmin' covariate
ol.quantile.tmin <- quantile(j2$tmin, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.tmin <- IQR(j2$tmin, na.rm = TRUE)
ol.upper.tmin <- ol.quantile.tmin[2] + 1.5*ol.iqr.tmin
ol.lower.tmin <- ol.quantile.tmin[1] - 1.5*ol.iqr.tmin
#
# Remove Outliers - 'tdif' covariate
ol.quantile.tdif <- quantile(j2$tdif, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.tdif <- IQR(j2$tdif, na.rm = TRUE)
ol.upper.tdif <- ol.quantile.tdif[2] + 1.5*ol.iqr.tdif
ol.lower.tdif <- ol.quantile.tdif[1] - 1.5*ol.iqr.tdif
#
# Subsetting
j2 <- subset(j2, nitr > ol.lower.nitr & nitr < ol.upper.nitr)
j2 <- subset(j2, awc > ol.lower.awc & awc < ol.upper.awc)
j2 <- subset(j2, phos > ol.lower.phos & phos < ol.upper.phos)
j2 <- subset(j2, carb > ol.lower.carb & carb < ol.upper.carb)
j2 <- subset(j2, clay > ol.lower.clay & clay < ol.upper.clay)
j2 <- subset(j2, rain > ol.lower.rain & rain < ol.upper.rain)
j2 <- subset(j2, tmin > ol.lower.tmin & tmin < ol.upper.tmin)
j2 <- subset(j2, tmin > ol.lower.tmin & tmin < ol.upper.tmin)
j2 <- subset(j2, tdif > ol.lower.tdif & tdif < ol.upper.tdif)
#
```

### Spatial Map of Observed Data

```{r}
# Mapping Objects
world_shp <- sf::st_as_sf(maps::map("world", plot = FALSE, fill = TRUE))
aus_shp<- world_shp[world_shp$ID == "Australia",]

# Mapping Colours
map.colours <- c("Absence" = "gray", "Presence" = "steelblue", "Removed" = "pink")

j2$Species <- c("Astrebla pectinata")

# Astrebla pectinata Spatial Plot - All Available Data
plot.study.area <- ggplot() +
#ggplot() +
  geom_sf(data = aus_shp, fill = "white") +
  coord_sf(xlim = c(110.00, 157.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  annotation_scale(location = "bl", width_hint = 0.5) +
  annotation_north_arrow(location = "tl", which_north = "true",
                         pad_x = unit(0.15, "in"), pad_y = unit(0.1, "in"),
                         style = north_arrow_fancy_orienteering) +
  #geom_point(data = subset(j2, `Astrebla pectinata`==0),
  #           aes(x = c3c4.Longitude..Decimal.Degrees.,
  #               y = c3c4.Latitude..Decimal.Degrees., colour = "Absence")) +
  #geom_point(data = subset(j2, `Astrebla pectinata`==1),
  #           aes(x = c3c4.Longitude..Decimal.Degrees.,
  #               y = c3c4.Latitude..Decimal.Degrees., colour = "Presence")) +
  geom_point(data = j2, aes(x = c3c4.Longitude..Decimal.Degrees.,
                 y = c3c4.Latitude..Decimal.Degrees., colour = Species)) +
  #labs(x = "Longitude", y = "Latitude", color = "Legend") +
  labs(x = "Longitude (\u00B0)", y = "Latitude (\u00B0)") +
  scale_color_manual(values = map.colours) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.margin = unit(c(0,0,0,2), "mm")) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  theme_minimal()
  #theme(legend.title = element_blank()) +
  #theme(legend.position = "none")
plot.study.area
#ggsave("Study Area.png", device = "png")
```

### Descriptive Statistics

```{r eval=FALSE, include=FALSE}
response.table <- table(j2$`Astrebla pectinata`)
response.table <- data.frame(response.table)
response.table[,1] <- c("Absence", "Presence")
response.table[,3] <- c(paste(round((response.table[1,2]/sum(response.table[,2]))*100,2),"%"), paste(round((response.table[2,2]/sum(response.table[,2]))*100,2),"%"))
response.table[3,] <- c("Total", sum(response.table[,2]), "100.00%")
knitr::kable(response.table, col.names = c(" ", "Count", "Proportion"), caption = "Summary of Absence/Presence Response in Astrebla pectinata") %>% kable_styling(full_width = FALSE) %>%
  save_kable("astrebla-covariate-table.png")
response.table
```

```{r eval=FALSE, include=FALSE}
#descriptive.data.frame <- j2 %>% dplyr::select(nitr, awc, phos, carb, clay, rain, tmin, tmax, tdif, `Astrebla pectinata`)
descriptive.data.frame <- j2 %>% dplyr::select(nitr, awc, phos, carb, clay, rain, tmin, tmax, tdif)

plotnitr <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = nitr)) +
  theme_minimal() + 
  theme(axis.text.y = element_blank()) +
  scale_x_continuous(breaks = c(min(j2$nitr), 0.04, 0.08, 0.12, max(j2$nitr)), labels = scales::number_format(accuracy = 0.01))

plotawc <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = awc)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plotphos <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = phos)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank()) +
  scale_x_continuous(breaks = c(0.01, 0.02, 0.03, 0.04, 0.05, max(j2$phos)), labels = scales::number_format(accuracy = 0.01))

plotcarb <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = carb)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plotclay <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = clay)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plotrain <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = rain)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plottmin <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = tmin)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plottmax <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = tmax)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plottdif <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = tdif)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

grid.arrange(plotnitr, plotawc, plotphos, plotcarb, plotclay, plotrain, plottmin, plottmax, plottdif, ncol = 3)
```

```{r eval=FALSE, include=FALSE}
### Descriptive statistics Table for Paper
# 
# awc
paste("awc min:", round(min(j2$awc),4))
paste("awc mean:", round(mean(j2$awc),4))
paste("awc max:", round(max(j2$awc),4))
#
paste("")
# clay
paste("clay min:", round(min(j2$clay),4))
paste("clay mean:", round(mean(j2$clay),4))
paste("clay max:", round(max(j2$clay),4))
#
paste("")
# nitr
paste("nitr min:", round(min(j2$nitr),4))
paste("nitr mean:", round(mean(j2$nitr),4))
paste("nitr max:", round(max(j2$nitr),4))
#
paste("")
# phos
paste("phos min:", round(min(j2$phos),4))
paste("phos mean:", round(mean(j2$phos),4))
paste("phos max:", round(max(j2$phos),4))
#
paste("")
# rain
paste("rain min:", round(min(j2$rain),4))
paste("rain mean:", round(mean(j2$rain),4))
paste("rain max:", round(max(j2$rain),4))
#
paste("")
# tdif
paste("tdif min:", round(min(j2$tdif),4))
paste("tdif mean:", round(mean(j2$tdif),4))
paste("tdif max:", round(max(j2$tdif),4))
# 
paste("")
# tmax
paste("tmax min:", round(min(j2$tmax),4))
paste("tmax mean:", round(mean(j2$tmax),4))
paste("tmax max:", round(max(j2$tmax),4))
```

### Multicollinearity

```{r eval=FALSE, include=FALSE}
j2.corr <- cor(descriptive.data.frame)
corrplot(j2.corr, method = 'number')
```

Selected Model Covariates for Astrebla pectinata following review of Multicollinearity:

* nitr
* awc
* phos
* clay
* rain
* tmax
* tdif

### Covariate Standardisation

```{r}
# Load Functions
source("cent.R")
source("reversecent.R")
#
# Create Standardised j2 Data Frame
j2.cent <- data.frame(matrix(NA, nrow = nrow(j2), ncol = 0))
j2.cent$nitr <- cent(j2$nitr)
j2.cent$awc <- cent(j2$awc)
j2.cent$phos <- cent(j2$phos)
j2.cent$carb <- cent(j2$carb)
j2.cent$clay <- cent(j2$clay)
j2.cent$rain <- cent(j2$rain)
j2.cent$tmin <- cent(j2$tmin)
j2.cent$tmax <- cent(j2$tmax)
j2.cent$tdif <- cent(j2$tdif)
j2.cent$c3c4.Longitude..Decimal.Degrees. <- j2$c3c4.Longitude..Decimal.Degrees.
j2.cent$c3c4.Latitude..Decimal.Degrees. <- j2$c3c4.Latitude..Decimal.Degrees.
j2.cent$`Astrebla pectinata` <- j2$`Astrebla pectinata`
#
```

## Model Fitting

### glm Model

```{r}
formula <- `Astrebla pectinata` ~ nitr + awc + phos + clay + rain + tmax + tdif

glm.results.ap <- glm(formula, data = j2.cent, family = "binomial")
summary(glm.results.ap)
```

### Plot glm Results using Leaflet

```{r}
pal <- colorNumeric("viridis", c(0, 1), na.color = "transparent")
```

```{r eval=FALSE, include=FALSE}
leaflet() %>% addTiles() %>%
  addCircles(lng = j2$c3c4.Longitude..Decimal.Degrees., lat = j2$c3c4.Latitude..Decimal.Degrees., color = pal(glm.results.ap$fitted.values)) %>%
  addLegend("bottomright", pal = pal, values = glm.results.ap$fitted.values, title = "Mean Presence Prob") %>%
  addScaleBar(position = c("bottomleft"))
```

### Base INLA Model

```{r}
# Base INLA - Linear Fixed Effects with Spatial Random Effect Included

### Prepare Prediction Data Frame
j2.pred.temp <- j2.cent
j2.pred.temp$`Astrebla pectinata` <- NA
j2.pred <- rbind(j2.cent, j2.pred.temp)

### Spatial Random Effect
# Create Spatial Points
j2.coords <- subset(j2, select = c(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees.))
j2.spat.points <- SpatialPointsDataFrame(coords = j2.coords, data = j2, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Create Spatial dataframe
x <- data.frame(matrix(NA, nrow = nrow(j2.spat.points), ncol = 0))
x$Longitude <- j2.spat.points$c3c4.Longitude..Decimal.Degrees.
x$Latitude <- j2.spat.points$c3c4.Latitude..Decimal.Degrees.

# Calculate Clusters using Mean Shift Clustering
j2.mean.shift <- ms(x, h = 0.1, scaled = FALSE, iter = 200, plotms = -1)

j2.pred$ID <- cent(j2.mean.shift$cluster.label)

### Formula
formula <- "`Astrebla pectinata`" ~ nitr + awc + phos + clay + rain + tmax + tdif + f(ID, model = "iid")

### Fit Model
base.inla.results.ap <- inla(formula,
                  family = "binomial",
                  data = j2.pred,
                  control.family = list(link = "logit"),
                  control.predictor = list(link = 1, compute = TRUE),
                  control.compute = list(dic = TRUE, cpo = TRUE, waic = TRUE),
                  verbose = FALSE) # TRUE if full output is required
summary(base.inla.results.ap)
```

### Plot Base INLA Results using Leaflet

```{r eval=FALSE, include=FALSE}
leaflet() %>% addTiles() %>%
  addCircles(lng = j2$c3c4.Longitude..Decimal.Degrees., lat = j2$c3c4.Latitude..Decimal.Degrees., color = pal(base.inla.results.ap$summary.fitted.values$mean)) %>%
  addLegend("bottomright", pal = pal, values = base.inla.results.ap$summary.fitted.values$mean, title = "Mean Presence Prob") %>%
  addScaleBar(position = c("bottomleft"))
```

### INLA-SPDE Model

```{r}
# Create Observed Data Mesh
j2.coord <- cbind(j2$c3c4.Longitude..Decimal.Degrees., j2$c3c4.Latitude..Decimal.Degrees.)
mesh <- inla.mesh.2d(loc = j2.coord, max.edge = c(5, 10), offset = c(3, 7))
spde <- inla.spde2.matern(mesh = mesh, alpha = 2, constr = TRUE)
indexs <- inla.spde.make.index("s", spde$n.spde)
A <- inla.spde.make.A(mesh = mesh, loc = j2.coord) # Create Projection Matrix A

# Create Predicted Data Mesh 
j2.coord.pred <- cbind(j2$c3c4.Longitude..Decimal.Degrees., j2$c3c4.Latitude..Decimal.Degrees.)
mesh.pred <- inla.mesh.2d(loc = j2.coord.pred, max.edge = c(5, 10), offset = c(3, 7))
A.pred <- inla.spde.make.A(mesh = mesh.pred, loc = j2.coord.pred) # Create Predicted Projection Matrix A

# Create Observed Stack
stk.obs <- inla.stack(tag = "obs", data = list(y = j2.cent$`Astrebla pectinata`), 
                    A = list(1, A), effects = list(data.frame(b0 = 1, nitr = j2.cent$nitr,
                    awc = j2.cent$awc, phos = j2.cent$phos, clay = j2.cent$clay,
                    rain = j2.cent$rain, tmax = j2.cent$tmax, tdif = j2.cent$tdif), s = indexs))

stk.pred <- inla.stack(tag = "pred", data = list(y = NA), A = list(1, A.pred), 
                       effects = list(data.frame(b0 = 1, nitr = j2.cent$nitr,
                       awc = j2.cent$awc, phos = j2.cent$phos, 
                       clay = j2.cent$clay, rain = j2.cent$rain, 
                       tmin = j2.cent$tmax, tdif12 = j2.cent$tdif), s = indexs))
#
# Combine Stacks
stk.full <- inla.stack(stk.obs, stk.pred)

formula <- y ~ 0 + b0 + nitr + awc + phos + clay + rain + tmax + tdif + f(s, model = spde)
#
```

### Display Mesh

```{r eval=FALSE, include=FALSE}
plot(mesh)
points(x = j2.coord[,1], y = j2.coord[,2], col = "red", pch = 19, cex = 0.5)
```

### Run INLA-SPDE Model

```{r}
inla.spde.results.ap <- inla(formula, family = "binomial", 
            control.family = list(link = "logit"),
            data = inla.stack.data(stk.full),
            control.predictor = list(compute = TRUE, link = 1, A = inla.stack.A(stk.full)))
```

### INLA-SPDE Model Results

```{r}
summary(inla.spde.results.ap)

index <- inla.stack.index(stack = stk.full, tag = "pred")$data

pres_mean <- inla.spde.results.ap$summary.fitted.values[index, "mean"]
pres_ll <- inla.spde.results.ap$summary.fitted.values[index, "0.025quant"]
pres_ul <- inla.spde.results.ap$summary.fitted.values[index, "0.975quant"]

pal <- colorNumeric("viridis", c(0, 1), na.color = "transparent")
```

### Astrebla pectinata Mean Predicted Species Presence using Leaflet

```{r}
leaflet() %>% addTiles() %>%
  addCircles(lng = j2.coord.pred[,1], lat = j2.coord.pred[, 2], color = pal(pres_mean)) %>%
  addLegend("bottomright", pal = pal, values = pres_mean, title = "Mean Presence Prob") %>%
  addScaleBar(position = c("bottomleft"))
```

### INLA-SPDE Model Validity (AUC and ROC)

```{r}
# glm ROC
glm.predictions.ap <- glm.results.ap$fitted.values
glm.roc.data.ap <- roc(response = j2$`Astrebla pectinata`, predictor = glm.predictions.ap, auc = TRUE)
glm.roc.data.spec.ap <- as.data.frame(glm.roc.data.ap$specificities)
glm.roc.data.sens.ap <- as.data.frame(glm.roc.data.ap$sensitivities)
glm.roc.data.final.ap <- cbind(glm.roc.data.spec.ap, glm.roc.data.sens.ap)

# Base INLA ROC
base.inla.predictions.ap <- base.inla.results.ap$summary.fitted.values$mean[(nrow(j2.cent)+1):length(base.inla.results.ap$summary.fitted.values$mean)]
base.inla.roc.data.ap <- roc(response = j2$`Astrebla pectinata`, predictor = base.inla.predictions.ap, auc = TRUE)
base.inla.roc.data.spec.ap <- as.data.frame(base.inla.roc.data.ap$specificities)
base.inla.roc.data.sens.ap <- as.data.frame(base.inla.roc.data.ap$sensitivities)
base.inla.roc.data.final.ap <- cbind(base.inla.roc.data.spec.ap, base.inla.roc.data.sens.ap)

# INLA-SPDE ROC
predictions.ap <- inla.spde.results.ap$summary.fitted.values$mean[1:length(j2.cent$nitr)]
roc.data.ap <- roc(response = j2$`Astrebla pectinata`, predictor = predictions.ap, auc = TRUE)
roc.data.spec.ap <- as.data.frame(roc.data.ap$specificities)
roc.data.sens.ap <- as.data.frame(roc.data.ap$sensitivities)
roc.data.final.ap <- cbind(roc.data.spec.ap, roc.data.sens.ap)

zzz.plot.ap.roc <- ggplot() +
  geom_segment(aes(x = 1, y = 0, xend = 0, yend = 1), color = "gray") +
  geom_line(data = glm.roc.data.final.ap, aes(x = `glm.roc.data.ap$specificities`, y = `glm.roc.data.ap$sensitivities`), color = "red", lwd = 0.75) +
  geom_line(data = base.inla.roc.data.final.ap, aes(x = `base.inla.roc.data.ap$specificities`, y = `base.inla.roc.data.ap$sensitivities`), color = "blue", lwd = 0.75) +
  geom_line(data = roc.data.final.ap, aes(x = `roc.data.ap$specificities`, y = `roc.data.ap$sensitivities`), lwd = 0.75) +
  scale_x_reverse() + 
  theme_minimal() +
  #xlab("Specificity") +
  ylab("Sensitivity") +
  #ggtitle("Astrebla pectinata Model - ROC Curves") +
  theme(axis.title.x = element_blank()) +
  #theme(axis.title.y = element_blank()) +
  geom_label(aes(x = 0.25, y = 0.375, label = paste("INLA-SPDE AUC:", round(roc.data.ap$auc, 4))), size = 3) +
  geom_label(aes(x = 0.25, y = 0.225, label = paste("INLA AUC:", round(base.inla.roc.data.ap$auc, 4))), color = "blue", size = 3) +
  geom_label(aes(x = 0.25, y = 0.075, label = paste("glm AUC:", round(glm.roc.data.ap$auc, 4))), color = "red", size = 3)
# Including the clay*rain interaction effect increased AUC from 0.9337 to 0.9345
```

### Review Spatial Autocorrelation

```{r}
### Calculate Residuals for glm model

# Create Spatial Points
j2.coords <- subset(j2, select = c(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees.))
j2.spat.points <- SpatialPointsDataFrame(coords = j2.coords, data = j2, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Calculate k nearest neighbours
j2.coords.knearneigh <- knearneigh(j2.spat.points)

# Calculate neighbours list
j2.nb <- knn2nb(j2.coords.knearneigh)

# Supplement the neighbours list with spatial weights
lw <- nb2listw(j2.nb)

# Run Morans I Test glm
moran.test(glm.results.ap$residuals, lw, na.action = na.omit)
```

```{r}
### Calculate Residuals
j2.residuals <- j2 %>%
  mutate(
    mu = base.inla.results.ap$summary.fitted.values$mean[(nrow(j2)+1):nrow(j2.pred)],
    residuals = `Astrebla pectinata` - mu
)

# Create Spatial Points
j2.coords <- subset(j2, select = c(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees.))
j2.spat.points <- SpatialPointsDataFrame(coords = j2.coords, data = j2, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Calculate k nearest neighbours
j2.coords.knearneigh <- knearneigh(j2.spat.points)

# Calculate neighbours list
j2.nb <- knn2nb(j2.coords.knearneigh)

# Supplement the neighbours list with spatial weights
lw <- nb2listw(j2.nb)

# Run Morans I Test Base INLA
moran.test(j2.residuals$residuals, lw, na.action = na.omit)
```

```{r}
### Calculate Residuals using the Stack Index
si <- inla.stack.index(stk.obs, "obs")$data
j2.residuals <- j2 %>%
  mutate(
    mu = inla.spde.results.ap$summary.fitted.values$mean[si],
    residuals = `Astrebla pectinata` - mu
)

# Create Spatial Points
j2.coords <- subset(j2, select = c(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees.))
j2.spat.points <- SpatialPointsDataFrame(coords = j2.coords, data = j2, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Calculate k nearest neighbours
j2.coords.knearneigh <- knearneigh(j2.spat.points)

# Calculate neighbours list
j2.nb <- knn2nb(j2.coords.knearneigh)

# Supplement the neighbours list with spatial weights
lw <- nb2listw(j2.nb)

# Run Morans I Test Base INLA
moran.test(j2.residuals$residuals, lw, na.action = na.omit)

# The p-value is not statistically significant, and the z-score is positive.
# The null hypothesis is not rejected. The spatial distribution of high values 
# and/or low values in the dataset is not more spatially clustered than would 
# be expected if underlying spatial processes were random, ie. spatial
# autocorrelation adequately accounted for.
```

## Model Parameter Estimates

```{r}
glm.confint.ap <- confint(glm.results.ap)
glm.names.ap <- c("nitr", "awc", "phos", "clay", "rain", "tmax", "tdif")
glm.lower.ap <- c(glm.confint.ap[2], glm.confint.ap[3], glm.confint.ap[4], glm.confint.ap[5], glm.confint.ap[6], glm.confint.ap[7], glm.confint.ap[8])
glm.upper.ap <- c(glm.confint.ap[10], glm.confint.ap[11], glm.confint.ap[12], glm.confint.ap[13], glm.confint.ap[14], glm.confint.ap[15], glm.confint.ap[16])

yyy.plot.mpe.ap <- ggplot() +
  geom_vline(xintercept = 0, colour = "grey20", lty = "dashed") +
  geom_point(aes(x = glm.results.ap$coefficients[2:8], y = names(glm.results.ap$coefficients[2:8]), colour = "glm"), position = position_nudge(y = 0.25), size = 1.5) +
  geom_point(aes(x = inla.spde.results.ap$summary.fixed$mean[2:8], y = c("nitr", "awc", "phos", "clay", "rain", "tmax", "tdif"), colour = "INLA-SPDE"), position = position_nudge(y = -0.25), size = 1.5) +
  geom_point(aes(x = base.inla.results.ap$summary.fixed$mean[2:8], y = base.inla.results.ap$names.fixed[2:8], colour = "INLA"), position = position_nudge(y = 0), size = 1.5) +
  #
  geom_errorbarh(aes(xmin = glm.lower.ap, xmax = glm.upper.ap, y = glm.names.ap, colour = "glm"), position = position_nudge(y = 0.25), height = 0.175, lwd = 0.75) +
  geom_errorbarh(aes(xmin = inla.spde.results.ap$summary.fixed$`0.025quant`[2:8], xmax = inla.spde.results.ap$summary.fixed$`0.975quant`[2:8], y = c("nitr", "awc", "phos", "clay", "rain", "tmax", "tdif"), colour = "INLA-SPDE"), position = position_nudge(y = -0.25), height = 0.175, lwd = 0.75) +
  geom_errorbarh(aes(xmin = base.inla.results.ap$summary.fixed$`0.025quant`[2:8], xmax = base.inla.results.ap$summary.fixed$`0.975quant`[2:8], y = base.inla.results.ap$names.fixed[2:8], colour = "INLA"), position = position_nudge(y = 0), height = 0.175, lwd = 0.75) +
  #
  #ylab("Model Parameters") +
  #xlab("") +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank()) +
  xlim(-2.5, 4.5) +
  scale_x_continuous(breaks = c(-2, -1, 0, 1, 2, 3, 4), limits = c(-2.5, 4.5)) +
  scale_color_manual(name = "Model", breaks = c("glm", "INLA", "INLA-SPDE"), values = c("red", "blue", "black"))
```

## Spatial Extrapolation Plots

```{r}
# Load in Prediction Grid
load("extrap_df.Rdata")

colnames(extrap_df) <- c("Longitude", "Latitude", "clay", "awc", "carb", "nitr", "phos", "rain1982", "rain2011", "tmax1982", "tmax2011", "tmin1982", "tmin2011","tdif1982", "tdif2011")

# Create Prediction Dataframe
df.pred <- extrap_df[,1:2]
df.pred$clay <- extrap_df$clay
df.pred$awc <- extrap_df$awc
df.pred$carb <- extrap_df$carb
df.pred$nitr <- extrap_df$nitr
df.pred$phos <- extrap_df$phos
df.pred$rain1982 <- extrap_df$rain1982
df.pred$rain2011 <- extrap_df$rain2011
df.pred$tmax1982 <- extrap_df$tmax1982
df.pred$tmax2011 <- extrap_df$tmax2011
df.pred$tdif1982 <- extrap_df$tdif1982
df.pred$tdif2011 <- extrap_df$tdif2011
```

### glm Model

```{r}
# Fit Prediction GLM
formula <- `Astrebla pectinata` ~ nitr + awc + phos + clay + rain + tmax + tdif
glm.pred.results <- glm(formula, data = j2, family = "binomial")

# 1982 Climatic Data Frame
df.pred.1982 <- df.pred %>% dplyr::select(Longitude, Latitude, clay, awc, carb, nitr, phos, rain1982, tmax1982, tdif1982)

colnames(df.pred.1982) <- c("Longitude", "Latitude", "clay", "awc", "carb", "nitr", "phos", "rain", "tmax", "tdif")

# Predict New Values using GLM
extrap.glm.1982 <- as.data.frame(predict.glm(glm.pred.results, newdata = df.pred.1982, type = "link", se.fit = TRUE)) 

###
ilink <- family(glm.pred.results)$linkinv
extrap.glm.1982 <- transform(extrap.glm.1982, Fitted = ilink(fit), Upper = ilink(fit + (2 * se.fit)), Lower = ilink(fit - (2 * se.fit)))
extrap.glm.1982$`Predicted Range` <- extrap.glm.1982$Upper - extrap.glm.1982$Lower
###

extrap.glm.1982$Longitude <- df.pred$Longitude
extrap.glm.1982$Latitude <- df.pred$Latitude

colnames(extrap.glm.1982) <- c("fit", "se.fit", "residual.scale", "Presence Probability", "Upper", "Lower", "Predicted Range", "Longitude", "Latitude")

# 2011 Climatic Data Frame
df.pred.2011 <- df.pred %>% dplyr::select(Longitude, Latitude, clay, awc, carb, nitr, phos, rain2011, tmax2011, tdif2011)

colnames(df.pred.2011) <- c("Longitude", "Latitude", "clay", "awc", "carb", "nitr", "phos", "rain", "tmax", "tdif")

# Predict New Values using GLM
extrap.glm.2011 <- as.data.frame(predict.glm(glm.pred.results, newdata = df.pred.2011, type = "link", se.fit = TRUE))

###
extrap.glm.2011 <- transform(extrap.glm.2011, Fitted = ilink(fit), Upper = ilink(fit + (2 * se.fit)), Lower = ilink(fit - (2 * se.fit)))
extrap.glm.2011$`Predicted Range` <- extrap.glm.2011$Upper - extrap.glm.2011$Lower
###

extrap.glm.2011$Longitude <- df.pred$Longitude
extrap.glm.2011$Latitude <- df.pred$Latitude

colnames(extrap.glm.2011) <- c("fit", "se.fit", "residual.scale", "Presence Probability", "Upper", "Lower", "Predicted Range", "Longitude", "Latitude")
```

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
xxx.spat.plot.ap.glm.82 <- ggplot() +
  geom_tile(data = extrap.glm.1982, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +##322FBA   #189119
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  annotation_north_arrow(location = "tl", which_north = "true", 
                         pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering, height = unit(1, "cm"), width = unit(1, "cm")) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Astrebla pectinata Predicted Spatial Plot for 1982 Climatic Data (glm)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())

### Spatial Plot with 2011 Climatic Data
xxx.spat.plot.ap.glm.11 <- ggplot() +
  geom_tile(data = extrap.glm.2011, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  #scale_fill_binned(type = "viridis") +
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  #scale_fill_gradientn(limits = c(0, 0.8), colours = c("#440154FF", "#453781FF", "#33638DFF", "#238A8DFF", "#29AF7FFF", "#73D055FF", "#DCE319FF")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Astrebla pectinata Predicted Spatial Plot for 2011 Climatic Data (glm)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### Predicted Range Plots

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
rrr.spat.plot.ap.glm.82 <- ggplot() +
  geom_tile(data = extrap.glm.1982, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +##322FBA   #189119
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  annotation_north_arrow(location = "tl", which_north = "true", 
                         pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering, height = unit(1, "cm"), width = unit(1, "cm")) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Astrebla pectinata Predicted Spatial Plot for 1982 Climatic Data (glm)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())

### Spatial Plot with 2011 Climatic Data
rrr.spat.plot.ap.glm.11 <- ggplot() +
  geom_tile(data = extrap.glm.2011, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  #scale_fill_binned(type = "viridis") +
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  #scale_fill_gradientn(limits = c(0, 0.8), colours = c("#440154FF", "#453781FF", "#33638DFF", "#238A8DFF", "#29AF7FFF", "#73D055FF", "#DCE319FF")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Astrebla pectinata Predicted Spatial Plot for 2011 Climatic Data (glm)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### Base INLA Model

```{r}
### Spatial Random Effect

# Create Spatial Points
j2.spat.points <- SpatialPointsDataFrame(coords = j2.coords, data = j2, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Create Spatial dataframe
x <- data.frame(matrix(NA, nrow = nrow(j2.spat.points), ncol = 0))
x$Longitude <- j2.spat.points$c3c4.Longitude..Decimal.Degrees.
x$Latitude <- j2.spat.points$c3c4.Latitude..Decimal.Degrees.

# Calculate Clusters using Mean Shift Clustering
j2.mean.shift <- ms(x, h = 0.1, scaled = FALSE, iter = 200, plotms = -1)

# Observed Data 1982
df.obs.1982 <- j2 %>% dplyr::select(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees., clay, awc, carb, nitr, phos, rain, tmax, tdif, `Astrebla pectinata`)

df.obs.1982$ID <- j2.mean.shift$cluster.label

colnames(df.obs.1982) <- c("Longitude", "Latitude", "clay", "awc", "carb", "nitr", "phos", "rain", "tmax", "tdif", "Astrebla pectinata", "ID")

# Prediction Data 1982
df.pred.1982$`Astrebla pectinata` <- NA

### Spatial Random Effect

# Create Spatial Points
j2.spat.points <- SpatialPointsDataFrame(coords = df.pred.1982[,1:2], data = df.pred.1982, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Create Spatial dataframe
x <- data.frame(matrix(NA, nrow = nrow(j2.spat.points), ncol = 0))
x$Longitude <- j2.spat.points$Longitude
x$Latitude <- j2.spat.points$Latitude

# Calculate Clusters using Mean Shift Clustering
j2.pred.mean.shift <- ms(x, h = 0.1, scaled = FALSE, iter = 200, plotms = -1)

# Add Spatial Component to Prediction Data 1982
df.pred.1982$ID <- j2.pred.mean.shift$cluster.label

# Combined Data 1982
df.pred.inla.1982 <- rbind(df.obs.1982, df.pred.1982)

formula <- "`Astrebla pectinata`" ~ nitr + awc + phos + clay + rain + tmax + tdif + f(ID, model = "iid")

# Predict New Values using Base INLA 1982
extrap.base.inla.1982 <- inla(formula,
                  family = "binomial",
                  data = df.pred.inla.1982,
                  control.family = list(link = "logit"),
                  control.predictor = list(link = 1, compute = TRUE),
                  control.compute = list(dic = TRUE, cpo = TRUE, waic = TRUE),
                  verbose = FALSE)

# Predicted Values for Plotting 1982
df.extrap.base.inla.1982 <- as.data.frame(extrap.base.inla.1982$summary.fitted.values$mean[(nrow(j2) + 1):length(extrap.base.inla.1982$summary.fitted.values$mean)])

###
df.extrap.base.inla.1982$Upper <- extrap.base.inla.1982$summary.fitted.values$`0.975quant`[(nrow(j2) + 1):length(extrap.base.inla.1982$summary.fitted.values$`0.975quant`)]
df.extrap.base.inla.1982$Lower <- extrap.base.inla.1982$summary.fitted.values$`0.025quant`[(nrow(j2) + 1):length(extrap.base.inla.1982$summary.fitted.values$`0.025quant`)]
###

df.extrap.base.inla.1982$Longitude <- df.pred.1982$Longitude
df.extrap.base.inla.1982$Latitude <- df.pred.1982$Latitude

colnames(df.extrap.base.inla.1982) <- c("Presence Probability", "Upper", "Lower",  "Longitude", "Latitude")
df.extrap.base.inla.1982$`Predicted Range` <- df.extrap.base.inla.1982$Upper - df.extrap.base.inla.1982$Lower

# Observed Data 2011
df.obs.2011 <- j2 %>% dplyr::select(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees., clay, awc, carb, nitr, phos, rain, tmax, tdif, `Astrebla pectinata`)

df.obs.2011$ID <- j2.mean.shift$cluster.label

colnames(df.obs.2011) <- c("Longitude", "Latitude", "clay", "awc", "carb", "nitr", "phos", "rain", "tmax", "tdif", "Astrebla pectinata", "ID")

# Prediction Data 2011
df.pred.2011$`Astrebla pectinata` <- NA

### Spatial Random Effect

# Create Spatial Points
j2.spat.points <- SpatialPointsDataFrame(coords = df.pred.2011[,1:2], data = df.pred.2011, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Create Spatial dataframe
x <- data.frame(matrix(NA, nrow = nrow(j2.spat.points), ncol = 0))
x$Longitude <- j2.spat.points$Longitude
x$Latitude <- j2.spat.points$Latitude

# Calculate Clusters using Mean Shift Clustering
j2.pred.mean.shift <- ms(x, h = 0.1, scaled = FALSE, iter = 200, plotms = -1)

# Add Spatial Component to Prediction Data 1982
df.pred.2011$ID <- j2.pred.mean.shift$cluster.label

# Combined Data 2011
df.pred.inla.2011 <- rbind(df.obs.2011, df.pred.2011)

formula <- "`Astrebla pectinata`" ~ nitr + awc + phos + clay + rain + tmax + tdif + f(ID, model = "iid")

# Predict New Values using Base INLA 2011
extrap.base.inla.2011 <- inla(formula,
                  family = "binomial",
                  data = df.pred.inla.2011,
                  control.family = list(link = "logit"),
                  control.predictor = list(link = 1, compute = TRUE),
                  control.compute = list(dic = TRUE, cpo = TRUE, waic = TRUE),
                  verbose = FALSE)

# Predicted Values for Plotting 2011
df.extrap.base.inla.2011 <- as.data.frame(extrap.base.inla.2011$summary.fitted.values$mean[1616:length(extrap.base.inla.2011$summary.fitted.values$mean)])

###
df.extrap.base.inla.2011$Upper <- extrap.base.inla.2011$summary.fitted.values$`0.975quant`[(nrow(j2) + 1):length(extrap.base.inla.2011$summary.fitted.values$`0.975quant`)]
df.extrap.base.inla.2011$Lower <- extrap.base.inla.2011$summary.fitted.values$`0.025quant`[(nrow(j2) + 1):length(extrap.base.inla.2011$summary.fitted.values$`0.025quant`)]
###

df.extrap.base.inla.2011$Longitude <- df.pred.2011$Longitude
df.extrap.base.inla.2011$Latitude <- df.pred.2011$Latitude

colnames(df.extrap.base.inla.2011) <- c("Presence Probability", "Upper", "Lower",  "Longitude", "Latitude")
df.extrap.base.inla.2011$`Predicted Range` <- df.extrap.base.inla.2011$Upper - df.extrap.base.inla.2011$Lower
```

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
xxx.spat.plot.ap.inla.82 <- ggplot() +
  geom_tile(data = df.extrap.base.inla.1982, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Astrebla pectinata Predicted Spatial Plot for 1982 Climatic Data (Base INLA)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())

### Spatial Plot with 2011 Climatic Data
xxx.spat.plot.ap.inla.11 <- ggplot() +
  geom_tile(data = df.extrap.base.inla.2011, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Astrebla pectinata Predicted Spatial Plot for 2011 Climatic Data (Base INLA)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### Predicted Range Plots

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
rrr.spat.plot.ap.inla.82 <- ggplot() +
  geom_tile(data = df.extrap.base.inla.1982, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Astrebla pectinata Predicted Spatial Plot for 1982 Climatic Data (Base INLA)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())

### Spatial Plot with 2011 Climatic Data
rrr.spat.plot.ap.inla.11 <- ggplot() +
  geom_tile(data = df.extrap.base.inla.2011, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Astrebla pectinata Predicted Spatial Plot for 2011 Climatic Data (Base INLA)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### INLA-SPDE Model

```{r}
# Create Observed Data Mesh
j2.coord <- cbind(j2$c3c4.Longitude..Decimal.Degrees., j2$c3c4.Latitude..Decimal.Degrees.)
mesh <- inla.mesh.2d(loc = j2.coord, max.edge = c(5, 10), offset = c(3, 7))
spde <- inla.spde2.matern(mesh = mesh, alpha = 2, constr = TRUE)
indexs <- inla.spde.make.index("s", spde$n.spde)
A <- inla.spde.make.A(mesh = mesh, loc = j2.coord) # Create Projection Matrix A

# Create Predicted Data Mesh 
j2.coord.pred <- cbind(extrap_df$Longitude, extrap_df$Latitude)
mesh.pred <- inla.mesh.2d(loc = j2.coord.pred, max.edge = c(5, 10), offset = c(3, 7))
spde.p <- inla.spde2.matern(mesh = mesh.pred, alpha = 2, constr = TRUE)
indexsp <- inla.spde.make.index("sp", spde.p$n.spde)
A.pred <- inla.spde.make.A(mesh = mesh.pred, loc = j2.coord.pred) # Create Predicted Projection Matrix A


# Create Observed Stack
stk.obs <- inla.stack(tag = "obs", data = list(y = j2$`Astrebla pectinata`), 
                    A = list(1, A), effects = list(data.frame(b0 = 1, nitr = j2$nitr,
                    awc = j2$awc, phos = j2$phos, clay = j2$clay,
                    rain = j2$rain, tmax = j2$tmax, tdif = j2$tdif), s = indexs))

# Create Prediction Stack
stk.pred <- inla.stack(tag = "pred", data = list(y = NA), A = list(1, A.pred), 
                       effects = list(data.frame(b0 = 1, nitr = extrap_df$nitr,
                       awc = extrap_df$awc, phos = extrap_df$phos, 
                       clay = extrap_df$clay, rain = extrap_df$rain1982, 
                       tmax = extrap_df$tmax1982, tdif = extrap_df$tdif1982), sp = indexsp))

# Combine Stacks
stk.full <- inla.stack(stk.obs, stk.pred)

formula <- y ~ 0 + b0 + nitr + awc + phos + clay + rain + tmax + tdif + f(sp, model = spde)

extrap.inla.spde.1982 <- inla(formula, family = "binomial", 
            control.family = list(link = "logit"),
            data = inla.stack.data(stk.full),
            control.predictor = list(compute = TRUE, link = 1, A = inla.stack.A(stk.full)))

###

index <- inla.stack.index(stack = stk.full, tag = "pred")$data
pres_mean <- extrap.inla.spde.1982$summary.fitted.values[index, "mean"]

###
Upper <- extrap.inla.spde.1982$summary.fitted.values[index, "0.975quant"]
Lower <- extrap.inla.spde.1982$summary.fitted.values[index, "0.025quant"]
###

# Predicted Values for Plotting 1982
df.extrap.inla.spde.1982 <- as.data.frame(pres_mean)

df.extrap.inla.spde.1982$Upper <- Upper
df.extrap.inla.spde.1982$Lower <- Lower

df.extrap.inla.spde.1982$Longitude <- extrap_df$Longitude
df.extrap.inla.spde.1982$Latitude <- extrap_df$Latitude

colnames(df.extrap.inla.spde.1982) <- c("Presence Probability", "Upper", "Lower", "Longitude", "Latitude")
df.extrap.inla.spde.1982$`Predicted Range` <- df.extrap.inla.spde.1982$Upper - df.extrap.inla.spde.1982$Lower
```

```{r}
# Create Observed Data Mesh
j2.coord <- cbind(j2$c3c4.Longitude..Decimal.Degrees., j2$c3c4.Latitude..Decimal.Degrees.)
mesh <- inla.mesh.2d(loc = j2.coord, max.edge = c(5, 10), offset = c(3, 7))
spde <- inla.spde2.matern(mesh = mesh, alpha = 2, constr = TRUE)
indexs <- inla.spde.make.index("s", spde$n.spde)
A <- inla.spde.make.A(mesh = mesh, loc = j2.coord) # Create Projection Matrix A

# Create Predicted Data Mesh 
j2.coord.pred <- cbind(extrap_df$Longitude, extrap_df$Latitude)
mesh.pred <- inla.mesh.2d(loc = j2.coord.pred, max.edge = c(5, 10), offset = c(3, 7))
spde.p <- inla.spde2.matern(mesh = mesh.pred, alpha = 2, constr = TRUE)
indexsp <- inla.spde.make.index("sp", spde.p$n.spde)
A.pred <- inla.spde.make.A(mesh = mesh.pred, loc = j2.coord.pred) # Create Predicted Projection Matrix A


# Create Observed Stack
stk.obs <- inla.stack(tag = "obs", data = list(y = j2$`Astrebla pectinata`), 
                    A = list(1, A), effects = list(data.frame(b0 = 1, nitr = j2$nitr,
                    awc = j2$awc, phos = j2$phos, clay = j2$clay,
                    rain = j2$rain, tmax = j2$tmax, tdif = j2$tdif), s = indexs))

# Create Prediction Stack
stk.pred <- inla.stack(tag = "pred", data = list(y = NA), A = list(1, A.pred), 
                       effects = list(data.frame(b0 = 1, nitr = extrap_df$nitr,
                       awc = extrap_df$awc, phos = extrap_df$phos, 
                       clay = extrap_df$clay, rain = extrap_df$rain2011, 
                       tmax = extrap_df$tmax2011, tdif = extrap_df$tdif2011), sp = indexsp))

# Combine Stacks
stk.full <- inla.stack(stk.obs, stk.pred)

formula <- y ~ 0 + b0 + nitr + awc + phos + clay + rain + tmax + tdif + f(sp, model = spde)

extrap.inla.spde.2011 <- inla(formula, family = "binomial", 
            control.family = list(link = "logit"),
            data = inla.stack.data(stk.full),
            control.predictor = list(compute = TRUE, link = 1, A = inla.stack.A(stk.full)))

###

index <- inla.stack.index(stack = stk.full, tag = "pred")$data
pres_mean <- extrap.inla.spde.2011$summary.fitted.values[index, "mean"]

###
Upper <- extrap.inla.spde.2011$summary.fitted.values[index, "0.975quant"]
Lower <- extrap.inla.spde.2011$summary.fitted.values[index, "0.025quant"]
###

# Predicted Values for Plotting 2011
df.extrap.inla.spde.2011 <- as.data.frame(pres_mean)

df.extrap.inla.spde.2011$Upper <- Upper
df.extrap.inla.spde.2011$Lower <- Lower

df.extrap.inla.spde.2011$Longitude <- extrap_df$Longitude
df.extrap.inla.spde.2011$Latitude <- extrap_df$Latitude

colnames(df.extrap.inla.spde.2011) <- c("Presence Probability", "Upper", "Lower", "Longitude", "Latitude")
df.extrap.inla.spde.2011$`Predicted Range` <- df.extrap.inla.spde.2011$Upper - df.extrap.inla.spde.2011$Lower
```

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
xxx.spat.plot.ap.inla.spde.82 <- ggplot() +
  geom_tile(data = df.extrap.inla.spde.1982, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Astrebla pectinata Predicted Spatial Plot for 1982 Climatic Data (INLA-SPDE)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

```{r}
### Spatial Plot with 2011 Climatic Data
xxx.spat.plot.ap.inla.spde.11 <- ggplot() +
  geom_tile(data = df.extrap.inla.spde.2011, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Astrebla pectinata Predicted Spatial Plot for 2011 Climatic Data (INLA-SPDE)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### Predicted Range Plots

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
rrr.spat.plot.ap.inla.spde.82 <- ggplot() +
  geom_tile(data = df.extrap.inla.spde.1982, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Astrebla pectinata Predicted Spatial Plot for 1982 Climatic Data (INLA-SPDE)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

```{r}
### Spatial Plot with 2011 Climatic Data
rrr.spat.plot.ap.inla.spde.11 <- ggplot() +
  geom_tile(data = df.extrap.inla.spde.2011, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Astrebla pectinata Predicted Spatial Plot for 2011 Climatic Data (INLA-SPDE)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### Spatial Difference Plots

```{r eval=FALSE, include=FALSE}
df.diff.glm.inla.spde.82 <- as.data.frame(extrap.glm.1982$`Presence Probability`)
df.diff.glm.inla.spde.82$inla.spde.1982 <- df.extrap.inla.spde.1982$`Presence Probability`

colnames(df.diff.glm.inla.spde.82) <- c("glm.1982.pres", "inla.spde.1982.pres")

df.diff.glm.inla.spde.82$Longitude <- extrap_df$Longitude
df.diff.glm.inla.spde.82$Latitude <- extrap_df$Latitude

df.diff.glm.inla.spde.82$difference <- df.diff.glm.inla.spde.82$inla.spde.1982.pres - df.diff.glm.inla.spde.82$glm.1982.pres
```

```{r eval=FALSE, include=FALSE}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Difference Plots Colours
diff.col.pal <- c("red", "orange", "white", "white", "lightgreen", "green", "darkgreen", "#003300")

### Spatial Difference Plot with 1982 Climatic Data
www.diff.plot.ap.82 <- ggplot() +
  geom_tile(data = df.diff.glm.inla.spde.82, aes(x = Longitude, y = Latitude, fill = difference), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#90242b", mid = "#FFFFFF", high = "#142833", midpoint = 0) +
  scale_fill_gradientn(limits = c(-0.15, 0.15), colours = c("#800000", "#FFFFFF", "#000080"), guide = guide_legend(direction = "horizontal", title.position = "left", title.theme = element_text(angle = 90), label.position="bottom", label.hjust = 0.5, label.vjust = 0.5, label.theme = element_text(angle = 90))) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  annotation_scale(location = "bl", width_hint = 0.5) +
  annotation_north_arrow(location = "tl", which_north = "true", 
                         pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering, height = unit(1, "cm"), width = unit(1, "cm")) + 
  #labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Astrebla pectinata Spatial Difference Plot for\n1982 Climatic Data (glm vs INLA-SPDE)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

```{r eval=FALSE, include=FALSE}
ggplot() +
  geom_histogram(data = df.diff.glm.inla.spde, aes(x = difference), binwidth = 0.025) +
  geom_vline(xintercept = median(df.diff.glm.inla.spde$difference, na.rm = TRUE)) +
  geom_label(label = paste0("Median = ", round(median(df.diff.glm.inla.spde$difference, na.rm = TRUE), 4)), aes(x = 0.2, y = 400))
```

```{r eval=FALSE, include=FALSE}
df.diff.glm.inla.spde.11 <- as.data.frame(extrap.glm.2011$`Presence Probability`)
df.diff.glm.inla.spde.11$inla.spde.2011 <- df.extrap.inla.spde.2011$`Presence Probability`

colnames(df.diff.glm.inla.spde.11) <- c("glm.2011.pres", "inla.spde.2011.pres")

df.diff.glm.inla.spde.11$Longitude <- extrap_df$Longitude
df.diff.glm.inla.spde.11$Latitude <- extrap_df$Latitude

df.diff.glm.inla.spde.11$difference <- df.diff.glm.inla.spde.11$inla.spde.2011.pres - df.diff.glm.inla.spde.11$glm.2011.pres
```

```{r eval=FALSE, include=FALSE}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Difference Plots Colours
diff.col.pal <- c("white", "white", "lightgreen", "green", "darkgreen", "#003300", "#002200", "#001100")

### Spatial Difference Plot with 1982 Climatic Data
www.diff.plot.ap.11 <- ggplot() +
  geom_tile(data = df.diff.glm.inla.spde.11, aes(x = Longitude, y = Latitude, fill = difference), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#90242b", mid = "#FFFFFF", high = "#142833", midpoint = 0) +
  scale_fill_gradientn(limits = c(-0.15, 0.15), colours = c("#800000", "#FFFFFF", "#000080")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  #labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Astrebla pectinata Spatial Difference Plot for\n2011 Climatic Data (glm vs INLA-SPDE)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

```{r eval=FALSE, include=FALSE}
ggplot() +
  geom_histogram(data = df.diff.glm.inla.spde, aes(x = difference), binwidth = 0.025) +
  geom_vline(xintercept = median(df.diff.glm.inla.spde$difference, na.rm = TRUE)) +
  geom_label(label = paste0("Median = ", round(median(df.diff.glm.inla.spde$difference, na.rm = TRUE), 4)), aes(x = 0.2, y = 400))
```

### Predicted Spatial Range

```{r}
# Extract the calculated range parameter 'phi' from the observed INLA SPDE Model
r.f.ap <- inla.spde2.result(inla.spde.results.ap, "s", spde, do.transf = TRUE)
par(mfrow = c(2, 2))
plot(inla.spde.results.ap$marginals.fixed[[1]], type = "l", xlab = "Intercept", ylab = "Density")
plot(inla.spde.results.ap$marginals.hyperpar[[1]], type = "l", ylab = "Density", xlab = expression(phi))
plot.default(r.f.ap$marginals.variance.nominal[[1]], type = "l", xlab = expression(sigma[x]^2), ylab = "Density")
plot.default(r.f.ap$marginals.range.nominal[[1]], type = "l", xlab = "Practical range", ylab = "Density")
#
temp.df.ap <- as.data.frame(r.f.ap$marginals.range.nominal)
abline(v = max(temp.df.ap$range.nominal.1.x[which.max(temp.df.ap$range.nominal.1.y)]), col = "red", lty = 2)
paste0("Practical Range (Maximum Likelihood): ", round(max(temp.df.ap$range.nominal.1.x[which.max(temp.df.ap$range.nominal.1.y)]), 2), " Arc Degrees")
```

# Bothriochloa ewartiana

### Load and Manage Dataset

```{r}
# Load Dataset
load("j2_clay515.Rdata")
j2 <- j2_clay515
remove(j2_clay515)

# Subset Dataset for `Bothriochloa ewartiana`
j2 <- dplyr::select(j2, nitrogen515, awc515, phosphorus515, carbon515, clay515, rain18, tmin18, tmax18, tdiff18, c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees., `Bothriochloa ewartiana`)

# Manage Dataset
# Convert Longitude and Latitude Variables to double type
j2$c3c4.Longitude..Decimal.Degrees. <- as.double(j2$c3c4.Longitude..Decimal.Degrees.)
j2$c3c4.Latitude..Decimal.Degrees. <- as.double(j2$c3c4.Latitude..Decimal.Degrees.)
```

### Rename j2 Variables

```{r}
colnames(j2) <- c("nitr", "awc", "phos", "carb", "clay", "rain", "tmin", "tmax", "tdif", "c3c4.Longitude..Decimal.Degrees.", "c3c4.Latitude..Decimal.Degrees.", "Bothriochloa ewartiana")
```

### Data Cleaning and Preparation

```{r}
# Remove Observations with 'NA' values
j2 <- j2[complete.cases(j2),]
#
# Removal of Anomolous Data points
j2 <- subset(j2, j2$nitr != 0)
#
# Removal of Outliers using the IQR Criterion
#
# Remove Outliers - 'nitr' covariate
ol.quantile.nitr <- quantile(j2$nitr, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.nitr <- IQR(j2$nitr, na.rm = TRUE)
ol.upper.nitr <- ol.quantile.nitr[2] + 1.5*ol.iqr.nitr
ol.lower.nitr <- ol.quantile.nitr[1] - 1.5*ol.iqr.nitr
#
# Remove Outliers - 'awc' covariate
ol.quantile.awc <- quantile(j2$awc, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.awc <- IQR(j2$awc, na.rm = TRUE)
ol.upper.awc <- ol.quantile.awc[2] + 1.5*ol.iqr.awc
ol.lower.awc <- ol.quantile.awc[1] - 1.5*ol.iqr.awc
#
# Remove Outliers - 'phos' covariate
ol.quantile.phos <- quantile(j2$phos, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.phos <- IQR(j2$phos, na.rm = TRUE)
ol.upper.phos <- ol.quantile.phos[2] + 1.5*ol.iqr.phos
ol.lower.phos <- ol.quantile.phos[1] - 1.5*ol.iqr.phos
#
# Remove Outliers - 'carb' covariate
ol.quantile.carb <- quantile(j2$carb, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.carb <- IQR(j2$carb, na.rm = TRUE)
ol.upper.carb <- ol.quantile.carb[2] + 1.5*ol.iqr.carb
ol.lower.carb <- ol.quantile.carb[1] - 1.5*ol.iqr.carb
#
# Remove Outliers - 'clay' covariate
ol.quantile.clay <- quantile(j2$clay, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.clay <- IQR(j2$clay, na.rm = TRUE)
ol.upper.clay <- ol.quantile.clay[2] + 1.5*ol.iqr.clay
ol.lower.clay <- ol.quantile.clay[1] - 1.5*ol.iqr.clay
#
# Remove Outliers - 'rain' covariate
ol.quantile.rain <- quantile(j2$rain, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.rain <- IQR(j2$rain, na.rm = TRUE)
ol.upper.rain <- ol.quantile.rain[2] + 1.5*ol.iqr.rain
ol.lower.rain <- ol.quantile.rain[1] - 1.5*ol.iqr.rain
#
# Remove Outliers - 'tmin' covariate
ol.quantile.tmin <- quantile(j2$tmin, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.tmin <- IQR(j2$tmin, na.rm = TRUE)
ol.upper.tmin <- ol.quantile.tmin[2] + 1.5*ol.iqr.tmin
ol.lower.tmin <- ol.quantile.tmin[1] - 1.5*ol.iqr.tmin
#
# Remove Outliers - 'tmin' covariate
ol.quantile.tmin <- quantile(j2$tmin, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.tmin <- IQR(j2$tmin, na.rm = TRUE)
ol.upper.tmin <- ol.quantile.tmin[2] + 1.5*ol.iqr.tmin
ol.lower.tmin <- ol.quantile.tmin[1] - 1.5*ol.iqr.tmin
#
# Remove Outliers - 'tdif' covariate
ol.quantile.tdif <- quantile(j2$tdif, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.tdif <- IQR(j2$tdif, na.rm = TRUE)
ol.upper.tdif <- ol.quantile.tdif[2] + 1.5*ol.iqr.tdif
ol.lower.tdif <- ol.quantile.tdif[1] - 1.5*ol.iqr.tdif
#
# Subsetting
j2 <- subset(j2, nitr > ol.lower.nitr & nitr < ol.upper.nitr)
j2 <- subset(j2, awc > ol.lower.awc & awc < ol.upper.awc)
j2 <- subset(j2, phos > ol.lower.phos & phos < ol.upper.phos)
j2 <- subset(j2, carb > ol.lower.carb & carb < ol.upper.carb)
j2 <- subset(j2, clay > ol.lower.clay & clay < ol.upper.clay)
j2 <- subset(j2, rain > ol.lower.rain & rain < ol.upper.rain)
j2 <- subset(j2, tmin > ol.lower.tmin & tmin < ol.upper.tmin)
j2 <- subset(j2, tmin > ol.lower.tmin & tmin < ol.upper.tmin)
j2 <- subset(j2, tdif > ol.lower.tdif & tdif < ol.upper.tdif)
#
```

### Spatial Map of Observed Data

```{r eval=FALSE, include=FALSE}
# Mapping Objects
world_shp <- sf::st_as_sf(maps::map("world", plot = FALSE, fill = TRUE))
aus_shp<- world_shp[world_shp$ID == "Australia",]

# Mapping Colours
map.colours <- c("Absence" = "gray", "Presence" = "steelblue", "Removed" = "pink")

# Bothriochloa ewartiana Spatial Plot - All Available Data
plot.study.area <- ggplot() +
#ggplot() +
  geom_sf(data = aus_shp, fill = "white") +
  coord_sf(xlim = c(110.00, 157.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  annotation_scale(location = "bl", width_hint = 0.5) +
  annotation_north_arrow(location = "tl", which_north = "true",
                         pad_x = unit(0.15, "in"), pad_y = unit(0.1, "in"),
                         style = north_arrow_fancy_orienteering) +
  #geom_point(data = subset(j2, `Bothriochloa ewartiana`==0),
  #           aes(x = c3c4.Longitude..Decimal.Degrees.,
  #               y = c3c4.Latitude..Decimal.Degrees., colour = "Absence")) +
  #geom_point(data = subset(j2, `Bothriochloa ewartiana`==1),
  #           aes(x = c3c4.Longitude..Decimal.Degrees.,
  #               y = c3c4.Latitude..Decimal.Degrees., colour = "Presence")) +
  geom_point(data = j2, aes(x = c3c4.Longitude..Decimal.Degrees.,
                 y = c3c4.Latitude..Decimal.Degrees.), colour = "black") +
  #labs(x = "Longitude", y = "Latitude", color = "Legend") +
  labs(x = "Longitude (\u00B0)", y = "Latitude (\u00B0)") +
  scale_color_manual(values = map.colours) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.margin = unit(c(0,0,0,2), "mm")) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  theme_minimal()
  #theme(legend.title = element_blank()) +
  #theme(legend.position = "none")
ggsave("Study Area.png", device = "png")
```

### Descriptive Statistics

```{r eval=FALSE, include=FALSE}
response.table <- table(j2$`Bothriochloa ewartiana`)
response.table <- data.frame(response.table)
response.table[,1] <- c("Absence", "Presence")
response.table[,3] <- c(paste(round((response.table[1,2]/sum(response.table[,2]))*100,2),"%"), paste(round((response.table[2,2]/sum(response.table[,2]))*100,2),"%"))
response.table[3,] <- c("Total", sum(response.table[,2]), "100.00%")
knitr::kable(response.table, col.names = c(" ", "Count", "Proportion"), caption = "Summary of Absence/Presence Response in Bothriochloa ewartiana") %>% kable_styling(full_width = FALSE) %>%
  save_kable("astrebla-covariate-table.png")
response.table
```

```{r eval=FALSE, include=FALSE}
#descriptive.data.frame <- j2 %>% dplyr::select(nitr, awc, phos, carb, clay, rain, tmin, tmax, tdif, `Bothriochloa ewartiana`)
descriptive.data.frame <- j2 %>% dplyr::select(nitr, awc, phos, carb, clay, rain, tmin, tmax, tdif)

plotnitr <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = nitr)) +
  theme_minimal() + 
  theme(axis.text.y = element_blank()) +
  scale_x_continuous(breaks = c(min(j2$nitr), 0.04, 0.08, 0.12, max(j2$nitr)), labels = scales::number_format(accuracy = 0.01))

plotawc <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = awc)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plotphos <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = phos)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank()) +
  scale_x_continuous(breaks = c(0.01, 0.02, 0.03, 0.04, 0.05, max(j2$phos)), labels = scales::number_format(accuracy = 0.01))

plotcarb <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = carb)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plotclay <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = clay)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plotrain <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = rain)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plottmin <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = tmin)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plottmax <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = tmax)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plottdif <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = tdif)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

grid.arrange(plotnitr, plotawc, plotphos, plotcarb, plotclay, plotrain, plottmin, plottmax, plottdif, ncol = 3)
```

```{r eval=FALSE, include=FALSE}
### Descriptive statistics Table for Paper
# 
# awc
paste("awc min:", round(min(j2$awc),4))
paste("awc mean:", round(mean(j2$awc),4))
paste("awc max:", round(max(j2$awc),4))
#
paste("")
# clay
paste("clay min:", round(min(j2$clay),4))
paste("clay mean:", round(mean(j2$clay),4))
paste("clay max:", round(max(j2$clay),4))
#
paste("")
# nitr
paste("nitr min:", round(min(j2$nitr),4))
paste("nitr mean:", round(mean(j2$nitr),4))
paste("nitr max:", round(max(j2$nitr),4))
#
paste("")
# phos
paste("phos min:", round(min(j2$phos),4))
paste("phos mean:", round(mean(j2$phos),4))
paste("phos max:", round(max(j2$phos),4))
#
paste("")
# rain
paste("rain min:", round(min(j2$rain),4))
paste("rain mean:", round(mean(j2$rain),4))
paste("rain max:", round(max(j2$rain),4))
#
paste("")
# tdif
paste("tdif min:", round(min(j2$tdif),4))
paste("tdif mean:", round(mean(j2$tdif),4))
paste("tdif max:", round(max(j2$tdif),4))
# 
paste("")
# tmax
paste("tmax min:", round(min(j2$tmax),4))
paste("tmax mean:", round(mean(j2$tmax),4))
paste("tmax max:", round(max(j2$tmax),4))
```

### Multicollinearity

```{r eval=FALSE, include=FALSE}
j2.corr <- cor(descriptive.data.frame)
corrplot(j2.corr, method = 'number')
```

Selected Model Covariates for Bothriochloa ewartiana following review of Multicollinearity:

* nitr
* awc
* phos
* clay
* rain
* tmax
* tdif

### Covariate Standardisation

```{r}
# Load Functions
source("cent.R")
source("reversecent.R")
#
# Create Standardised j2 Data Frame
j2.cent <- data.frame(matrix(NA, nrow = nrow(j2), ncol = 0))
j2.cent$nitr <- cent(j2$nitr)
j2.cent$awc <- cent(j2$awc)
j2.cent$phos <- cent(j2$phos)
j2.cent$carb <- cent(j2$carb)
j2.cent$clay <- cent(j2$clay)
j2.cent$rain <- cent(j2$rain)
j2.cent$tmin <- cent(j2$tmin)
j2.cent$tmax <- cent(j2$tmax)
j2.cent$tdif <- cent(j2$tdif)
j2.cent$c3c4.Longitude..Decimal.Degrees. <- j2$c3c4.Longitude..Decimal.Degrees.
j2.cent$c3c4.Latitude..Decimal.Degrees. <- j2$c3c4.Latitude..Decimal.Degrees.
j2.cent$`Bothriochloa ewartiana` <- j2$`Bothriochloa ewartiana`
#
```

## Model Fitting

### glm Model

```{r}
formula <- `Bothriochloa ewartiana` ~ nitr + awc + phos + clay + rain + tmax + tdif

glm.results.be <- glm(formula, data = j2.cent, family = "binomial")
summary(glm.results.be)
```

### Plot glm Results using Leaflet

```{r}
pal <- colorNumeric("viridis", c(0, 1), na.color = "transparent")
```

```{r eval=FALSE, include=FALSE}
leaflet() %>% addTiles() %>%
  addCircles(lng = j2$c3c4.Longitude..Decimal.Degrees., lat = j2$c3c4.Latitude..Decimal.Degrees., color = pal(glm.results.be$fitted.values)) %>%
  addLegend("bottomright", pal = pal, values = glm.results.be$fitted.values, title = "Mean Presence Prob") %>%
  addScaleBar(position = c("bottomleft"))
```

### Base INLA Model

```{r}
# Base INLA - Linear Fixed Effects with Spatial Random Effect Included

### Prepare Prediction Data Frame
j2.pred.temp <- j2.cent
j2.pred.temp$`Bothriochloa ewartiana` <- NA
j2.pred <- rbind(j2.cent, j2.pred.temp)

### Spatial Random Effect
# Create Spatial Points
j2.coords <- subset(j2, select = c(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees.))
j2.spat.points <- SpatialPointsDataFrame(coords = j2.coords, data = j2, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Create Spatial dataframe
x <- data.frame(matrix(NA, nrow = nrow(j2.spat.points), ncol = 0))
x$Longitude <- j2.spat.points$c3c4.Longitude..Decimal.Degrees.
x$Latitude <- j2.spat.points$c3c4.Latitude..Decimal.Degrees.

# Calculate Clusters using Mean Shift Clustering
j2.mean.shift <- ms(x, h = 0.1, scaled = FALSE, iter = 200, plotms = -1)

j2.pred$ID <- cent(j2.mean.shift$cluster.label)

### Formula
formula <- "`Bothriochloa ewartiana`" ~ nitr + awc + phos + clay + rain + tmax + tdif + f(ID, model = "iid")

### Fit Model
base.inla.results.be <- inla(formula,
                  family = "binomial",
                  data = j2.pred,
                  control.family = list(link = "logit"),
                  control.predictor = list(link = 1, compute = TRUE),
                  control.compute = list(dic = TRUE, cpo = TRUE, waic = TRUE),
                  verbose = FALSE) # TRUE if full output is required
summary(base.inla.results.be)
```

### Plot Base INLA Results using Leaflet

```{r eval=FALSE, include=FALSE}
leaflet() %>% addTiles() %>%
  addCircles(lng = j2$c3c4.Longitude..Decimal.Degrees., lat = j2$c3c4.Latitude..Decimal.Degrees., color = pal(base.inla.results.be$summary.fitted.values$mean)) %>%
  addLegend("bottomright", pal = pal, values = base.inla.results.be$summary.fitted.values$mean, title = "Mean Presence Prob") %>%
  addScaleBar(position = c("bottomleft"))
```

### INLA-SPDE Model

```{r}
# Create Observed Data Mesh
j2.coord <- cbind(j2$c3c4.Longitude..Decimal.Degrees., j2$c3c4.Latitude..Decimal.Degrees.)
mesh <- inla.mesh.2d(loc = j2.coord, max.edge = c(5, 10), offset = c(3, 7))
spde <- inla.spde2.matern(mesh = mesh, alpha = 2, constr = TRUE)
indexs <- inla.spde.make.index("s", spde$n.spde)
A <- inla.spde.make.A(mesh = mesh, loc = j2.coord) # Create Projection Matrix A

# Create Predicted Data Mesh 
j2.coord.pred <- cbind(j2$c3c4.Longitude..Decimal.Degrees., j2$c3c4.Latitude..Decimal.Degrees.)
mesh.pred <- inla.mesh.2d(loc = j2.coord.pred, max.edge = c(5, 10), offset = c(3, 7))
A.pred <- inla.spde.make.A(mesh = mesh.pred, loc = j2.coord.pred) # Create Predicted Projection Matrix A

# Create Observed Stack
stk.obs <- inla.stack(tag = "obs", data = list(y = j2.cent$`Bothriochloa ewartiana`), 
                    A = list(1, A), effects = list(data.frame(b0 = 1, nitr = j2.cent$nitr,
                    awc = j2.cent$awc, phos = j2.cent$phos, clay = j2.cent$clay,
                    rain = j2.cent$rain, tmax = j2.cent$tmax, tdif = j2.cent$tdif), s = indexs))

stk.pred <- inla.stack(tag = "pred", data = list(y = NA), A = list(1, A.pred), 
                       effects = list(data.frame(b0 = 1, nitr = j2.cent$nitr,
                       awc = j2.cent$awc, phos = j2.cent$phos, 
                       clay = j2.cent$clay, rain = j2.cent$rain, 
                       tmin = j2.cent$tmax, tdif12 = j2.cent$tdif), s = indexs))
#
# Combine Stacks
stk.full <- inla.stack(stk.obs, stk.pred)

formula <- y ~ 0 + b0 + nitr + awc + phos + clay + rain + tmax + tdif + f(s, model = spde)
#
```

### Display Mesh

```{r eval=FALSE, include=FALSE}
plot(mesh)
points(x = j2.coord[,1], y = j2.coord[,2], col = "red", pch = 19, cex = 0.5)
```

### Run INLA-SPDE Model

```{r}
inla.spde.results.be <- inla(formula, family = "binomial", 
            control.family = list(link = "logit"),
            data = inla.stack.data(stk.full),
            control.predictor = list(compute = TRUE, link = 1, A = inla.stack.A(stk.full)))
```

### INLA-SPDE Model Results

```{r}
summary(inla.spde.results.be)

index <- inla.stack.index(stack = stk.full, tag = "pred")$data

pres_mean <- inla.spde.results.be$summary.fitted.values[index, "mean"]
pres_ll <- inla.spde.results.be$summary.fitted.values[index, "0.025quant"]
pres_ul <- inla.spde.results.be$summary.fitted.values[index, "0.975quant"]

pal <- colorNumeric("viridis", c(0, 1), na.color = "transparent")
```

### Bothriochloa ewartiana Mean Predicted Species Presence using Leaflet

```{r eval=FALSE, include=FALSE}
leaflet() %>% addTiles() %>%
  addCircles(lng = j2.coord.pred[,1], lat = j2.coord.pred[, 2], color = pal(pres_mean)) %>%
  addLegend("bottomright", pal = pal, values = pres_mean, title = "Mean Presence Prob") %>%
  addScaleBar(position = c("bottomleft"))
```

### INLA-SPDE Model Validity (AUC and ROC)

```{r}
# glm ROC
glm.predictions.be <- glm.results.be$fitted.values
glm.roc.data.be <- roc(response = j2$`Bothriochloa ewartiana`, predictor = glm.predictions.be, auc = TRUE)
glm.roc.data.spec.be <- as.data.frame(glm.roc.data.be$specificities)
glm.roc.data.sens.be <- as.data.frame(glm.roc.data.be$sensitivities)
glm.roc.data.final.be <- cbind(glm.roc.data.spec.be, glm.roc.data.sens.be)

# Base INLA ROC
base.inla.predictions.be <- base.inla.results.be$summary.fitted.values$mean[(nrow(j2.cent)+1):length(base.inla.results.be$summary.fitted.values$mean)]
base.inla.roc.data.be <- roc(response = j2$`Bothriochloa ewartiana`, predictor = base.inla.predictions.be, auc = TRUE)
base.inla.roc.data.spec.be <- as.data.frame(base.inla.roc.data.be$specificities)
base.inla.roc.data.sens.be <- as.data.frame(base.inla.roc.data.be$sensitivities)
base.inla.roc.data.final.be <- cbind(base.inla.roc.data.spec.be, base.inla.roc.data.sens.be)

# INLA-SPDE ROC
predictions.be <- inla.spde.results.be$summary.fitted.values$mean[1:length(j2.cent$nitr)]
roc.data.be <- roc(response = j2$`Bothriochloa ewartiana`, predictor = predictions.be, auc = TRUE)
roc.data.spec.be <- as.data.frame(roc.data.be$specificities)
roc.data.sens.be <- as.data.frame(roc.data.be$sensitivities)
roc.data.final.be <- cbind(roc.data.spec.be, roc.data.sens.be)

zzz.plot.be.roc <- ggplot() +
  geom_segment(aes(x = 1, y = 0, xend = 0, yend = 1), color = "gray") +
  geom_line(data = glm.roc.data.final.be, aes(x = `glm.roc.data.be$specificities`, y = `glm.roc.data.be$sensitivities`), color = "red", lwd = 0.75) +
  geom_line(data = base.inla.roc.data.final.be, aes(x = `base.inla.roc.data.be$specificities`, y = `base.inla.roc.data.be$sensitivities`), color = "blue", lwd = 0.75) +
  geom_line(data = roc.data.final.be, aes(x = `roc.data.be$specificities`, y = `roc.data.be$sensitivities`), lwd = 0.75) +
  scale_x_reverse() + 
  theme_minimal() +
  #xlab("Specificity") +
  #ylab("Sensitivity") +
  #ggtitle("Bothriochloa ewartiana Model - ROC Curves") +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank()) +
  geom_label(aes(x = 0.25, y = 0.375, label = paste("INLA-SPDE AUC:", round(roc.data.be$auc, 4))), size = 3) +
  geom_label(aes(x = 0.25, y = 0.225, label = paste("INLA AUC:", round(base.inla.roc.data.be$auc, 4))), color = "blue", size = 3) +
  geom_label(aes(x = 0.25, y = 0.075, label = paste("glm AUC:", round(glm.roc.data.be$auc, 4))), color = "red", size = 3)
# Including the clay*rain interaction effect increased AUC from 0.9337 to 0.9345
```

### Review Spatial Autocorrelation

```{r}
### Calculate Residuals for glm model

# Create Spatial Points
j2.coords <- subset(j2, select = c(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees.))
j2.spat.points <- SpatialPointsDataFrame(coords = j2.coords, data = j2, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Calculate k nearest neighbours
j2.coords.knearneigh <- knearneigh(j2.spat.points)

# Calculate neighbours list
j2.nb <- knn2nb(j2.coords.knearneigh)

# Supplement the neighbours list with spatial weights
lw <- nb2listw(j2.nb)

# Run Morans I Test glm
moran.test(glm.results.be$residuals, lw, na.action = na.omit)
```

```{r}
### Calculate Residuals
j2.residuals <- j2 %>%
  mutate(
    mu = base.inla.results.be$summary.fitted.values$mean[(nrow(j2)+1):nrow(j2.pred)],
    residuals = `Bothriochloa ewartiana` - mu
)

# Create Spatial Points
j2.coords <- subset(j2, select = c(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees.))
j2.spat.points <- SpatialPointsDataFrame(coords = j2.coords, data = j2, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Calculate k nearest neighbours
j2.coords.knearneigh <- knearneigh(j2.spat.points)

# Calculate neighbours list
j2.nb <- knn2nb(j2.coords.knearneigh)

# Supplement the neighbours list with spatial weights
lw <- nb2listw(j2.nb)

# Run Morans I Test Base INLA
moran.test(j2.residuals$residuals, lw, na.action = na.omit)
```

```{r}
### Calculate Residuals using the Stack Index
si <- inla.stack.index(stk.obs, "obs")$data
j2.residuals <- j2 %>%
  mutate(
    mu = inla.spde.results.be$summary.fitted.values$mean[si],
    residuals = `Bothriochloa ewartiana` - mu
)

# Create Spatial Points
j2.coords <- subset(j2, select = c(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees.))
j2.spat.points <- SpatialPointsDataFrame(coords = j2.coords, data = j2, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Calculate k nearest neighbours
j2.coords.knearneigh <- knearneigh(j2.spat.points)

# Calculate neighbours list
j2.nb <- knn2nb(j2.coords.knearneigh)

# Supplement the neighbours list with spatial weights
lw <- nb2listw(j2.nb)

# Run Morans I Test Base INLA
moran.test(j2.residuals$residuals, lw, na.action = na.omit)

# The p-value is not statistically significant, and the z-score is positive.
# The null hypothesis is not rejected. The spatial distribution of high values 
# and/or low values in the dataset is not more spatially clustered than would 
# be expected if underlying spatial processes were random, ie. spatial
# autocorrelation adequately accounted for.
```

## Model Parameter Estimates

```{r}
glm.confint.be <- confint(glm.results.be)
glm.names.be <- c("nitr", "awc", "phos", "clay", "rain", "tmax", "tdif")
glm.lower.be <- c(glm.confint.be[2], glm.confint.be[3], glm.confint.be[4], glm.confint.be[5], glm.confint.be[6], glm.confint.be[7], glm.confint.be[8])
glm.upper.be <- c(glm.confint.be[10], glm.confint.be[11], glm.confint.be[12], glm.confint.be[13], glm.confint.be[14], glm.confint.be[15], glm.confint.be[16])

yyy.plot.mpe.be <- ggplot() +
  geom_vline(xintercept = 0, colour = "grey20", lty = "dashed") +
  geom_point(aes(x = glm.results.be$coefficients[2:8], y = names(glm.results.be$coefficients[2:8]), colour = "glm"), position = position_nudge(y = 0.25), size = 1.5) +
  geom_point(aes(x = inla.spde.results.be$summary.fixed$mean[2:8], y = c("nitr", "awc", "phos", "clay", "rain", "tmax", "tdif"), colour = "INLA-SPDE"), position = position_nudge(y = -0.25), size = 1.5) +
  geom_point(aes(x = base.inla.results.be$summary.fixed$mean[2:8], y = base.inla.results.be$names.fixed[2:8], colour = "INLA"), position = position_nudge(y = 0), size = 1.5) +
  #
  geom_errorbarh(aes(xmin = glm.lower.be, xmax = glm.upper.be, y = glm.names.be, colour = "glm"), position = position_nudge(y = 0.25), height = 0.175, lwd = 0.75) +
  geom_errorbarh(aes(xmin = inla.spde.results.be$summary.fixed$`0.025quant`[2:8], xmax = inla.spde.results.be$summary.fixed$`0.975quant`[2:8], y = c("nitr", "awc", "phos", "clay", "rain", "tmax", "tdif"), colour = "INLA-SPDE"), position = position_nudge(y = -0.25), height = 0.175, lwd = 0.75) +
  geom_errorbarh(aes(xmin = base.inla.results.be$summary.fixed$`0.025quant`[2:8], xmax = base.inla.results.be$summary.fixed$`0.975quant`[2:8], y = base.inla.results.be$names.fixed[2:8], colour = "INLA"), position = position_nudge(y = 0), height = 0.175, lwd = 0.75) +
  #
  #ylab("Model Parameters") +
  #xlab("") +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank()) +
  xlim(-2.5, 4.5) +
  scale_x_continuous(breaks = c(-2, -1, 0, 1, 2, 3, 4), limits = c(-2.5, 4.5)) +
  scale_color_manual(name = "Model", breaks = c("glm", "INLA", "INLA-SPDE"), values = c("red", "blue", "black"))
```

## Spatial Extrapolation Plots

```{r}
# Load in Prediction Grid
load("extrap_df.Rdata")

colnames(extrap_df) <- c("Longitude", "Latitude", "clay", "awc", "carb", "nitr", "phos", "rain1982", "rain2011", "tmax1982", "tmax2011", "tmin1982", "tmin2011","tdif1982", "tdif2011")

# Create Prediction Dataframe
df.pred <- extrap_df[,1:2]
df.pred$clay <- extrap_df$clay
df.pred$awc <- extrap_df$awc
df.pred$carb <- extrap_df$carb
df.pred$nitr <- extrap_df$nitr
df.pred$phos <- extrap_df$phos
df.pred$rain1982 <- extrap_df$rain1982
df.pred$rain2011 <- extrap_df$rain2011
df.pred$tmax1982 <- extrap_df$tmax1982
df.pred$tmax2011 <- extrap_df$tmax2011
df.pred$tdif1982 <- extrap_df$tdif1982
df.pred$tdif2011 <- extrap_df$tdif2011
```

### glm Model

```{r}
# Fit Prediction GLM
formula <- `Bothriochloa ewartiana` ~ nitr + awc + phos + clay + rain + tmax + tdif
glm.pred.results <- glm(formula, data = j2, family = "binomial")

# 1982 Climatic Data Frame
df.pred.1982 <- df.pred %>% dplyr::select(Longitude, Latitude, clay, awc, carb, nitr, phos, rain1982, tmax1982, tdif1982)

colnames(df.pred.1982) <- c("Longitude", "Latitude", "clay", "awc", "carb", "nitr", "phos", "rain", "tmax", "tdif")

# Predict New Values using GLM
extrap.glm.1982 <- as.data.frame(predict.glm(glm.pred.results, newdata = df.pred.1982, type = "link", se.fit = TRUE)) 

###
ilink <- family(glm.pred.results)$linkinv
extrap.glm.1982 <- transform(extrap.glm.1982, Fitted = ilink(fit), Upper = ilink(fit + (2 * se.fit)), Lower = ilink(fit - (2 * se.fit)))
extrap.glm.1982$`Predicted Range` <- extrap.glm.1982$Upper - extrap.glm.1982$Lower
###

extrap.glm.1982$Longitude <- df.pred$Longitude
extrap.glm.1982$Latitude <- df.pred$Latitude

colnames(extrap.glm.1982) <- c("fit", "se.fit", "residual.scale", "Presence Probability", "Upper", "Lower", "Predicted Range", "Longitude", "Latitude")

# 2011 Climatic Data Frame
df.pred.2011 <- df.pred %>% dplyr::select(Longitude, Latitude, clay, awc, carb, nitr, phos, rain2011, tmax2011, tdif2011)

colnames(df.pred.2011) <- c("Longitude", "Latitude", "clay", "awc", "carb", "nitr", "phos", "rain", "tmax", "tdif")

# Predict New Values using GLM
extrap.glm.2011 <- as.data.frame(predict.glm(glm.pred.results, newdata = df.pred.2011, type = "link", se.fit = TRUE)) 

###
extrap.glm.2011 <- transform(extrap.glm.2011, Fitted = ilink(fit), Upper = ilink(fit + (2 * se.fit)), Lower = ilink(fit - (2 * se.fit)))
extrap.glm.2011$`Predicted Range` <- extrap.glm.2011$Upper - extrap.glm.2011$Lower
###

extrap.glm.2011$Longitude <- df.pred$Longitude
extrap.glm.2011$Latitude <- df.pred$Latitude

colnames(extrap.glm.2011) <- c("fit", "se.fit", "residual.scale", "Presence Probability", "Upper", "Lower", "Predicted Range", "Longitude", "Latitude")
```

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
xxx.spat.plot.be.glm.82 <- ggplot() +
  geom_tile(data = extrap.glm.1982, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +##322FBA   #189119
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  annotation_north_arrow(location = "tl", which_north = "true", 
                         pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering, height = unit(1, "cm"), width = unit(1, "cm")) + 
  #labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Bothriochloa ewartiana Predicted Spatial Plot for 1982 Climatic Data (glm)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())

### Spatial Plot with 2011 Climatic Data
xxx.spat.plot.be.glm.11 <- ggplot() +
  geom_tile(data = extrap.glm.2011, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  #scale_fill_binned(type = "viridis") +
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  #scale_fill_gradientn(limits = c(0, 0.8), colours = c("#440154FF", "#453781FF", "#33638DFF", "#238A8DFF", "#29AF7FFF", "#73D055FF", "#DCE319FF")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  #labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Bothriochloa ewartiana Predicted Spatial Plot for 2011 Climatic Data (glm)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### Predicted Range Plots

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
rrr.spat.plot.be.glm.82 <- ggplot() +
  geom_tile(data = extrap.glm.1982, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +##322FBA   #189119
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  annotation_north_arrow(location = "tl", which_north = "true", 
                         pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering, height = unit(1, "cm"), width = unit(1, "cm")) + 
  #labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Bothriochloa ewartiana Predicted Spatial Plot for 1982 Climatic Data (glm)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())

### Spatial Plot with 2011 Climatic Data
rrr.spat.plot.be.glm.11 <- ggplot() +
  geom_tile(data = extrap.glm.2011, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  #scale_fill_binned(type = "viridis") +
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  #scale_fill_gradientn(limits = c(0, 0.8), colours = c("#440154FF", "#453781FF", "#33638DFF", "#238A8DFF", "#29AF7FFF", "#73D055FF", "#DCE319FF")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  #labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Bothriochloa ewartiana Predicted Spatial Plot for 2011 Climatic Data (glm)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### Base INLA Model

```{r}
### Spatial Random Effect

# Create Spatial Points
j2.spat.points <- SpatialPointsDataFrame(coords = j2.coords, data = j2, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Create Spatial dataframe
x <- data.frame(matrix(NA, nrow = nrow(j2.spat.points), ncol = 0))
x$Longitude <- j2.spat.points$c3c4.Longitude..Decimal.Degrees.
x$Latitude <- j2.spat.points$c3c4.Latitude..Decimal.Degrees.

# Calculate Clusters using Mean Shift Clustering
j2.mean.shift <- ms(x, h = 0.1, scaled = FALSE, iter = 200, plotms = -1)

# Observed Data 1982
df.obs.1982 <- j2 %>% dplyr::select(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees., clay, awc, carb, nitr, phos, rain, tmax, tdif, `Bothriochloa ewartiana`)

df.obs.1982$ID <- j2.mean.shift$cluster.label

colnames(df.obs.1982) <- c("Longitude", "Latitude", "clay", "awc", "carb", "nitr", "phos", "rain", "tmax", "tdif", "Bothriochloa ewartiana", "ID")

# Prediction Data 1982
df.pred.1982$`Bothriochloa ewartiana` <- NA

### Spatial Random Effect

# Create Spatial Points
j2.spat.points <- SpatialPointsDataFrame(coords = df.pred.1982[,1:2], data = df.pred.1982, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Create Spatial dataframe
x <- data.frame(matrix(NA, nrow = nrow(j2.spat.points), ncol = 0))
x$Longitude <- j2.spat.points$Longitude
x$Latitude <- j2.spat.points$Latitude

# Calculate Clusters using Mean Shift Clustering
j2.pred.mean.shift <- ms(x, h = 0.1, scaled = FALSE, iter = 200, plotms = -1)

# Add Spatial Component to Prediction Data 1982
df.pred.1982$ID <- j2.pred.mean.shift$cluster.label

# Combined Data 1982
df.pred.inla.1982 <- rbind(df.obs.1982, df.pred.1982)

formula <- "`Bothriochloa ewartiana`" ~ nitr + awc + phos + clay + rain + tmax + tdif + f(ID, model = "iid")

# Predict New Values using Base INLA 1982
extrap.base.inla.1982 <- inla(formula,
                  family = "binomial",
                  data = df.pred.inla.1982,
                  control.family = list(link = "logit"),
                  control.predictor = list(link = 1, compute = TRUE),
                  control.compute = list(dic = TRUE, cpo = TRUE, waic = TRUE),
                  verbose = FALSE)

# Predicted Values for Plotting 1982
df.extrap.base.inla.1982 <- as.data.frame(extrap.base.inla.1982$summary.fitted.values$mean[(nrow(j2) + 1):length(extrap.base.inla.1982$summary.fitted.values$mean)])

###
df.extrap.base.inla.1982$Upper <- extrap.base.inla.1982$summary.fitted.values$`0.975quant`[(nrow(j2) + 1):length(extrap.base.inla.1982$summary.fitted.values$`0.975quant`)]
df.extrap.base.inla.1982$Lower <- extrap.base.inla.1982$summary.fitted.values$`0.025quant`[(nrow(j2) + 1):length(extrap.base.inla.1982$summary.fitted.values$`0.025quant`)]
###

df.extrap.base.inla.1982$Longitude <- df.pred.1982$Longitude
df.extrap.base.inla.1982$Latitude <- df.pred.1982$Latitude

colnames(df.extrap.base.inla.1982) <- c("Presence Probability", "Upper", "Lower",  "Longitude", "Latitude")
df.extrap.base.inla.1982$`Predicted Range` <- df.extrap.base.inla.1982$Upper - df.extrap.base.inla.1982$Lower

# Observed Data 2011
df.obs.2011 <- j2 %>% dplyr::select(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees., clay, awc, carb, nitr, phos, rain, tmax, tdif, `Bothriochloa ewartiana`)

df.obs.2011$ID <- j2.mean.shift$cluster.label

colnames(df.obs.2011) <- c("Longitude", "Latitude", "clay", "awc", "carb", "nitr", "phos", "rain", "tmax", "tdif", "Bothriochloa ewartiana", "ID")

# Prediction Data 2011
df.pred.2011$`Bothriochloa ewartiana` <- NA

### Spatial Random Effect

# Create Spatial Points
j2.spat.points <- SpatialPointsDataFrame(coords = df.pred.2011[,1:2], data = df.pred.2011, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Create Spatial dataframe
x <- data.frame(matrix(NA, nrow = nrow(j2.spat.points), ncol = 0))
x$Longitude <- j2.spat.points$Longitude
x$Latitude <- j2.spat.points$Latitude

# Calculate Clusters using Mean Shift Clustering
j2.pred.mean.shift <- ms(x, h = 0.1, scaled = FALSE, iter = 200, plotms = -1)

# Add Spatial Component to Prediction Data 1982
df.pred.2011$ID <- j2.pred.mean.shift$cluster.label

# Combined Data 2011
df.pred.inla.2011 <- rbind(df.obs.2011, df.pred.2011)

formula <- "`Bothriochloa ewartiana`" ~ nitr + awc + phos + clay + rain + tmax + tdif + f(ID, model = "iid")

# Predict New Values using Base INLA 2011
extrap.base.inla.2011 <- inla(formula,
                  family = "binomial",
                  data = df.pred.inla.2011,
                  control.family = list(link = "logit"),
                  control.predictor = list(link = 1, compute = TRUE),
                  control.compute = list(dic = TRUE, cpo = TRUE, waic = TRUE),
                  verbose = FALSE)

# Predicted Values for Plotting 2011
df.extrap.base.inla.2011 <- as.data.frame(extrap.base.inla.2011$summary.fitted.values$mean[1616:length(extrap.base.inla.2011$summary.fitted.values$mean)])

###
df.extrap.base.inla.2011$Upper <- extrap.base.inla.2011$summary.fitted.values$`0.975quant`[(nrow(j2) + 1):length(extrap.base.inla.2011$summary.fitted.values$`0.975quant`)]
df.extrap.base.inla.2011$Lower <- extrap.base.inla.2011$summary.fitted.values$`0.025quant`[(nrow(j2) + 1):length(extrap.base.inla.2011$summary.fitted.values$`0.025quant`)]
###

df.extrap.base.inla.2011$Longitude <- df.pred.2011$Longitude
df.extrap.base.inla.2011$Latitude <- df.pred.2011$Latitude

colnames(df.extrap.base.inla.2011) <- c("Presence Probability", "Upper", "Lower",  "Longitude", "Latitude")
df.extrap.base.inla.2011$`Predicted Range` <- df.extrap.base.inla.2011$Upper - df.extrap.base.inla.2011$Lower
```

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
xxx.spat.plot.be.inla.82 <- ggplot() +
  geom_tile(data = df.extrap.base.inla.1982, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  #labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Bothriochloa ewartiana Predicted Spatial Plot for 1982 Climatic Data (Base INLA)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())

### Spatial Plot with 2011 Climatic Data
xxx.spat.plot.be.inla.11 <- ggplot() +
  geom_tile(data = df.extrap.base.inla.2011, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  #labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Bothriochloa ewartiana Predicted Spatial Plot for 2011 Climatic Data (Base INLA)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### Predicted Range Plots

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
rrr.spat.plot.be.inla.82 <- ggplot() +
  geom_tile(data = df.extrap.base.inla.1982, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  #labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Bothriochloa ewartiana Predicted Spatial Plot for 1982 Climatic Data (Base INLA)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())

### Spatial Plot with 2011 Climatic Data
rrr.spat.plot.be.inla.11 <- ggplot() +
  geom_tile(data = df.extrap.base.inla.2011, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  #labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Bothriochloa ewartiana Predicted Spatial Plot for 2011 Climatic Data (Base INLA)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### INLA-SPDE Model

```{r}
# Create Observed Data Mesh
j2.coord <- cbind(j2$c3c4.Longitude..Decimal.Degrees., j2$c3c4.Latitude..Decimal.Degrees.)
mesh <- inla.mesh.2d(loc = j2.coord, max.edge = c(5, 10), offset = c(3, 7))
spde <- inla.spde2.matern(mesh = mesh, alpha = 2, constr = TRUE)
indexs <- inla.spde.make.index("s", spde$n.spde)
A <- inla.spde.make.A(mesh = mesh, loc = j2.coord) # Create Projection Matrix A

# Create Predicted Data Mesh 
j2.coord.pred <- cbind(extrap_df$Longitude, extrap_df$Latitude)
mesh.pred <- inla.mesh.2d(loc = j2.coord.pred, max.edge = c(5, 10), offset = c(3, 7))
spde.p <- inla.spde2.matern(mesh = mesh.pred, alpha = 2, constr = TRUE)
indexsp <- inla.spde.make.index("sp", spde.p$n.spde)
A.pred <- inla.spde.make.A(mesh = mesh.pred, loc = j2.coord.pred) # Create Predicted Projection Matrix A


# Create Observed Stack
stk.obs <- inla.stack(tag = "obs", data = list(y = j2$`Bothriochloa ewartiana`), 
                    A = list(1, A), effects = list(data.frame(b0 = 1, nitr = j2$nitr,
                    awc = j2$awc, phos = j2$phos, clay = j2$clay,
                    rain = j2$rain, tmax = j2$tmax, tdif = j2$tdif), s = indexs))

# Create Prediction Stack
stk.pred <- inla.stack(tag = "pred", data = list(y = NA), A = list(1, A.pred), 
                       effects = list(data.frame(b0 = 1, nitr = extrap_df$nitr,
                       awc = extrap_df$awc, phos = extrap_df$phos, 
                       clay = extrap_df$clay, rain = extrap_df$rain1982, 
                       tmax = extrap_df$tmax1982, tdif = extrap_df$tdif1982), sp = indexsp))

# Combine Stacks
stk.full <- inla.stack(stk.obs, stk.pred)

formula <- y ~ 0 + b0 + nitr + awc + phos + clay + rain + tmax + tdif + f(sp, model = spde)

extrap.inla.spde.1982 <- inla(formula, family = "binomial", 
            control.family = list(link = "logit"),
            data = inla.stack.data(stk.full),
            control.predictor = list(compute = TRUE, link = 1, A = inla.stack.A(stk.full)))

###

index <- inla.stack.index(stack = stk.full, tag = "pred")$data
pres_mean <- extrap.inla.spde.1982$summary.fitted.values[index, "mean"]

###
Upper <- extrap.inla.spde.1982$summary.fitted.values[index, "0.975quant"]
Lower <- extrap.inla.spde.1982$summary.fitted.values[index, "0.025quant"]
###

# Predicted Values for Plotting 1982
df.extrap.inla.spde.1982 <- as.data.frame(pres_mean)

df.extrap.inla.spde.1982$Upper <- Upper
df.extrap.inla.spde.1982$Lower <- Lower

df.extrap.inla.spde.1982$Longitude <- extrap_df$Longitude
df.extrap.inla.spde.1982$Latitude <- extrap_df$Latitude

colnames(df.extrap.inla.spde.1982) <- c("Presence Probability", "Upper", "Lower", "Longitude", "Latitude")
df.extrap.inla.spde.1982$`Predicted Range` <- df.extrap.inla.spde.1982$Upper - df.extrap.inla.spde.1982$Lower
```

```{r}
# Create Observed Data Mesh
j2.coord <- cbind(j2$c3c4.Longitude..Decimal.Degrees., j2$c3c4.Latitude..Decimal.Degrees.)
mesh <- inla.mesh.2d(loc = j2.coord, max.edge = c(5, 10), offset = c(3, 7))
spde <- inla.spde2.matern(mesh = mesh, alpha = 2, constr = TRUE)
indexs <- inla.spde.make.index("s", spde$n.spde)
A <- inla.spde.make.A(mesh = mesh, loc = j2.coord) # Create Projection Matrix A

# Create Predicted Data Mesh 
j2.coord.pred <- cbind(extrap_df$Longitude, extrap_df$Latitude)
mesh.pred <- inla.mesh.2d(loc = j2.coord.pred, max.edge = c(5, 10), offset = c(3, 7))
spde.p <- inla.spde2.matern(mesh = mesh.pred, alpha = 2, constr = TRUE)
indexsp <- inla.spde.make.index("sp", spde.p$n.spde)
A.pred <- inla.spde.make.A(mesh = mesh.pred, loc = j2.coord.pred) # Create Predicted Projection Matrix A


# Create Observed Stack
stk.obs <- inla.stack(tag = "obs", data = list(y = j2$`Bothriochloa ewartiana`), 
                    A = list(1, A), effects = list(data.frame(b0 = 1, nitr = j2$nitr,
                    awc = j2$awc, phos = j2$phos, clay = j2$clay,
                    rain = j2$rain, tmax = j2$tmax, tdif = j2$tdif), s = indexs))

# Create Prediction Stack
stk.pred <- inla.stack(tag = "pred", data = list(y = NA), A = list(1, A.pred), 
                       effects = list(data.frame(b0 = 1, nitr = extrap_df$nitr,
                       awc = extrap_df$awc, phos = extrap_df$phos, 
                       clay = extrap_df$clay, rain = extrap_df$rain2011, 
                       tmax = extrap_df$tmax2011, tdif = extrap_df$tdif2011), sp = indexsp))

# Combine Stacks
stk.full <- inla.stack(stk.obs, stk.pred)

formula <- y ~ 0 + b0 + nitr + awc + phos + clay + rain + tmax + tdif + f(sp, model = spde)

extrap.inla.spde.2011 <- inla(formula, family = "binomial", 
            control.family = list(link = "logit"),
            data = inla.stack.data(stk.full),
            control.predictor = list(compute = TRUE, link = 1, A = inla.stack.A(stk.full)))

###

index <- inla.stack.index(stack = stk.full, tag = "pred")$data
pres_mean <- extrap.inla.spde.2011$summary.fitted.values[index, "mean"]

###
Upper <- extrap.inla.spde.2011$summary.fitted.values[index, "0.975quant"]
Lower <- extrap.inla.spde.2011$summary.fitted.values[index, "0.025quant"]
###

# Predicted Values for Plotting 2011
df.extrap.inla.spde.2011 <- as.data.frame(pres_mean)

df.extrap.inla.spde.2011$Upper <- Upper
df.extrap.inla.spde.2011$Lower <- Lower

df.extrap.inla.spde.2011$Longitude <- extrap_df$Longitude
df.extrap.inla.spde.2011$Latitude <- extrap_df$Latitude

colnames(df.extrap.inla.spde.2011) <- c("Presence Probability", "Upper", "Lower", "Longitude", "Latitude")
df.extrap.inla.spde.2011$`Predicted Range` <- df.extrap.inla.spde.2011$Upper - df.extrap.inla.spde.2011$Lower
```

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
xxx.spat.plot.be.inla.spde.82 <- ggplot() +
  geom_tile(data = df.extrap.inla.spde.1982, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  #labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Bothriochloa ewartiana Predicted Spatial Plot for 1982 Climatic Data (INLA-SPDE)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

```{r}
### Spatial Plot with 2011 Climatic Data
xxx.spat.plot.be.inla.spde.11 <- ggplot() +
  geom_tile(data = df.extrap.inla.spde.2011, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  #labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Bothriochloa ewartiana Predicted Spatial Plot for 2011 Climatic Data (INLA-SPDE)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### Predicted Range Plots

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
rrr.spat.plot.be.inla.spde.82 <- ggplot() +
  geom_tile(data = df.extrap.inla.spde.1982, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  #labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Bothriochloa ewartiana Predicted Spatial Plot for 1982 Climatic Data (INLA-SPDE)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

```{r}
### Spatial Plot with 2011 Climatic Data
rrr.spat.plot.be.inla.spde.11 <- ggplot() +
  geom_tile(data = df.extrap.inla.spde.2011, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  #labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Bothriochloa ewartiana Predicted Spatial Plot for 2011 Climatic Data (INLA-SPDE)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### Spatial Difference Plots

```{r eval=FALSE, include=FALSE}
df.diff.glm.inla.spde <- as.data.frame(extrap.glm.1982$`Presence Probability`)
df.diff.glm.inla.spde$inla.spde.1982 <- df.extrap.inla.spde.1982$`Presence Probability`

colnames(df.diff.glm.inla.spde) <- c("glm.1982.pres", "inla.spde.1982.pres")

df.diff.glm.inla.spde$Longitude <- extrap_df$Longitude
df.diff.glm.inla.spde$Latitude <- extrap_df$Latitude

df.diff.glm.inla.spde$difference <- df.diff.glm.inla.spde$inla.spde.1982.pres - df.diff.glm.inla.spde$glm.1982.pres
```

```{r eval=FALSE, include=FALSE}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Difference Plots Colours
diff.col.pal <- c("red", "orange", "white", "white", "lightgreen", "green", "darkgreen", "#003300")

### Spatial Difference Plot with 1982 Climatic Data
ggplot() +
  geom_tile(data = df.diff.glm.inla.spde, aes(x = Longitude, y = Latitude, fill = difference), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#90242b", mid = "#FFFFFF", high = "#142833", midpoint = 0) +
  scale_fill_gradientn(limits = c(-0.3, 0.3), colours = c("#800000", "#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  annotation_scale(location = "bl", width_hint = 0.5) +
  annotation_north_arrow(location = "tl", which_north = "true", 
                         pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  ggtitle("Bothriochloa ewartiana Spatial Difference Plot for\n1982 Climatic Data (glm vs INLA-SPDE)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal()
```

```{r eval=FALSE, include=FALSE}
ggplot() +
  geom_histogram(data = df.diff.glm.inla.spde, aes(x = difference), binwidth = 0.025) +
  geom_vline(xintercept = median(df.diff.glm.inla.spde$difference, na.rm = TRUE)) +
  geom_label(label = paste0("Median = ", round(median(df.diff.glm.inla.spde$difference, na.rm = TRUE), 4)), aes(x = 0.2, y = 400))
```

```{r eval=FALSE, include=FALSE}
df.diff.glm.inla.spde <- as.data.frame(extrap.glm.2011$`Presence Probability`)
df.diff.glm.inla.spde$inla.spde.2011 <- df.extrap.inla.spde.2011$`Presence Probability`

colnames(df.diff.glm.inla.spde) <- c("glm.2011.pres", "inla.spde.2011.pres")

df.diff.glm.inla.spde$Longitude <- extrap_df$Longitude
df.diff.glm.inla.spde$Latitude <- extrap_df$Latitude

df.diff.glm.inla.spde$difference <- df.diff.glm.inla.spde$inla.spde.2011.pres - df.diff.glm.inla.spde$glm.2011.pres
```

```{r eval=FALSE, include=FALSE}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Difference Plots Colours
diff.col.pal <- c("white", "white", "lightgreen", "green", "darkgreen", "#003300", "#002200", "#001100")

### Spatial Difference Plot with 1982 Climatic Data
ggplot() +
  geom_tile(data = df.diff.glm.inla.spde, aes(x = Longitude, y = Latitude, fill = difference), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#90242b", mid = "#FFFFFF", high = "#142833", midpoint = 0) +
  scale_fill_gradientn(limits = c(-0.3, 0.3), colours = c("#800000", "#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  annotation_scale(location = "bl", width_hint = 0.5) +
  annotation_north_arrow(location = "tl", which_north = "true", 
                         pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  ggtitle("Bothriochloa ewartiana Spatial Difference Plot for\n2011 Climatic Data (glm vs INLA-SPDE)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal()
```

```{r eval=FALSE, include=FALSE}
ggplot() +
  geom_histogram(data = df.diff.glm.inla.spde, aes(x = difference), binwidth = 0.025) +
  geom_vline(xintercept = median(df.diff.glm.inla.spde$difference, na.rm = TRUE)) +
  geom_label(label = paste0("Median = ", round(median(df.diff.glm.inla.spde$difference, na.rm = TRUE), 4)), aes(x = 0.2, y = 400))
```

### Predicted Spatial Range

```{r}
# Extract the calculated range parameter 'phi' from the observed INLA SPDE Model
r.f.be <- inla.spde2.result(inla.spde.results.be, "s", spde, do.transf = TRUE)
par(mfrow = c(2, 2))
plot(inla.spde.results.be$marginals.fixed[[1]], type = "l", xlab = "Intercept", ylab = "Density")
plot(inla.spde.results.be$marginals.hyperpar[[1]], type = "l", ylab = "Density", xlab = expression(phi))
plot.default(r.f.be$marginals.variance.nominal[[1]], type = "l", xlab = expression(sigma[x]^2), ylab = "Density")
plot.default(r.f.be$marginals.range.nominal[[1]], type = "l", xlab = "Practical range", ylab = "Density")
#
temp.df.be <- as.data.frame(r.f.be$marginals.range.nominal)
abline(v = max(temp.df.be$range.nominal.1.x[which.max(temp.df.be$range.nominal.1.y)]), col = "red", lty = 2)
paste0("Practical Range (Maximum Likelihood): ", round(max(temp.df.be$range.nominal.1.x[which.max(temp.df.be$range.nominal.1.y)]), 2), " Arc Degrees")
```

# Dichanthium fecundum

### Load and Manage Dataset

```{r}
# Load Dataset
load("j2_clay515.Rdata")
j2 <- j2_clay515
remove(j2_clay515)

# Subset Dataset for `Dichanthium fecundum`
j2 <- dplyr::select(j2, nitrogen515, awc515, phosphorus515, carbon515, clay515, rain18, tmin18, tmax18, tdiff18, c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees., `Dichanthium fecundum`)

# Manage Dataset
# Convert Longitude and Latitude Variables to double type
j2$c3c4.Longitude..Decimal.Degrees. <- as.double(j2$c3c4.Longitude..Decimal.Degrees.)
j2$c3c4.Latitude..Decimal.Degrees. <- as.double(j2$c3c4.Latitude..Decimal.Degrees.)
```

### Rename j2 Variables

```{r}
colnames(j2) <- c("nitr", "awc", "phos", "carb", "clay", "rain", "tmin", "tmax", "tdif", "c3c4.Longitude..Decimal.Degrees.", "c3c4.Latitude..Decimal.Degrees.", "Dichanthium fecundum")
```

### Data Cleaning and Preparation

```{r}
# Remove Observations with 'NA' values
j2 <- j2[complete.cases(j2),]
#
# Removal of Anomolous Data points
j2 <- subset(j2, j2$nitr != 0)
#
# Removal of Outliers using the IQR Criterion
#
# Remove Outliers - 'nitr' covariate
ol.quantile.nitr <- quantile(j2$nitr, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.nitr <- IQR(j2$nitr, na.rm = TRUE)
ol.upper.nitr <- ol.quantile.nitr[2] + 1.5*ol.iqr.nitr
ol.lower.nitr <- ol.quantile.nitr[1] - 1.5*ol.iqr.nitr
#
# Remove Outliers - 'awc' covariate
ol.quantile.awc <- quantile(j2$awc, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.awc <- IQR(j2$awc, na.rm = TRUE)
ol.upper.awc <- ol.quantile.awc[2] + 1.5*ol.iqr.awc
ol.lower.awc <- ol.quantile.awc[1] - 1.5*ol.iqr.awc
#
# Remove Outliers - 'phos' covariate
ol.quantile.phos <- quantile(j2$phos, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.phos <- IQR(j2$phos, na.rm = TRUE)
ol.upper.phos <- ol.quantile.phos[2] + 1.5*ol.iqr.phos
ol.lower.phos <- ol.quantile.phos[1] - 1.5*ol.iqr.phos
#
# Remove Outliers - 'carb' covariate
ol.quantile.carb <- quantile(j2$carb, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.carb <- IQR(j2$carb, na.rm = TRUE)
ol.upper.carb <- ol.quantile.carb[2] + 1.5*ol.iqr.carb
ol.lower.carb <- ol.quantile.carb[1] - 1.5*ol.iqr.carb
#
# Remove Outliers - 'clay' covariate
ol.quantile.clay <- quantile(j2$clay, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.clay <- IQR(j2$clay, na.rm = TRUE)
ol.upper.clay <- ol.quantile.clay[2] + 1.5*ol.iqr.clay
ol.lower.clay <- ol.quantile.clay[1] - 1.5*ol.iqr.clay
#
# Remove Outliers - 'rain' covariate
ol.quantile.rain <- quantile(j2$rain, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.rain <- IQR(j2$rain, na.rm = TRUE)
ol.upper.rain <- ol.quantile.rain[2] + 1.5*ol.iqr.rain
ol.lower.rain <- ol.quantile.rain[1] - 1.5*ol.iqr.rain
#
# Remove Outliers - 'tmin' covariate
ol.quantile.tmin <- quantile(j2$tmin, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.tmin <- IQR(j2$tmin, na.rm = TRUE)
ol.upper.tmin <- ol.quantile.tmin[2] + 1.5*ol.iqr.tmin
ol.lower.tmin <- ol.quantile.tmin[1] - 1.5*ol.iqr.tmin
#
# Remove Outliers - 'tmin' covariate
ol.quantile.tmin <- quantile(j2$tmin, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.tmin <- IQR(j2$tmin, na.rm = TRUE)
ol.upper.tmin <- ol.quantile.tmin[2] + 1.5*ol.iqr.tmin
ol.lower.tmin <- ol.quantile.tmin[1] - 1.5*ol.iqr.tmin
#
# Remove Outliers - 'tdif' covariate
ol.quantile.tdif <- quantile(j2$tdif, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.tdif <- IQR(j2$tdif, na.rm = TRUE)
ol.upper.tdif <- ol.quantile.tdif[2] + 1.5*ol.iqr.tdif
ol.lower.tdif <- ol.quantile.tdif[1] - 1.5*ol.iqr.tdif
#
# Subsetting
j2 <- subset(j2, nitr > ol.lower.nitr & nitr < ol.upper.nitr)
j2 <- subset(j2, awc > ol.lower.awc & awc < ol.upper.awc)
j2 <- subset(j2, phos > ol.lower.phos & phos < ol.upper.phos)
j2 <- subset(j2, carb > ol.lower.carb & carb < ol.upper.carb)
j2 <- subset(j2, clay > ol.lower.clay & clay < ol.upper.clay)
j2 <- subset(j2, rain > ol.lower.rain & rain < ol.upper.rain)
j2 <- subset(j2, tmin > ol.lower.tmin & tmin < ol.upper.tmin)
j2 <- subset(j2, tmin > ol.lower.tmin & tmin < ol.upper.tmin)
j2 <- subset(j2, tdif > ol.lower.tdif & tdif < ol.upper.tdif)
#
```

### Spatial Map of Observed Data

```{r eval=FALSE, include=FALSE}
# Mapping Objects
world_shp <- sf::st_as_sf(maps::map("world", plot = FALSE, fill = TRUE))
aus_shp<- world_shp[world_shp$ID == "Australia",]

# Mapping Colours
map.colours <- c("Absence" = "gray", "Presence" = "steelblue", "Removed" = "pink")

# Dichanthium fecundum Spatial Plot - All Available Data
plot.study.area <- ggplot() +
#ggplot() +
  geom_sf(data = aus_shp, fill = "white") +
  coord_sf(xlim = c(110.00, 157.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  annotation_scale(location = "bl", width_hint = 0.5) +
  annotation_north_arrow(location = "tl", which_north = "true",
                         pad_x = unit(0.15, "in"), pad_y = unit(0.1, "in"),
                         style = north_arrow_fancy_orienteering) +
  #geom_point(data = subset(j2, `Dichanthium fecundum`==0),
  #           aes(x = c3c4.Longitude..Decimal.Degrees.,
  #               y = c3c4.Latitude..Decimal.Degrees., colour = "Absence")) +
  #geom_point(data = subset(j2, `Dichanthium fecundum`==1),
  #           aes(x = c3c4.Longitude..Decimal.Degrees.,
  #               y = c3c4.Latitude..Decimal.Degrees., colour = "Presence")) +
  geom_point(data = j2, aes(x = c3c4.Longitude..Decimal.Degrees.,
                 y = c3c4.Latitude..Decimal.Degrees.), colour = "black") +
  #labs(x = "Longitude", y = "Latitude", color = "Legend") +
  labs(x = "Longitude (\u00B0)", y = "Latitude (\u00B0)") +
  scale_color_manual(values = map.colours) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.margin = unit(c(0,0,0,2), "mm")) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  theme_minimal()
  #theme(legend.title = element_blank()) +
  #theme(legend.position = "none")
ggsave("Study Area.png", device = "png")
```

### Descriptive Statistics

```{r eval=FALSE, include=FALSE}
response.table <- table(j2$`Dichanthium fecundum`)
response.table <- data.frame(response.table)
response.table[,1] <- c("Absence", "Presence")
response.table[,3] <- c(paste(round((response.table[1,2]/sum(response.table[,2]))*100,2),"%"), paste(round((response.table[2,2]/sum(response.table[,2]))*100,2),"%"))
response.table[3,] <- c("Total", sum(response.table[,2]), "100.00%")
knitr::kable(response.table, col.names = c(" ", "Count", "Proportion"), caption = "Summary of Absence/Presence Response in Dichanthium fecundum") %>% kable_styling(full_width = FALSE) %>%
  save_kable("astrebla-covariate-table.png")
response.table
```

```{r eval=FALSE, include=FALSE}
#descriptive.data.frame <- j2 %>% dplyr::select(nitr, awc, phos, carb, clay, rain, tmin, tmax, tdif, `Dichanthium fecundum`)
descriptive.data.frame <- j2 %>% dplyr::select(nitr, awc, phos, carb, clay, rain, tmin, tmax, tdif)

plotnitr <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = nitr)) +
  theme_minimal() + 
  theme(axis.text.y = element_blank()) +
  scale_x_continuous(breaks = c(min(j2$nitr), 0.04, 0.08, 0.12, max(j2$nitr)), labels = scales::number_format(accuracy = 0.01))

plotawc <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = awc)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plotphos <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = phos)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank()) +
  scale_x_continuous(breaks = c(0.01, 0.02, 0.03, 0.04, 0.05, max(j2$phos)), labels = scales::number_format(accuracy = 0.01))

plotcarb <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = carb)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plotclay <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = clay)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plotrain <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = rain)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plottmin <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = tmin)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plottmax <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = tmax)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plottdif <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = tdif)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

grid.arrange(plotnitr, plotawc, plotphos, plotcarb, plotclay, plotrain, plottmin, plottmax, plottdif, ncol = 3)
```

```{r eval=FALSE, include=FALSE}
### Descriptive statistics Table for Paper
# 
# awc
paste("awc min:", round(min(j2$awc),4))
paste("awc mean:", round(mean(j2$awc),4))
paste("awc max:", round(max(j2$awc),4))
#
paste("")
# clay
paste("clay min:", round(min(j2$clay),4))
paste("clay mean:", round(mean(j2$clay),4))
paste("clay max:", round(max(j2$clay),4))
#
paste("")
# nitr
paste("nitr min:", round(min(j2$nitr),4))
paste("nitr mean:", round(mean(j2$nitr),4))
paste("nitr max:", round(max(j2$nitr),4))
#
paste("")
# phos
paste("phos min:", round(min(j2$phos),4))
paste("phos mean:", round(mean(j2$phos),4))
paste("phos max:", round(max(j2$phos),4))
#
paste("")
# rain
paste("rain min:", round(min(j2$rain),4))
paste("rain mean:", round(mean(j2$rain),4))
paste("rain max:", round(max(j2$rain),4))
#
paste("")
# tdif
paste("tdif min:", round(min(j2$tdif),4))
paste("tdif mean:", round(mean(j2$tdif),4))
paste("tdif max:", round(max(j2$tdif),4))
# 
paste("")
# tmax
paste("tmax min:", round(min(j2$tmax),4))
paste("tmax mean:", round(mean(j2$tmax),4))
paste("tmax max:", round(max(j2$tmax),4))
```

### Multicollinearity

```{r eval=FALSE, include=FALSE}
j2.corr <- cor(descriptive.data.frame)
corrplot(j2.corr, method = 'number')
```

Selected Model Covariates for Dichanthium fecundum following review of Multicollinearity:

* nitr
* awc
* phos
* clay
* rain
* tmax
* tdif

### Covariate Standardisation

```{r}
# Load Functions
source("cent.R")
source("reversecent.R")
#
# Create Standardised j2 Data Frame
j2.cent <- data.frame(matrix(NA, nrow = nrow(j2), ncol = 0))
j2.cent$nitr <- cent(j2$nitr)
j2.cent$awc <- cent(j2$awc)
j2.cent$phos <- cent(j2$phos)
j2.cent$carb <- cent(j2$carb)
j2.cent$clay <- cent(j2$clay)
j2.cent$rain <- cent(j2$rain)
j2.cent$tmin <- cent(j2$tmin)
j2.cent$tmax <- cent(j2$tmax)
j2.cent$tdif <- cent(j2$tdif)
j2.cent$c3c4.Longitude..Decimal.Degrees. <- j2$c3c4.Longitude..Decimal.Degrees.
j2.cent$c3c4.Latitude..Decimal.Degrees. <- j2$c3c4.Latitude..Decimal.Degrees.
j2.cent$`Dichanthium fecundum` <- j2$`Dichanthium fecundum`
#
```

## Model Fitting

### glm Model

```{r}
formula <- `Dichanthium fecundum` ~ nitr + awc + phos + clay + rain + tmax + tdif

glm.results.df <- glm(formula, data = j2.cent, family = "binomial")
summary(glm.results.df)
```

### Plot glm Results using Leaflet

```{r}
pal <- colorNumeric("viridis", c(0, 1), na.color = "transparent")
```

```{r eval=FALSE, include=FALSE}
leaflet() %>% addTiles() %>%
  addCircles(lng = j2$c3c4.Longitude..Decimal.Degrees., lat = j2$c3c4.Latitude..Decimal.Degrees., color = pal(glm.results.df$fitted.values)) %>%
  addLegend("bottomright", pal = pal, values = glm.results.df$fitted.values, title = "Mean Presence Prob") %>%
  addScaleBar(position = c("bottomleft"))
```

### Base INLA Model

```{r}
# Base INLA - Linear Fixed Effects with Spatial Random Effect Included

### Prepare Prediction Data Frame
j2.pred.temp <- j2.cent
j2.pred.temp$`Dichanthium fecundum` <- NA
j2.pred <- rbind(j2.cent, j2.pred.temp)

### Spatial Random Effect
# Create Spatial Points
j2.coords <- subset(j2, select = c(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees.))
j2.spat.points <- SpatialPointsDataFrame(coords = j2.coords, data = j2, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Create Spatial dataframe
x <- data.frame(matrix(NA, nrow = nrow(j2.spat.points), ncol = 0))
x$Longitude <- j2.spat.points$c3c4.Longitude..Decimal.Degrees.
x$Latitude <- j2.spat.points$c3c4.Latitude..Decimal.Degrees.

# Calculate Clusters using Mean Shift Clustering
j2.mean.shift <- ms(x, h = 0.1, scaled = FALSE, iter = 200, plotms = -1)

j2.pred$ID <- cent(j2.mean.shift$cluster.label)

### Formula
formula <- "`Dichanthium fecundum`" ~ nitr + awc + phos + clay + rain + tmax + tdif + f(ID, model = "iid")

### Fit Model
base.inla.results.df <- inla(formula,
                  family = "binomial",
                  data = j2.pred,
                  control.family = list(link = "logit"),
                  control.predictor = list(link = 1, compute = TRUE),
                  control.compute = list(dic = TRUE, cpo = TRUE, waic = TRUE),
                  verbose = FALSE) # TRUE if full output is required
summary(base.inla.results.df)
```

### Plot Base INLA Results using Leaflet

```{r eval=FALSE, include=FALSE}
leaflet() %>% addTiles() %>%
  addCircles(lng = j2$c3c4.Longitude..Decimal.Degrees., lat = j2$c3c4.Latitude..Decimal.Degrees., color = pal(base.inla.results.df$summary.fitted.values$mean)) %>%
  addLegend("bottomright", pal = pal, values = base.inla.results.df$summary.fitted.values$mean, title = "Mean Presence Prob") %>%
  addScaleBar(position = c("bottomleft"))
```

### INLA-SPDE Model

```{r}
# Create Observed Data Mesh
j2.coord <- cbind(j2$c3c4.Longitude..Decimal.Degrees., j2$c3c4.Latitude..Decimal.Degrees.)
mesh <- inla.mesh.2d(loc = j2.coord, max.edge = c(5, 10), offset = c(3, 7))
spde <- inla.spde2.matern(mesh = mesh, alpha = 2, constr = TRUE)
indexs <- inla.spde.make.index("s", spde$n.spde)
A <- inla.spde.make.A(mesh = mesh, loc = j2.coord) # Create Projection Matrix A

# Create Predicted Data Mesh 
j2.coord.pred <- cbind(j2$c3c4.Longitude..Decimal.Degrees., j2$c3c4.Latitude..Decimal.Degrees.)
mesh.pred <- inla.mesh.2d(loc = j2.coord.pred, max.edge = c(5, 10), offset = c(3, 7))
A.pred <- inla.spde.make.A(mesh = mesh.pred, loc = j2.coord.pred) # Create Predicted Projection Matrix A

# Create Observed Stack
stk.obs <- inla.stack(tag = "obs", data = list(y = j2.cent$`Dichanthium fecundum`), 
                    A = list(1, A), effects = list(data.frame(b0 = 1, nitr = j2.cent$nitr,
                    awc = j2.cent$awc, phos = j2.cent$phos, clay = j2.cent$clay,
                    rain = j2.cent$rain, tmax = j2.cent$tmax, tdif = j2.cent$tdif), s = indexs))

stk.pred <- inla.stack(tag = "pred", data = list(y = NA), A = list(1, A.pred), 
                       effects = list(data.frame(b0 = 1, nitr = j2.cent$nitr,
                       awc = j2.cent$awc, phos = j2.cent$phos, 
                       clay = j2.cent$clay, rain = j2.cent$rain, 
                       tmin = j2.cent$tmax, tdif12 = j2.cent$tdif), s = indexs))
#
# Combine Stacks
stk.full <- inla.stack(stk.obs, stk.pred)

formula <- y ~ 0 + b0 + nitr + awc + phos + clay + rain + tmax + tdif + f(s, model = spde)
#
```

### Display Mesh

```{r eval=FALSE, include=FALSE}
plot(mesh)
points(x = j2.coord[,1], y = j2.coord[,2], col = "red", pch = 19, cex = 0.5)
```

### Run INLA-SPDE Model

```{r}
inla.spde.results.df <- inla(formula, family = "binomial", 
            control.family = list(link = "logit"),
            data = inla.stack.data(stk.full),
            control.predictor = list(compute = TRUE, link = 1, A = inla.stack.A(stk.full)))
```

### INLA-SPDE Model Results

```{r}
summary(inla.spde.results.df)

index <- inla.stack.index(stack = stk.full, tag = "pred")$data

pres_mean <- inla.spde.results.df$summary.fitted.values[index, "mean"]
pres_ll <- inla.spde.results.df$summary.fitted.values[index, "0.025quant"]
pres_ul <- inla.spde.results.df$summary.fitted.values[index, "0.975quant"]

pal <- colorNumeric("viridis", c(0, 1), na.color = "transparent")
```

### Dichanthium fecundum Mean Predicted Species Presence using Leaflet

```{r eval=FALSE, include=FALSE}
leaflet() %>% addTiles() %>%
  addCircles(lng = j2.coord.pred[,1], lat = j2.coord.pred[, 2], color = pal(pres_mean)) %>%
  addLegend("bottomright", pal = pal, values = pres_mean, title = "Mean Presence Prob") %>%
  addScaleBar(position = c("bottomleft"))
```

### INLA-SPDE Model Validity (AUC and ROC)

```{r}
# glm ROC
glm.predictions.df <- glm.results.df$fitted.values
glm.roc.data.df <- roc(response = j2$`Dichanthium fecundum`, predictor = glm.predictions.df, auc = TRUE)
glm.roc.data.spec.df <- as.data.frame(glm.roc.data.df$specificities)
glm.roc.data.sens.df <- as.data.frame(glm.roc.data.df$sensitivities)
glm.roc.data.final.df <- cbind(glm.roc.data.spec.df, glm.roc.data.sens.df)

# Base INLA ROC
base.inla.predictions.df <- base.inla.results.df$summary.fitted.values$mean[(nrow(j2.cent)+1):length(base.inla.results.df$summary.fitted.values$mean)]
base.inla.roc.data.df <- roc(response = j2$`Dichanthium fecundum`, predictor = base.inla.predictions.df, auc = TRUE)
base.inla.roc.data.spec.df <- as.data.frame(base.inla.roc.data.df$specificities)
base.inla.roc.data.sens.df <- as.data.frame(base.inla.roc.data.df$sensitivities)
base.inla.roc.data.final.df <- cbind(base.inla.roc.data.spec.df, base.inla.roc.data.sens.df)

# INLA-SPDE ROC
predictions.df <- inla.spde.results.df$summary.fitted.values$mean[1:length(j2.cent$nitr)]
roc.data.df <- roc(response = j2$`Dichanthium fecundum`, predictor = predictions.df, auc = TRUE)
roc.data.spec.df <- as.data.frame(roc.data.df$specificities)
roc.data.sens.df <- as.data.frame(roc.data.df$sensitivities)
roc.data.final.df <- cbind(roc.data.spec.df, roc.data.sens.df)

zzz.plot.df.roc <- ggplot() +
  geom_segment(aes(x = 1, y = 0, xend = 0, yend = 1), color = "gray") +
  geom_line(data = glm.roc.data.final.df, aes(x = `glm.roc.data.df$specificities`, y = `glm.roc.data.df$sensitivities`), color = "red", lwd = 0.75) +
  geom_line(data = base.inla.roc.data.final.df, aes(x = `base.inla.roc.data.df$specificities`, y = `base.inla.roc.data.df$sensitivities`), color = "blue", lwd = 0.75) +
  geom_line(data = roc.data.final.df, aes(x = `roc.data.df$specificities`, y = `roc.data.df$sensitivities`), lwd = 0.75) +
  scale_x_reverse() + 
  theme_minimal() +
  xlab("Specificity") +
  ylab("Sensitivity") +
  #ggtitle("Dichanthium fecundum Model - ROC Curves") +
  #theme(axis.title.x = element_blank()) +
  #theme(axis.title.y = element_blank()) +
  geom_label(aes(x = 0.25, y = 0.375, label = paste("INLA-SPDE AUC:", round(roc.data.df$auc, 4))), size = 3) +
  geom_label(aes(x = 0.25, y = 0.225, label = paste("INLA AUC:", round(base.inla.roc.data.df$auc, 4))), color = "blue", size = 3) +
  geom_label(aes(x = 0.25, y = 0.075, label = paste("glm AUC:", round(glm.roc.data.df$auc, 4))), color = "red", size = 3)
# Including the clay*rain interaction effect increased AUC from 0.9337 to 0.9345
```

### Review Spatial Autocorrelation

```{r}
### Calculate Residuals for glm model

# Create Spatial Points
j2.coords <- subset(j2, select = c(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees.))
j2.spat.points <- SpatialPointsDataFrame(coords = j2.coords, data = j2, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Calculate k nearest neighbours
j2.coords.knearneigh <- knearneigh(j2.spat.points)

# Calculate neighbours list
j2.nb <- knn2nb(j2.coords.knearneigh)

# Supplement the neighbours list with spatial weights
lw <- nb2listw(j2.nb)

# Run Morans I Test glm
moran.test(glm.results.df$residuals, lw, na.action = na.omit)
```

```{r}
### Calculate Residuals
j2.residuals <- j2 %>%
  mutate(
    mu = base.inla.results.df$summary.fitted.values$mean[(nrow(j2)+1):nrow(j2.pred)],
    residuals = `Dichanthium fecundum` - mu
)

# Create Spatial Points
j2.coords <- subset(j2, select = c(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees.))
j2.spat.points <- SpatialPointsDataFrame(coords = j2.coords, data = j2, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Calculate k nearest neighbours
j2.coords.knearneigh <- knearneigh(j2.spat.points)

# Calculate neighbours list
j2.nb <- knn2nb(j2.coords.knearneigh)

# Supplement the neighbours list with spatial weights
lw <- nb2listw(j2.nb)

# Run Morans I Test Base INLA
moran.test(j2.residuals$residuals, lw, na.action = na.omit)
```

```{r}
### Calculate Residuals using the Stack Index
si <- inla.stack.index(stk.obs, "obs")$data
j2.residuals <- j2 %>%
  mutate(
    mu = inla.spde.results.df$summary.fitted.values$mean[si],
    residuals = `Dichanthium fecundum` - mu
)

# Create Spatial Points
j2.coords <- subset(j2, select = c(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees.))
j2.spat.points <- SpatialPointsDataFrame(coords = j2.coords, data = j2, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Calculate k nearest neighbours
j2.coords.knearneigh <- knearneigh(j2.spat.points)

# Calculate neighbours list
j2.nb <- knn2nb(j2.coords.knearneigh)

# Supplement the neighbours list with spatial weights
lw <- nb2listw(j2.nb)

# Run Morans I Test Base INLA
moran.test(j2.residuals$residuals, lw, na.action = na.omit)

# The p-value is not statistically significant, and the z-score is positive.
# The null hypothesis is not rejected. The spatial distribution of high values 
# and/or low values in the dataset is not more spatially clustered than would 
# be expected if underlying spatial processes were random, ie. spatial
# autocorrelation adequately accounted for.
```

## Model Parameter Estimates

```{r}
glm.confint.df <- confint(glm.results.df)
glm.names.df <- c("nitr", "awc", "phos", "clay", "rain", "tmax", "tdif")
glm.lower.df <- c(glm.confint.df[2], glm.confint.df[3], glm.confint.df[4], glm.confint.df[5], glm.confint.df[6], glm.confint.df[7], glm.confint.df[8])
glm.upper.df <- c(glm.confint.df[10], glm.confint.df[11], glm.confint.df[12], glm.confint.df[13], glm.confint.df[14], glm.confint.df[15], glm.confint.df[16])

yyy.plot.mpe.df <- ggplot() +
  geom_vline(xintercept = 0, colour = "grey20", lty = "dashed") +
  geom_point(aes(x = glm.results.df$coefficients[2:8], y = names(glm.results.df$coefficients[2:8]), colour = "glm"), position = position_nudge(y = 0.25), size = 1.5) +
  geom_point(aes(x = inla.spde.results.df$summary.fixed$mean[2:8], y = c("nitr", "awc", "phos", "clay", "rain", "tmax", "tdif"), colour = "INLA-SPDE"), position = position_nudge(y = -0.25), size = 1.5) +
  geom_point(aes(x = base.inla.results.df$summary.fixed$mean[2:8], y = base.inla.results.df$names.fixed[2:8], colour = "INLA"), position = position_nudge(y = 0), size = 1.5) +
  #
  geom_errorbarh(aes(xmin = glm.lower.df, xmax = glm.upper.df, y = glm.names.df, colour = "glm"), position = position_nudge(y = 0.25), height = 0.175, lwd = 0.75) +
  geom_errorbarh(aes(xmin = inla.spde.results.df$summary.fixed$`0.025quant`[2:8], xmax = inla.spde.results.df$summary.fixed$`0.975quant`[2:8], y = c("nitr", "awc", "phos", "clay", "rain", "tmax", "tdif"), colour = "INLA-SPDE"), position = position_nudge(y = -0.25), height = 0.175, lwd = 0.75) +
  geom_errorbarh(aes(xmin = base.inla.results.df$summary.fixed$`0.025quant`[2:8], xmax = base.inla.results.df$summary.fixed$`0.975quant`[2:8], y = base.inla.results.df$names.fixed[2:8], colour = "INLA"), position = position_nudge(y = 0), height = 0.175, lwd = 0.75) +
  #
  #ylab("Model Parameters") +
  #xlab("") +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank()) +
  xlim(-2.5, 4.5) +
  scale_x_continuous(breaks = c(-2, -1, 0, 1, 2, 3, 4), limits = c(-2.5, 4.5)) +
  scale_color_manual(name = "Model", breaks = c("glm", "INLA", "INLA-SPDE"), values = c("red", "blue", "black"))
```

## Spatial Extrapolation Plots

```{r}
# Load in Prediction Grid
load("extrap_df.Rdata")

colnames(extrap_df) <- c("Longitude", "Latitude", "clay", "awc", "carb", "nitr", "phos", "rain1982", "rain2011", "tmax1982", "tmax2011", "tmin1982", "tmin2011","tdif1982", "tdif2011")

# Create Prediction Dataframe
df.pred <- extrap_df[,1:2]
df.pred$clay <- extrap_df$clay
df.pred$awc <- extrap_df$awc
df.pred$carb <- extrap_df$carb
df.pred$nitr <- extrap_df$nitr
df.pred$phos <- extrap_df$phos
df.pred$rain1982 <- extrap_df$rain1982
df.pred$rain2011 <- extrap_df$rain2011
df.pred$tmax1982 <- extrap_df$tmax1982
df.pred$tmax2011 <- extrap_df$tmax2011
df.pred$tdif1982 <- extrap_df$tdif1982
df.pred$tdif2011 <- extrap_df$tdif2011
```

### glm Model

```{r}
# Fit Prediction GLM
formula <- `Dichanthium fecundum` ~ nitr + awc + phos + clay + rain + tmax + tdif
glm.pred.results <- glm(formula, data = j2, family = "binomial")

# 1982 Climatic Data Frame
df.pred.1982 <- df.pred %>% dplyr::select(Longitude, Latitude, clay, awc, carb, nitr, phos, rain1982, tmax1982, tdif1982)

colnames(df.pred.1982) <- c("Longitude", "Latitude", "clay", "awc", "carb", "nitr", "phos", "rain", "tmax", "tdif")

# Predict New Values using GLM
extrap.glm.1982 <- as.data.frame(predict.glm(glm.pred.results, newdata = df.pred.1982, type = "link", se.fit = TRUE)) 

###
ilink <- family(glm.pred.results)$linkinv
extrap.glm.1982 <- transform(extrap.glm.1982, Fitted = ilink(fit), Upper = ilink(fit + (2 * se.fit)), Lower = ilink(fit - (2 * se.fit)))
extrap.glm.1982$`Predicted Range` <- extrap.glm.1982$Upper - extrap.glm.1982$Lower
###

extrap.glm.1982$Longitude <- df.pred$Longitude
extrap.glm.1982$Latitude <- df.pred$Latitude

colnames(extrap.glm.1982) <- c("fit", "se.fit", "residual.scale", "Presence Probability", "Upper", "Lower", "Predicted Range", "Longitude", "Latitude")

# 2011 Climatic Data Frame
df.pred.2011 <- df.pred %>% dplyr::select(Longitude, Latitude, clay, awc, carb, nitr, phos, rain2011, tmax2011, tdif2011)

colnames(df.pred.2011) <- c("Longitude", "Latitude", "clay", "awc", "carb", "nitr", "phos", "rain", "tmax", "tdif")

# Predict New Values using GLM
extrap.glm.2011 <- as.data.frame(predict.glm(glm.pred.results, newdata = df.pred.2011, type = "link", se.fit = TRUE)) 

###
extrap.glm.2011 <- transform(extrap.glm.2011, Fitted = ilink(fit), Upper = ilink(fit + (2 * se.fit)), Lower = ilink(fit - (2 * se.fit)))
extrap.glm.2011$`Predicted Range` <- extrap.glm.2011$Upper - extrap.glm.2011$Lower
###

extrap.glm.2011$Longitude <- df.pred$Longitude
extrap.glm.2011$Latitude <- df.pred$Latitude

colnames(extrap.glm.2011) <- c("fit", "se.fit", "residual.scale", "Presence Probability", "Upper", "Lower", "Predicted Range", "Longitude", "Latitude")
```

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
xxx.spat.plot.df.glm.82 <- ggplot() +
  geom_tile(data = extrap.glm.1982, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +##322FBA   #189119
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  annotation_north_arrow(location = "tl", which_north = "true", 
                         pad_x = unit(0.1, "in"), pad_y = unit(0.1, "in"),
                         style = north_arrow_fancy_orienteering, height = unit(1, "cm"), width = unit(1, "cm")) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Dichanthium fecundum Predicted Spatial Plot for 1982 Climatic Data (glm)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())

### Spatial Plot with 2011 Climatic Data
xxx.spat.plot.df.glm.11 <- ggplot() +
  geom_tile(data = extrap.glm.2011, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  #scale_fill_binned(type = "viridis") +
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  #scale_fill_gradientn(limits = c(0, 0.8), colours = c("#440154FF", "#453781FF", "#33638DFF", "#238A8DFF", "#29AF7FFF", "#73D055FF", "#DCE319FF")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Dichanthium fecundum Predicted Spatial Plot for 2011 Climatic Data (glm)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### Predicted Range Plots

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
rrr.spat.plot.df.glm.82 <- ggplot() +
  geom_tile(data = extrap.glm.1982, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +##322FBA   #189119
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  annotation_north_arrow(location = "tl", which_north = "true", 
                         pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering, height = unit(1, "cm"), width = unit(1, "cm")) +
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Dichanthium fecundum Predicted Spatial Plot for 1982 Climatic Data (glm)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())

### Spatial Plot with 2011 Climatic Data
rrr.spat.plot.df.glm.11 <- ggplot() +
  geom_tile(data = extrap.glm.2011, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  #scale_fill_binned(type = "viridis") +
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  #scale_fill_gradientn(limits = c(0, 0.8), colours = c("#440154FF", "#453781FF", "#33638DFF", "#238A8DFF", "#29AF7FFF", "#73D055FF", "#DCE319FF")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Dichanthium fecundum Predicted Spatial Plot for 2011 Climatic Data (glm)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### Base INLA Model

```{r}
### Spatial Random Effect

# Create Spatial Points
j2.spat.points <- SpatialPointsDataFrame(coords = j2.coords, data = j2, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Create Spatial dataframe
x <- data.frame(matrix(NA, nrow = nrow(j2.spat.points), ncol = 0))
x$Longitude <- j2.spat.points$c3c4.Longitude..Decimal.Degrees.
x$Latitude <- j2.spat.points$c3c4.Latitude..Decimal.Degrees.

# Calculate Clusters using Mean Shift Clustering
j2.mean.shift <- ms(x, h = 0.1, scaled = FALSE, iter = 200, plotms = -1)

# Observed Data 1982
df.obs.1982 <- j2 %>% dplyr::select(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees., clay, awc, carb, nitr, phos, rain, tmax, tdif, `Dichanthium fecundum`)

df.obs.1982$ID <- j2.mean.shift$cluster.label

colnames(df.obs.1982) <- c("Longitude", "Latitude", "clay", "awc", "carb", "nitr", "phos", "rain", "tmax", "tdif", "Dichanthium fecundum", "ID")

# Prediction Data 1982
df.pred.1982$`Dichanthium fecundum` <- NA

### Spatial Random Effect

# Create Spatial Points
j2.spat.points <- SpatialPointsDataFrame(coords = df.pred.1982[,1:2], data = df.pred.1982, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Create Spatial dataframe
x <- data.frame(matrix(NA, nrow = nrow(j2.spat.points), ncol = 0))
x$Longitude <- j2.spat.points$Longitude
x$Latitude <- j2.spat.points$Latitude

# Calculate Clusters using Mean Shift Clustering
j2.pred.mean.shift <- ms(x, h = 0.1, scaled = FALSE, iter = 200, plotms = -1)

# Add Spatial Component to Prediction Data 1982
df.pred.1982$ID <- j2.pred.mean.shift$cluster.label

# Combined Data 1982
df.pred.inla.1982 <- rbind(df.obs.1982, df.pred.1982)

formula <- "`Dichanthium fecundum`" ~ nitr + awc + phos + clay + rain + tmax + tdif + f(ID, model = "iid")

# Predict New Values using Base INLA 1982
extrap.base.inla.1982 <- inla(formula,
                  family = "binomial",
                  data = df.pred.inla.1982,
                  control.family = list(link = "logit"),
                  control.predictor = list(link = 1, compute = TRUE),
                  control.compute = list(dic = TRUE, cpo = TRUE, waic = TRUE),
                  verbose = FALSE)

# Predicted Values for Plotting 1982
df.extrap.base.inla.1982 <- as.data.frame(extrap.base.inla.1982$summary.fitted.values$mean[(nrow(j2) + 1):length(extrap.base.inla.1982$summary.fitted.values$mean)])

###
df.extrap.base.inla.1982$Upper <- extrap.base.inla.1982$summary.fitted.values$`0.975quant`[(nrow(j2) + 1):length(extrap.base.inla.1982$summary.fitted.values$`0.975quant`)]
df.extrap.base.inla.1982$Lower <- extrap.base.inla.1982$summary.fitted.values$`0.025quant`[(nrow(j2) + 1):length(extrap.base.inla.1982$summary.fitted.values$`0.025quant`)]
###

df.extrap.base.inla.1982$Longitude <- df.pred.1982$Longitude
df.extrap.base.inla.1982$Latitude <- df.pred.1982$Latitude

colnames(df.extrap.base.inla.1982) <- c("Presence Probability", "Upper", "Lower",  "Longitude", "Latitude")
df.extrap.base.inla.1982$`Predicted Range` <- df.extrap.base.inla.1982$Upper - df.extrap.base.inla.1982$Lower

# Observed Data 2011
df.obs.2011 <- j2 %>% dplyr::select(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees., clay, awc, carb, nitr, phos, rain, tmax, tdif, `Dichanthium fecundum`)

df.obs.2011$ID <- j2.mean.shift$cluster.label

colnames(df.obs.2011) <- c("Longitude", "Latitude", "clay", "awc", "carb", "nitr", "phos", "rain", "tmax", "tdif", "Dichanthium fecundum", "ID")

# Prediction Data 2011
df.pred.2011$`Dichanthium fecundum` <- NA

### Spatial Random Effect

# Create Spatial Points
j2.spat.points <- SpatialPointsDataFrame(coords = df.pred.2011[,1:2], data = df.pred.2011, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Create Spatial dataframe
x <- data.frame(matrix(NA, nrow = nrow(j2.spat.points), ncol = 0))
x$Longitude <- j2.spat.points$Longitude
x$Latitude <- j2.spat.points$Latitude

# Calculate Clusters using Mean Shift Clustering
j2.pred.mean.shift <- ms(x, h = 0.1, scaled = FALSE, iter = 200, plotms = -1)

# Add Spatial Component to Prediction Data 1982
df.pred.2011$ID <- j2.pred.mean.shift$cluster.label

# Combined Data 2011
df.pred.inla.2011 <- rbind(df.obs.2011, df.pred.2011)

formula <- "`Dichanthium fecundum`" ~ nitr + awc + phos + clay + rain + tmax + tdif + f(ID, model = "iid")

# Predict New Values using Base INLA 2011
extrap.base.inla.2011 <- inla(formula,
                  family = "binomial",
                  data = df.pred.inla.2011,
                  control.family = list(link = "logit"),
                  control.predictor = list(link = 1, compute = TRUE),
                  control.compute = list(dic = TRUE, cpo = TRUE, waic = TRUE),
                  verbose = FALSE)

# Predicted Values for Plotting 2011
df.extrap.base.inla.2011 <- as.data.frame(extrap.base.inla.2011$summary.fitted.values$mean[1616:length(extrap.base.inla.2011$summary.fitted.values$mean)])

###
df.extrap.base.inla.2011$Upper <- extrap.base.inla.2011$summary.fitted.values$`0.975quant`[(nrow(j2) + 1):length(extrap.base.inla.2011$summary.fitted.values$`0.975quant`)]
df.extrap.base.inla.2011$Lower <- extrap.base.inla.2011$summary.fitted.values$`0.025quant`[(nrow(j2) + 1):length(extrap.base.inla.2011$summary.fitted.values$`0.025quant`)]
###

df.extrap.base.inla.2011$Longitude <- df.pred.2011$Longitude
df.extrap.base.inla.2011$Latitude <- df.pred.2011$Latitude

colnames(df.extrap.base.inla.2011) <- c("Presence Probability", "Upper", "Lower",  "Longitude", "Latitude")
df.extrap.base.inla.2011$`Predicted Range` <- df.extrap.base.inla.2011$Upper - df.extrap.base.inla.2011$Lower
```

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
xxx.spat.plot.df.inla.82 <- ggplot() +
  geom_tile(data = df.extrap.base.inla.1982, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Dichanthium fecundum Predicted Spatial Plot for 1982 Climatic Data (Base INLA)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())

### Spatial Plot with 2011 Climatic Data
xxx.spat.plot.df.inla.11 <- ggplot() +
  geom_tile(data = df.extrap.base.inla.2011, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Dichanthium fecundum Predicted Spatial Plot for 2011 Climatic Data (Base INLA)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### Predicted Range Plots

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
rrr.spat.plot.df.inla.82 <- ggplot() +
  geom_tile(data = df.extrap.base.inla.1982, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Dichanthium fecundum Predicted Spatial Plot for 1982 Climatic Data (Base INLA)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())

### Spatial Plot with 2011 Climatic Data
rrr.spat.plot.df.inla.11 <- ggplot() +
  geom_tile(data = df.extrap.base.inla.2011, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Dichanthium fecundum Predicted Spatial Plot for 2011 Climatic Data (Base INLA)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### INLA-SPDE Model

```{r}
# Create Observed Data Mesh
j2.coord <- cbind(j2$c3c4.Longitude..Decimal.Degrees., j2$c3c4.Latitude..Decimal.Degrees.)
mesh <- inla.mesh.2d(loc = j2.coord, max.edge = c(5, 10), offset = c(3, 7))
spde <- inla.spde2.matern(mesh = mesh, alpha = 2, constr = TRUE)
indexs <- inla.spde.make.index("s", spde$n.spde)
A <- inla.spde.make.A(mesh = mesh, loc = j2.coord) # Create Projection Matrix A

# Create Predicted Data Mesh 
j2.coord.pred <- cbind(extrap_df$Longitude, extrap_df$Latitude)
mesh.pred <- inla.mesh.2d(loc = j2.coord.pred, max.edge = c(5, 10), offset = c(3, 7))
spde.p <- inla.spde2.matern(mesh = mesh.pred, alpha = 2, constr = TRUE)
indexsp <- inla.spde.make.index("sp", spde.p$n.spde)
A.pred <- inla.spde.make.A(mesh = mesh.pred, loc = j2.coord.pred) # Create Predicted Projection Matrix A


# Create Observed Stack
stk.obs <- inla.stack(tag = "obs", data = list(y = j2$`Dichanthium fecundum`), 
                    A = list(1, A), effects = list(data.frame(b0 = 1, nitr = j2$nitr,
                    awc = j2$awc, phos = j2$phos, clay = j2$clay,
                    rain = j2$rain, tmax = j2$tmax, tdif = j2$tdif), s = indexs))

# Create Prediction Stack
stk.pred <- inla.stack(tag = "pred", data = list(y = NA), A = list(1, A.pred), 
                       effects = list(data.frame(b0 = 1, nitr = extrap_df$nitr,
                       awc = extrap_df$awc, phos = extrap_df$phos, 
                       clay = extrap_df$clay, rain = extrap_df$rain1982, 
                       tmax = extrap_df$tmax1982, tdif = extrap_df$tdif1982), sp = indexsp))

# Combine Stacks
stk.full <- inla.stack(stk.obs, stk.pred)

formula <- y ~ 0 + b0 + nitr + awc + phos + clay + rain + tmax + tdif + f(sp, model = spde)

extrap.inla.spde.1982 <- inla(formula, family = "binomial", 
            control.family = list(link = "logit"),
            data = inla.stack.data(stk.full),
            control.predictor = list(compute = TRUE, link = 1, A = inla.stack.A(stk.full)))

###

index <- inla.stack.index(stack = stk.full, tag = "pred")$data
pres_mean <- extrap.inla.spde.1982$summary.fitted.values[index, "mean"]

###
Upper <- extrap.inla.spde.1982$summary.fitted.values[index, "0.975quant"]
Lower <- extrap.inla.spde.1982$summary.fitted.values[index, "0.025quant"]
###

# Predicted Values for Plotting 1982
df.extrap.inla.spde.1982 <- as.data.frame(pres_mean)

df.extrap.inla.spde.1982$Upper <- Upper
df.extrap.inla.spde.1982$Lower <- Lower

df.extrap.inla.spde.1982$Longitude <- extrap_df$Longitude
df.extrap.inla.spde.1982$Latitude <- extrap_df$Latitude

colnames(df.extrap.inla.spde.1982) <- c("Presence Probability", "Upper", "Lower", "Longitude", "Latitude")
df.extrap.inla.spde.1982$`Predicted Range` <- df.extrap.inla.spde.1982$Upper - df.extrap.inla.spde.1982$Lower
```

```{r}
# Create Observed Data Mesh
j2.coord <- cbind(j2$c3c4.Longitude..Decimal.Degrees., j2$c3c4.Latitude..Decimal.Degrees.)
mesh <- inla.mesh.2d(loc = j2.coord, max.edge = c(5, 10), offset = c(3, 7))
spde <- inla.spde2.matern(mesh = mesh, alpha = 2, constr = TRUE)
indexs <- inla.spde.make.index("s", spde$n.spde)
A <- inla.spde.make.A(mesh = mesh, loc = j2.coord) # Create Projection Matrix A

# Create Predicted Data Mesh 
j2.coord.pred <- cbind(extrap_df$Longitude, extrap_df$Latitude)
mesh.pred <- inla.mesh.2d(loc = j2.coord.pred, max.edge = c(5, 10), offset = c(3, 7))
spde.p <- inla.spde2.matern(mesh = mesh.pred, alpha = 2, constr = TRUE)
indexsp <- inla.spde.make.index("sp", spde.p$n.spde)
A.pred <- inla.spde.make.A(mesh = mesh.pred, loc = j2.coord.pred) # Create Predicted Projection Matrix A


# Create Observed Stack
stk.obs <- inla.stack(tag = "obs", data = list(y = j2$`Dichanthium fecundum`), 
                    A = list(1, A), effects = list(data.frame(b0 = 1, nitr = j2$nitr,
                    awc = j2$awc, phos = j2$phos, clay = j2$clay,
                    rain = j2$rain, tmax = j2$tmax, tdif = j2$tdif), s = indexs))

# Create Prediction Stack
stk.pred <- inla.stack(tag = "pred", data = list(y = NA), A = list(1, A.pred), 
                       effects = list(data.frame(b0 = 1, nitr = extrap_df$nitr,
                       awc = extrap_df$awc, phos = extrap_df$phos, 
                       clay = extrap_df$clay, rain = extrap_df$rain2011, 
                       tmax = extrap_df$tmax2011, tdif = extrap_df$tdif2011), sp = indexsp))

# Combine Stacks
stk.full <- inla.stack(stk.obs, stk.pred)

formula <- y ~ 0 + b0 + nitr + awc + phos + clay + rain + tmax + tdif + f(sp, model = spde)

extrap.inla.spde.2011 <- inla(formula, family = "binomial", 
            control.family = list(link = "logit"),
            data = inla.stack.data(stk.full),
            control.predictor = list(compute = TRUE, link = 1, A = inla.stack.A(stk.full)))

###

index <- inla.stack.index(stack = stk.full, tag = "pred")$data
pres_mean <- extrap.inla.spde.2011$summary.fitted.values[index, "mean"]

###
Upper <- extrap.inla.spde.2011$summary.fitted.values[index, "0.975quant"]
Lower <- extrap.inla.spde.2011$summary.fitted.values[index, "0.025quant"]
###

# Predicted Values for Plotting 2011
df.extrap.inla.spde.2011 <- as.data.frame(pres_mean)

df.extrap.inla.spde.2011$Upper <- Upper
df.extrap.inla.spde.2011$Lower <- Lower

df.extrap.inla.spde.2011$Longitude <- extrap_df$Longitude
df.extrap.inla.spde.2011$Latitude <- extrap_df$Latitude

colnames(df.extrap.inla.spde.2011) <- c("Presence Probability", "Upper", "Lower", "Longitude", "Latitude")
df.extrap.inla.spde.2011$`Predicted Range` <- df.extrap.inla.spde.2011$Upper - df.extrap.inla.spde.2011$Lower
```

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
xxx.spat.plot.df.inla.spde.82 <- ggplot() +
  geom_tile(data = df.extrap.inla.spde.1982, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Dichanthium fecundum Predicted Spatial Plot for 1982 Climatic Data (INLA-SPDE)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

```{r}
### Spatial Plot with 2011 Climatic Data
xxx.spat.plot.df.inla.spde.11 <- ggplot() +
  geom_tile(data = df.extrap.inla.spde.2011, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Dichanthium fecundum Predicted Spatial Plot for 2011 Climatic Data (INLA-SPDE)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### Predicted Range Plots

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
rrr.spat.plot.df.inla.spde.82 <- ggplot() +
  geom_tile(data = df.extrap.inla.spde.1982, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Dichanthium fecundum Predicted Spatial Plot for 1982 Climatic Data (INLA-SPDE)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

```{r}
### Spatial Plot with 2011 Climatic Data
rrr.spat.plot.df.inla.spde.11 <- ggplot() +
  geom_tile(data = df.extrap.inla.spde.2011, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Dichanthium fecundum Predicted Spatial Plot for 2011 Climatic Data (INLA-SPDE)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### Spatial Difference Plots

```{r eval=FALSE, include=FALSE}
df.diff.glm.inla.spde <- as.data.frame(extrap.glm.1982$`Presence Probability`)
df.diff.glm.inla.spde$inla.spde.1982 <- df.extrap.inla.spde.1982$`Presence Probability`

colnames(df.diff.glm.inla.spde) <- c("glm.1982.pres", "inla.spde.1982.pres")

df.diff.glm.inla.spde$Longitude <- extrap_df$Longitude
df.diff.glm.inla.spde$Latitude <- extrap_df$Latitude

df.diff.glm.inla.spde$difference <- df.diff.glm.inla.spde$inla.spde.1982.pres - df.diff.glm.inla.spde$glm.1982.pres
```

```{r eval=FALSE, include=FALSE}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Difference Plots Colours
diff.col.pal <- c("red", "orange", "white", "white", "lightgreen", "green", "darkgreen", "#003300")

### Spatial Difference Plot with 1982 Climatic Data
ggplot() +
  geom_tile(data = df.diff.glm.inla.spde, aes(x = Longitude, y = Latitude, fill = difference), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#90242b", mid = "#FFFFFF", high = "#142833", midpoint = 0) +
  scale_fill_gradientn(limits = c(-0.3, 0.3), colours = c("#800000", "#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  annotation_scale(location = "bl", width_hint = 0.5) +
  annotation_north_arrow(location = "tl", which_north = "true", 
                         pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  ggtitle("Dichanthium fecundum Spatial Difference Plot for\n1982 Climatic Data (glm vs INLA-SPDE)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal()
```

```{r eval=FALSE, include=FALSE}
ggplot() +
  geom_histogram(data = df.diff.glm.inla.spde, aes(x = difference), binwidth = 0.025) +
  geom_vline(xintercept = median(df.diff.glm.inla.spde$difference, na.rm = TRUE)) +
  geom_label(label = paste0("Median = ", round(median(df.diff.glm.inla.spde$difference, na.rm = TRUE), 4)), aes(x = 0.2, y = 400))
```

```{r eval=FALSE, include=FALSE}
df.diff.glm.inla.spde <- as.data.frame(extrap.glm.2011$`Presence Probability`)
df.diff.glm.inla.spde$inla.spde.2011 <- df.extrap.inla.spde.2011$`Presence Probability`

colnames(df.diff.glm.inla.spde) <- c("glm.2011.pres", "inla.spde.2011.pres")

df.diff.glm.inla.spde$Longitude <- extrap_df$Longitude
df.diff.glm.inla.spde$Latitude <- extrap_df$Latitude

df.diff.glm.inla.spde$difference <- df.diff.glm.inla.spde$inla.spde.2011.pres - df.diff.glm.inla.spde$glm.2011.pres
```

```{r eval=FALSE, include=FALSE}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Difference Plots Colours
diff.col.pal <- c("white", "white", "lightgreen", "green", "darkgreen", "#003300", "#002200", "#001100")

### Spatial Difference Plot with 1982 Climatic Data
ggplot() +
  geom_tile(data = df.diff.glm.inla.spde, aes(x = Longitude, y = Latitude, fill = difference), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#90242b", mid = "#FFFFFF", high = "#142833", midpoint = 0) +
  scale_fill_gradientn(limits = c(-0.3, 0.3), colours = c("#800000", "#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  annotation_scale(location = "bl", width_hint = 0.5) +
  annotation_north_arrow(location = "tl", which_north = "true", 
                         pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  ggtitle("Dichanthium fecundum Spatial Difference Plot for\n2011 Climatic Data (glm vs INLA-SPDE)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal()
```

```{r eval=FALSE, include=FALSE}
ggplot() +
  geom_histogram(data = df.diff.glm.inla.spde, aes(x = difference), binwidth = 0.025) +
  geom_vline(xintercept = median(df.diff.glm.inla.spde$difference, na.rm = TRUE)) +
  geom_label(label = paste0("Median = ", round(median(df.diff.glm.inla.spde$difference, na.rm = TRUE), 4)), aes(x = 0.2, y = 400))
```

### Predicted Spatial Range

```{r}
# Extract the calculated range parameter 'phi' from the observed INLA SPDE Model
r.f.df <- inla.spde2.result(inla.spde.results.df, "s", spde, do.transf = TRUE)
par(mfrow = c(2, 2))
plot(inla.spde.results.df$marginals.fixed[[1]], type = "l", xlab = "Intercept", ylab = "Density")
plot(inla.spde.results.df$marginals.hyperpar[[1]], type = "l", ylab = "Density", xlab = expression(phi))
plot.default(r.f.df$marginals.variance.nominal[[1]], type = "l", xlab = expression(sigma[x]^2), ylab = "Density")
plot.default(r.f.df$marginals.range.nominal[[1]], type = "l", xlab = "Practical range", ylab = "Density")
#
temp.df.df <- as.data.frame(r.f.df$marginals.range.nominal)
abline(v = max(temp.df.df$range.nominal.1.x[which.max(temp.df.df$range.nominal.1.y)]), col = "red", lty = 2)
paste0("Practical Range (Maximum Likelihood): ", round(max(temp.df.df$range.nominal.1.x[which.max(temp.df.df$range.nominal.1.y)]), 2), " Arc Degrees")
```

# Themeda triandra

### Load and Manage Dataset

```{r}
# Load Dataset
load("j2_clay515.Rdata")
j2 <- j2_clay515
remove(j2_clay515)

# Subset Dataset for `Themeda triandra`
j2 <- dplyr::select(j2, nitrogen515, awc515, phosphorus515, carbon515, clay515, rain18, tmin18, tmax18, tdiff18, c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees., `Themeda triandra`)

# Manage Dataset
# Convert Longitude and Latitude Variables to double type
j2$c3c4.Longitude..Decimal.Degrees. <- as.double(j2$c3c4.Longitude..Decimal.Degrees.)
j2$c3c4.Latitude..Decimal.Degrees. <- as.double(j2$c3c4.Latitude..Decimal.Degrees.)
```

### Rename j2 Variables

```{r}
colnames(j2) <- c("nitr", "awc", "phos", "carb", "clay", "rain", "tmin", "tmax", "tdif", "c3c4.Longitude..Decimal.Degrees.", "c3c4.Latitude..Decimal.Degrees.", "Themeda triandra")
```

### Data Cleaning and Preparation

```{r}
# Remove Observations with 'NA' values
j2 <- j2[complete.cases(j2),]
#
# Removal of Anomolous Data points
j2 <- subset(j2, j2$nitr != 0)
#
# Removal of Outliers using the IQR Criterion
#
# Remove Outliers - 'nitr' covariate
ol.quantile.nitr <- quantile(j2$nitr, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.nitr <- IQR(j2$nitr, na.rm = TRUE)
ol.upper.nitr <- ol.quantile.nitr[2] + 1.5*ol.iqr.nitr
ol.lower.nitr <- ol.quantile.nitr[1] - 1.5*ol.iqr.nitr
#
# Remove Outliers - 'awc' covariate
ol.quantile.awc <- quantile(j2$awc, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.awc <- IQR(j2$awc, na.rm = TRUE)
ol.upper.awc <- ol.quantile.awc[2] + 1.5*ol.iqr.awc
ol.lower.awc <- ol.quantile.awc[1] - 1.5*ol.iqr.awc
#
# Remove Outliers - 'phos' covariate
ol.quantile.phos <- quantile(j2$phos, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.phos <- IQR(j2$phos, na.rm = TRUE)
ol.upper.phos <- ol.quantile.phos[2] + 1.5*ol.iqr.phos
ol.lower.phos <- ol.quantile.phos[1] - 1.5*ol.iqr.phos
#
# Remove Outliers - 'carb' covariate
ol.quantile.carb <- quantile(j2$carb, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.carb <- IQR(j2$carb, na.rm = TRUE)
ol.upper.carb <- ol.quantile.carb[2] + 1.5*ol.iqr.carb
ol.lower.carb <- ol.quantile.carb[1] - 1.5*ol.iqr.carb
#
# Remove Outliers - 'clay' covariate
ol.quantile.clay <- quantile(j2$clay, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.clay <- IQR(j2$clay, na.rm = TRUE)
ol.upper.clay <- ol.quantile.clay[2] + 1.5*ol.iqr.clay
ol.lower.clay <- ol.quantile.clay[1] - 1.5*ol.iqr.clay
#
# Remove Outliers - 'rain' covariate
ol.quantile.rain <- quantile(j2$rain, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.rain <- IQR(j2$rain, na.rm = TRUE)
ol.upper.rain <- ol.quantile.rain[2] + 1.5*ol.iqr.rain
ol.lower.rain <- ol.quantile.rain[1] - 1.5*ol.iqr.rain
#
# Remove Outliers - 'tmin' covariate
ol.quantile.tmin <- quantile(j2$tmin, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.tmin <- IQR(j2$tmin, na.rm = TRUE)
ol.upper.tmin <- ol.quantile.tmin[2] + 1.5*ol.iqr.tmin
ol.lower.tmin <- ol.quantile.tmin[1] - 1.5*ol.iqr.tmin
#
# Remove Outliers - 'tmin' covariate
ol.quantile.tmin <- quantile(j2$tmin, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.tmin <- IQR(j2$tmin, na.rm = TRUE)
ol.upper.tmin <- ol.quantile.tmin[2] + 1.5*ol.iqr.tmin
ol.lower.tmin <- ol.quantile.tmin[1] - 1.5*ol.iqr.tmin
#
# Remove Outliers - 'tdif' covariate
ol.quantile.tdif <- quantile(j2$tdif, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.tdif <- IQR(j2$tdif, na.rm = TRUE)
ol.upper.tdif <- ol.quantile.tdif[2] + 1.5*ol.iqr.tdif
ol.lower.tdif <- ol.quantile.tdif[1] - 1.5*ol.iqr.tdif
#
# Subsetting
j2 <- subset(j2, nitr > ol.lower.nitr & nitr < ol.upper.nitr)
j2 <- subset(j2, awc > ol.lower.awc & awc < ol.upper.awc)
j2 <- subset(j2, phos > ol.lower.phos & phos < ol.upper.phos)
j2 <- subset(j2, carb > ol.lower.carb & carb < ol.upper.carb)
j2 <- subset(j2, clay > ol.lower.clay & clay < ol.upper.clay)
j2 <- subset(j2, rain > ol.lower.rain & rain < ol.upper.rain)
j2 <- subset(j2, tmin > ol.lower.tmin & tmin < ol.upper.tmin)
j2 <- subset(j2, tmin > ol.lower.tmin & tmin < ol.upper.tmin)
j2 <- subset(j2, tdif > ol.lower.tdif & tdif < ol.upper.tdif)
#
```

### Spatial Map of Observed Data

```{r eval=FALSE, include=FALSE}
# Mapping Objects
world_shp <- sf::st_as_sf(maps::map("world", plot = FALSE, fill = TRUE))
aus_shp<- world_shp[world_shp$ID == "Australia",]

# Mapping Colours
map.colours <- c("Absence" = "gray", "Presence" = "steelblue", "Removed" = "pink")

# Themeda triandra Spatial Plot - All Available Data
plot.study.area <- ggplot() +
#ggplot() +
  geom_sf(data = aus_shp, fill = "white") +
  coord_sf(xlim = c(110.00, 157.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  annotation_scale(location = "bl", width_hint = 0.5) +
  annotation_north_arrow(location = "tl", which_north = "true",
                         pad_x = unit(0.15, "in"), pad_y = unit(0.1, "in"),
                         style = north_arrow_fancy_orienteering) +
  #geom_point(data = subset(j2, `Themeda triandra`==0),
  #           aes(x = c3c4.Longitude..Decimal.Degrees.,
  #               y = c3c4.Latitude..Decimal.Degrees., colour = "Absence")) +
  #geom_point(data = subset(j2, `Themeda triandra`==1),
  #           aes(x = c3c4.Longitude..Decimal.Degrees.,
  #               y = c3c4.Latitude..Decimal.Degrees., colour = "Presence")) +
  geom_point(data = j2, aes(x = c3c4.Longitude..Decimal.Degrees.,
                 y = c3c4.Latitude..Decimal.Degrees.), colour = "black") +
  #labs(x = "Longitude", y = "Latitude", color = "Legend") +
  labs(x = "Longitude (\u00B0)", y = "Latitude (\u00B0)") +
  scale_color_manual(values = map.colours) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.margin = unit(c(0,0,0,2), "mm")) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  theme_minimal()
  #theme(legend.title = element_blank()) +
  #theme(legend.position = "none")
ggsave("Study Area.png", device = "png")
```

### Descriptive Statistics

```{r eval=FALSE, include=FALSE}
response.table <- table(j2$`Themeda triandra`)
response.table <- data.frame(response.table)
response.table[,1] <- c("Absence", "Presence")
response.table[,3] <- c(paste(round((response.table[1,2]/sum(response.table[,2]))*100,2),"%"), paste(round((response.table[2,2]/sum(response.table[,2]))*100,2),"%"))
response.table[3,] <- c("Total", sum(response.table[,2]), "100.00%")
knitr::kable(response.table, col.names = c(" ", "Count", "Proportion"), caption = "Summary of Absence/Presence Response in Themeda triandra") %>% kable_styling(full_width = FALSE) %>%
  save_kable("astrebla-covariate-table.png")
response.table
```

```{r eval=FALSE, include=FALSE}
#descriptive.data.frame <- j2 %>% dplyr::select(nitr, awc, phos, carb, clay, rain, tmin, tmax, tdif, `Themeda triandra`)
descriptive.data.frame <- j2 %>% dplyr::select(nitr, awc, phos, carb, clay, rain, tmin, tmax, tdif)

plotnitr <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = nitr)) +
  theme_minimal() + 
  theme(axis.text.y = element_blank()) +
  scale_x_continuous(breaks = c(min(j2$nitr), 0.04, 0.08, 0.12, max(j2$nitr)), labels = scales::number_format(accuracy = 0.01))

plotawc <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = awc)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plotphos <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = phos)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank()) +
  scale_x_continuous(breaks = c(0.01, 0.02, 0.03, 0.04, 0.05, max(j2$phos)), labels = scales::number_format(accuracy = 0.01))

plotcarb <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = carb)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plotclay <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = clay)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plotrain <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = rain)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plottmin <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = tmin)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plottmax <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = tmax)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

plottdif <- ggplot() + 
  geom_boxplot(descriptive.data.frame, mapping = aes(x = tdif)) + 
  theme_minimal() + 
  theme(axis.text.y=element_blank())

grid.arrange(plotnitr, plotawc, plotphos, plotcarb, plotclay, plotrain, plottmin, plottmax, plottdif, ncol = 3)
```

```{r eval=FALSE, include=FALSE}
### Descriptive statistics Table for Paper
# 
# awc
paste("awc min:", round(min(j2$awc),4))
paste("awc mean:", round(mean(j2$awc),4))
paste("awc max:", round(max(j2$awc),4))
#
paste("")
# clay
paste("clay min:", round(min(j2$clay),4))
paste("clay mean:", round(mean(j2$clay),4))
paste("clay max:", round(max(j2$clay),4))
#
paste("")
# nitr
paste("nitr min:", round(min(j2$nitr),4))
paste("nitr mean:", round(mean(j2$nitr),4))
paste("nitr max:", round(max(j2$nitr),4))
#
paste("")
# phos
paste("phos min:", round(min(j2$phos),4))
paste("phos mean:", round(mean(j2$phos),4))
paste("phos max:", round(max(j2$phos),4))
#
paste("")
# rain
paste("rain min:", round(min(j2$rain),4))
paste("rain mean:", round(mean(j2$rain),4))
paste("rain max:", round(max(j2$rain),4))
#
paste("")
# tdif
paste("tdif min:", round(min(j2$tdif),4))
paste("tdif mean:", round(mean(j2$tdif),4))
paste("tdif max:", round(max(j2$tdif),4))
# 
paste("")
# tmax
paste("tmax min:", round(min(j2$tmax),4))
paste("tmax mean:", round(mean(j2$tmax),4))
paste("tmax max:", round(max(j2$tmax),4))
```

### Multicollinearity

```{r eval=FALSE, include=FALSE}
j2.corr <- cor(descriptive.data.frame)
corrplot(j2.corr, method = 'number')
```

Selected Model Covariates for Themeda triandra following review of Multicollinearity:

* nitr
* awc
* phos
* clay
* rain
* tmax
* tdif

### Covariate Standardisation

```{r}
# Load Functions
source("cent.R")
source("reversecent.R")
#
# Create Standardised j2 Data Frame
j2.cent <- data.frame(matrix(NA, nrow = nrow(j2), ncol = 0))
j2.cent$nitr <- cent(j2$nitr)
j2.cent$awc <- cent(j2$awc)
j2.cent$phos <- cent(j2$phos)
j2.cent$carb <- cent(j2$carb)
j2.cent$clay <- cent(j2$clay)
j2.cent$rain <- cent(j2$rain)
j2.cent$tmin <- cent(j2$tmin)
j2.cent$tmax <- cent(j2$tmax)
j2.cent$tdif <- cent(j2$tdif)
j2.cent$c3c4.Longitude..Decimal.Degrees. <- j2$c3c4.Longitude..Decimal.Degrees.
j2.cent$c3c4.Latitude..Decimal.Degrees. <- j2$c3c4.Latitude..Decimal.Degrees.
j2.cent$`Themeda triandra` <- j2$`Themeda triandra`
#
```

## Model Fitting

### glm Model

```{r}
formula <- `Themeda triandra` ~ nitr + awc + phos + clay + rain + tmax + tdif

glm.results.tt <- glm(formula, data = j2.cent, family = "binomial")
summary(glm.results.tt)
```

### Plot glm Results using Leaflet

```{r}
pal <- colorNumeric("viridis", c(0, 1), na.color = "transparent")
```

```{r eval=FALSE, include=FALSE}
leaflet() %>% addTiles() %>%
  addCircles(lng = j2$c3c4.Longitude..Decimal.Degrees., lat = j2$c3c4.Latitude..Decimal.Degrees., color = pal(glm.results.tt$fitted.values)) %>%
  addLegend("bottomright", pal = pal, values = glm.results.tt$fitted.values, title = "Mean Presence Prob") %>%
  addScaleBar(position = c("bottomleft"))
```

### Base INLA Model

```{r}
# Base INLA - Linear Fixed Effects with Spatial Random Effect Included

### Prepare Prediction Data Frame
j2.pred.temp <- j2.cent
j2.pred.temp$`Themeda triandra` <- NA
j2.pred <- rbind(j2.cent, j2.pred.temp)

### Spatial Random Effect
# Create Spatial Points
j2.coords <- subset(j2, select = c(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees.))
j2.spat.points <- SpatialPointsDataFrame(coords = j2.coords, data = j2, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Create Spatial dataframe
x <- data.frame(matrix(NA, nrow = nrow(j2.spat.points), ncol = 0))
x$Longitude <- j2.spat.points$c3c4.Longitude..Decimal.Degrees.
x$Latitude <- j2.spat.points$c3c4.Latitude..Decimal.Degrees.

# Calculate Clusters using Mean Shift Clustering
j2.mean.shift <- ms(x, h = 0.1, scaled = FALSE, iter = 200, plotms = -1)

j2.pred$ID <- cent(j2.mean.shift$cluster.label)

### Formula
formula <- "`Themeda triandra`" ~ nitr + awc + phos + clay + rain + tmax + tdif + f(ID, model = "iid")

### Fit Model
base.inla.results.tt <- inla(formula,
                  family = "binomial",
                  data = j2.pred,
                  control.family = list(link = "logit"),
                  control.predictor = list(link = 1, compute = TRUE),
                  control.compute = list(dic = TRUE, cpo = TRUE, waic = TRUE),
                  verbose = FALSE) # TRUE if full output is required
summary(base.inla.results.tt)
```

### Plot Base INLA Results using Leaflet

```{r eval=FALSE, include=FALSE}
leaflet() %>% addTiles() %>%
  addCircles(lng = j2$c3c4.Longitude..Decimal.Degrees., lat = j2$c3c4.Latitude..Decimal.Degrees., color = pal(base.inla.results.tt$summary.fitted.values$mean)) %>%
  addLegend("bottomright", pal = pal, values = base.inla.results.tt$summary.fitted.values$mean, title = "Mean Presence Prob") %>%
  addScaleBar(position = c("bottomleft"))
```

### INLA-SPDE Model

```{r}
# Create Observed Data Mesh
j2.coord <- cbind(j2$c3c4.Longitude..Decimal.Degrees., j2$c3c4.Latitude..Decimal.Degrees.)
mesh <- inla.mesh.2d(loc = j2.coord, max.edge = c(5, 10), offset = c(3, 7))
spde <- inla.spde2.matern(mesh = mesh, alpha = 2, constr = TRUE)
indexs <- inla.spde.make.index("s", spde$n.spde)
A <- inla.spde.make.A(mesh = mesh, loc = j2.coord) # Create Projection Matrix A

# Create Predicted Data Mesh 
j2.coord.pred <- cbind(j2$c3c4.Longitude..Decimal.Degrees., j2$c3c4.Latitude..Decimal.Degrees.)
mesh.pred <- inla.mesh.2d(loc = j2.coord.pred, max.edge = c(5, 10), offset = c(3, 7))
A.pred <- inla.spde.make.A(mesh = mesh.pred, loc = j2.coord.pred) # Create Predicted Projection Matrix A

# Create Observed Stack
stk.obs <- inla.stack(tag = "obs", data = list(y = j2.cent$`Themeda triandra`), 
                    A = list(1, A), effects = list(data.frame(b0 = 1, nitr = j2.cent$nitr,
                    awc = j2.cent$awc, phos = j2.cent$phos, clay = j2.cent$clay,
                    rain = j2.cent$rain, tmax = j2.cent$tmax, tdif = j2.cent$tdif), s = indexs))

stk.pred <- inla.stack(tag = "pred", data = list(y = NA), A = list(1, A.pred), 
                       effects = list(data.frame(b0 = 1, nitr = j2.cent$nitr,
                       awc = j2.cent$awc, phos = j2.cent$phos, 
                       clay = j2.cent$clay, rain = j2.cent$rain, 
                       tmin = j2.cent$tmax, tdif12 = j2.cent$tdif), s = indexs))
#
# Combine Stacks
stk.full <- inla.stack(stk.obs, stk.pred)

formula <- y ~ 0 + b0 + nitr + awc + phos + clay + rain + tmax + tdif + f(s, model = spde)
#
```

### Display Mesh

```{r eval=FALSE, include=FALSE}
plot(mesh)
points(x = j2.coord[,1], y = j2.coord[,2], col = "red", pch = 19, cex = 0.5)
```

### Run INLA-SPDE Model

```{r}
inla.spde.results.tt <- inla(formula, family = "binomial", 
            control.family = list(link = "logit"),
            data = inla.stack.data(stk.full),
            control.predictor = list(compute = TRUE, link = 1, A = inla.stack.A(stk.full)))
```

### INLA-SPDE Model Results

```{r}
summary(inla.spde.results.tt)

index <- inla.stack.index(stack = stk.full, tag = "pred")$data

pres_mean <- inla.spde.results.tt$summary.fitted.values[index, "mean"]
pres_ll <- inla.spde.results.tt$summary.fitted.values[index, "0.025quant"]
pres_ul <- inla.spde.results.tt$summary.fitted.values[index, "0.975quant"]

pal <- colorNumeric("viridis", c(0, 1), na.color = "transparent")
```

### Themeda triandra Mean Predicted Species Presence using Leaflet

```{r eval=FALSE, include=FALSE}
leaflet() %>% addTiles() %>%
  addCircles(lng = j2.coord.pred[,1], lat = j2.coord.pred[, 2], color = pal(pres_mean)) %>%
  addLegend("bottomright", pal = pal, values = pres_mean, title = "Mean Presence Prob") %>%
  addScaleBar(position = c("bottomleft"))
```

### INLA-SPDE Model Validity (AUC and ROC)

```{r}
# glm ROC
glm.predictions.tt <- glm.results.tt$fitted.values
glm.roc.data.tt <- roc(response = j2$`Themeda triandra`, predictor = glm.predictions.tt, auc = TRUE)
glm.roc.data.spec.tt <- as.data.frame(glm.roc.data.tt$specificities)
glm.roc.data.sens.tt <- as.data.frame(glm.roc.data.tt$sensitivities)
glm.roc.data.final.tt <- cbind(glm.roc.data.spec.tt, glm.roc.data.sens.tt)

# Base INLA ROC
base.inla.predictions.tt <- base.inla.results.tt$summary.fitted.values$mean[(nrow(j2.cent)+1):length(base.inla.results.tt$summary.fitted.values$mean)]
base.inla.roc.data.tt <- roc(response = j2$`Themeda triandra`, predictor = base.inla.predictions.tt, auc = TRUE)
base.inla.roc.data.spec.tt <- as.data.frame(base.inla.roc.data.tt$specificities)
base.inla.roc.data.sens.tt <- as.data.frame(base.inla.roc.data.tt$sensitivities)
base.inla.roc.data.final.tt <- cbind(base.inla.roc.data.spec.tt, base.inla.roc.data.sens.tt)

# INLA-SPDE ROC
predictions.tt <- inla.spde.results.tt$summary.fitted.values$mean[1:length(j2.cent$nitr)]
roc.data.tt <- roc(response = j2$`Themeda triandra`, predictor = predictions.tt, auc = TRUE)
roc.data.spec.tt <- as.data.frame(roc.data.tt$specificities)
roc.data.sens.tt <- as.data.frame(roc.data.tt$sensitivities)
roc.data.final.tt <- cbind(roc.data.spec.tt, roc.data.sens.tt)

zzz.plot.tt.roc <- ggplot() +
  geom_segment(aes(x = 1, y = 0, xend = 0, yend = 1), color = "gray") +
  geom_line(data = glm.roc.data.final.tt, aes(x = `glm.roc.data.tt$specificities`, y = `glm.roc.data.tt$sensitivities`), color = "red", lwd = 0.75) +
  geom_line(data = base.inla.roc.data.final.tt, aes(x = `base.inla.roc.data.tt$specificities`, y = `base.inla.roc.data.tt$sensitivities`), color = "blue", lwd = 0.75) +
  geom_line(data = roc.data.final.tt, aes(x = `roc.data.tt$specificities`, y = `roc.data.tt$sensitivities`), lwd = 0.75) +
  scale_x_reverse() + 
  theme_minimal() +
  xlab("Specificity") +
  #ylab("Sensitivity") +
  #ggtitle("Themeda triandra Model - ROC Curves") +
  #theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank()) +
  geom_label(aes(x = 0.25, y = 0.375, label = paste("INLA-SPDE AUC:", round(roc.data.tt$auc, 4))), size = 3) +
  geom_label(aes(x = 0.25, y = 0.225, label = paste("INLA AUC:", round(base.inla.roc.data.tt$auc, 4))), color = "blue", size = 3) +
  geom_label(aes(x = 0.25, y = 0.075, label = paste("glm AUC:", round(glm.roc.data.tt$auc, 4))), color = "red", size = 3)
# Including the clay*rain interaction effect increased AUC from 0.9337 to 0.9345
```

### Review Spatial Autocorrelation

```{r}
### Calculate Residuals for glm model

# Create Spatial Points
j2.coords <- subset(j2, select = c(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees.))
j2.spat.points <- SpatialPointsDataFrame(coords = j2.coords, data = j2, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Calculate k nearest neighbours
j2.coords.knearneigh <- knearneigh(j2.spat.points)

# Calculate neighbours list
j2.nb <- knn2nb(j2.coords.knearneigh)

# Supplement the neighbours list with spatial weights
lw <- nb2listw(j2.nb)

# Run Morans I Test glm
moran.test(glm.results.tt$residuals, lw, na.action = na.omit)
```

```{r}
### Calculate Residuals
j2.residuals <- j2 %>%
  mutate(
    mu = base.inla.results.tt$summary.fitted.values$mean[(nrow(j2)+1):nrow(j2.pred)],
    residuals = `Themeda triandra` - mu
)

# Create Spatial Points
j2.coords <- subset(j2, select = c(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees.))
j2.spat.points <- SpatialPointsDataFrame(coords = j2.coords, data = j2, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Calculate k nearest neighbours
j2.coords.knearneigh <- knearneigh(j2.spat.points)

# Calculate neighbours list
j2.nb <- knn2nb(j2.coords.knearneigh)

# Supplement the neighbours list with spatial weights
lw <- nb2listw(j2.nb)

# Run Morans I Test Base INLA
moran.test(j2.residuals$residuals, lw, na.action = na.omit)
```

```{r}
### Calculate Residuals using the Stack Index
si <- inla.stack.index(stk.obs, "obs")$data
j2.residuals <- j2 %>%
  mutate(
    mu = inla.spde.results.tt$summary.fitted.values$mean[si],
    residuals = `Themeda triandra` - mu
)

# Create Spatial Points
j2.coords <- subset(j2, select = c(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees.))
j2.spat.points <- SpatialPointsDataFrame(coords = j2.coords, data = j2, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Calculate k nearest neighbours
j2.coords.knearneigh <- knearneigh(j2.spat.points)

# Calculate neighbours list
j2.nb <- knn2nb(j2.coords.knearneigh)

# Supplement the neighbours list with spatial weights
lw <- nb2listw(j2.nb)

# Run Morans I Test Base INLA
moran.test(j2.residuals$residuals, lw, na.action = na.omit)

# The p-value is not statistically significant, and the z-score is positive.
# The null hypothesis is not rejected. The spatial distribution of high values 
# and/or low values in the dataset is not more spatially clustered than would 
# be expected if underlying spatial processes were random, ie. spatial
# autocorrelation adequately accounted for.
```

## Model Parameter Estimates

```{r}
glm.confint.tt <- confint(glm.results.tt)
glm.names.tt <- c("nitr", "awc", "phos", "clay", "rain", "tmax", "tdif")
glm.lower.tt <- c(glm.confint.tt[2], glm.confint.tt[3], glm.confint.tt[4], glm.confint.tt[5], glm.confint.tt[6], glm.confint.tt[7], glm.confint.tt[8])
glm.upper.tt <- c(glm.confint.tt[10], glm.confint.tt[11], glm.confint.tt[12], glm.confint.tt[13], glm.confint.tt[14], glm.confint.tt[15], glm.confint.tt[16])

yyy.plot.mpe.tt <- ggplot() +
  geom_vline(xintercept = 0, colour = "grey20", lty = "dashed") +
  geom_point(aes(x = glm.results.tt$coefficients[2:8], y = names(glm.results.tt$coefficients[2:8]), colour = "glm"), position = position_nudge(y = 0.25), size = 1.5) +
  geom_point(aes(x = inla.spde.results.tt$summary.fixed$mean[2:8], y = c("nitr", "awc", "phos", "clay", "rain", "tmax", "tdif"), colour = "INLA-SPDE"), position = position_nudge(y = -0.25), size = 1.5) +
  geom_point(aes(x = base.inla.results.tt$summary.fixed$mean[2:8], y = base.inla.results.tt$names.fixed[2:8], colour = "INLA"), position = position_nudge(y = 0), size = 1.5) +
  #
  geom_errorbarh(aes(xmin = glm.lower.tt, xmax = glm.upper.tt, y = glm.names.tt, colour = "glm"), position = position_nudge(y = 0.25), height = 0.175, lwd = 0.75) +
  geom_errorbarh(aes(xmin = inla.spde.results.tt$summary.fixed$`0.025quant`[2:8], xmax = inla.spde.results.tt$summary.fixed$`0.975quant`[2:8], y = c("nitr", "awc", "phos", "clay", "rain", "tmax", "tdif"), colour = "INLA-SPDE"), position = position_nudge(y = -0.25), height = 0.175, lwd = 0.75) +
  geom_errorbarh(aes(xmin = base.inla.results.tt$summary.fixed$`0.025quant`[2:8], xmax = base.inla.results.tt$summary.fixed$`0.975quant`[2:8], y = base.inla.results.tt$names.fixed[2:8], colour = "INLA"), position = position_nudge(y = 0), height = 0.175, lwd = 0.75) +
  #
  #ylab("Model Parameters") +
  #xlab("") +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank()) +
  xlim(-2.5, 4.5) +
  scale_x_continuous(breaks = c(-2, -1, 0, 1, 2, 3, 4), limits = c(-2.5, 4.5)) +
  scale_color_manual(name = "Model", breaks = c("glm", "INLA", "INLA-SPDE"), values = c("red", "blue", "black"))
```

## Spatial Extrapolation Plots

```{r}
# Load in Prediction Grid
load("extrap_df.Rdata")

colnames(extrap_df) <- c("Longitude", "Latitude", "clay", "awc", "carb", "nitr", "phos", "rain1982", "rain2011", "tmax1982", "tmax2011", "tmin1982", "tmin2011","tdif1982", "tdif2011")

# Create Prediction Dataframe
df.pred <- extrap_df[,1:2]
df.pred$clay <- extrap_df$clay
df.pred$awc <- extrap_df$awc
df.pred$carb <- extrap_df$carb
df.pred$nitr <- extrap_df$nitr
df.pred$phos <- extrap_df$phos
df.pred$rain1982 <- extrap_df$rain1982
df.pred$rain2011 <- extrap_df$rain2011
df.pred$tmax1982 <- extrap_df$tmax1982
df.pred$tmax2011 <- extrap_df$tmax2011
df.pred$tdif1982 <- extrap_df$tdif1982
df.pred$tdif2011 <- extrap_df$tdif2011
```

### glm Model

```{r}
# Fit Prediction GLM
formula <- `Themeda triandra` ~ nitr + awc + phos + clay + rain + tmax + tdif
glm.pred.results <- glm(formula, data = j2, family = "binomial")

# 1982 Climatic Data Frame
df.pred.1982 <- df.pred %>% dplyr::select(Longitude, Latitude, clay, awc, carb, nitr, phos, rain1982, tmax1982, tdif1982)

colnames(df.pred.1982) <- c("Longitude", "Latitude", "clay", "awc", "carb", "nitr", "phos", "rain", "tmax", "tdif")

# Predict New Values using GLM
extrap.glm.1982 <- as.data.frame(predict.glm(glm.pred.results, newdata = df.pred.1982, type = "link", se.fit = TRUE)) 

###
ilink <- family(glm.pred.results)$linkinv
extrap.glm.1982 <- transform(extrap.glm.1982, Fitted = ilink(fit), Upper = ilink(fit + (2 * se.fit)), Lower = ilink(fit - (2 * se.fit)))
extrap.glm.1982$`Predicted Range` <- extrap.glm.1982$Upper - extrap.glm.1982$Lower
###

extrap.glm.1982$Longitude <- df.pred$Longitude
extrap.glm.1982$Latitude <- df.pred$Latitude

colnames(extrap.glm.1982) <- c("fit", "se.fit", "residual.scale", "Presence Probability", "Upper", "Lower", "Predicted Range", "Longitude", "Latitude")

# 2011 Climatic Data Frame
df.pred.2011 <- df.pred %>% dplyr::select(Longitude, Latitude, clay, awc, carb, nitr, phos, rain2011, tmax2011, tdif2011)

colnames(df.pred.2011) <- c("Longitude", "Latitude", "clay", "awc", "carb", "nitr", "phos", "rain", "tmax", "tdif")

# Predict New Values using GLM
extrap.glm.2011 <- as.data.frame(predict.glm(glm.pred.results, newdata = df.pred.2011, type = "link", se.fit = TRUE)) 

###
extrap.glm.2011 <- transform(extrap.glm.2011, Fitted = ilink(fit), Upper = ilink(fit + (2 * se.fit)), Lower = ilink(fit - (2 * se.fit)))
extrap.glm.2011$`Predicted Range` <- extrap.glm.2011$Upper - extrap.glm.2011$Lower
###

extrap.glm.2011$Longitude <- df.pred$Longitude
extrap.glm.2011$Latitude <- df.pred$Latitude

colnames(extrap.glm.2011) <- c("fit", "se.fit", "residual.scale", "Presence Probability", "Upper", "Lower", "Predicted Range", "Longitude", "Latitude")
```

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
xxx.spat.plot.tt.glm.82 <- ggplot() +
  geom_tile(data = extrap.glm.1982, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +##322FBA   #189119
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  annotation_north_arrow(location = "tl", which_north = "true", 
                         pad_x = unit(0.1, "in"), pad_y = unit(0.1, "in"),
                         style = north_arrow_fancy_orienteering, height = unit(1, "cm"), width = unit(1, "cm")) +  
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Themeda triandra Predicted Spatial Plot for 1982 Climatic Data (glm)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())

### Spatial Plot with 2011 Climatic Data
xxx.spat.plot.tt.glm.11 <- ggplot() +
  geom_tile(data = extrap.glm.2011, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  #scale_fill_binned(type = "viridis") +
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  #scale_fill_gradientn(limits = c(0, 0.8), colours = c("#440154FF", "#453781FF", "#33638DFF", "#238A8DFF", "#29AF7FFF", "#73D055FF", "#DCE319FF")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Themeda triandra Predicted Spatial Plot for 2011 Climatic Data (glm)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### Predicted Range Plots

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
rrr.spat.plot.tt.glm.82 <- ggplot() +
  geom_tile(data = extrap.glm.1982, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +##322FBA   #189119
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  annotation_north_arrow(location = "tl", which_north = "true", 
                         pad_x = unit(0.1, "in"), pad_y = unit(0.2, "in"),
                         style = north_arrow_fancy_orienteering, height = unit(1, "cm"), width = unit(1, "cm")) +  
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Themeda triandra Predicted Spatial Plot for 1982 Climatic Data (glm)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())

### Spatial Plot with 2011 Climatic Data
rrr.spat.plot.tt.glm.11 <- ggplot() +
  geom_tile(data = extrap.glm.2011, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  #scale_fill_binned(type = "viridis") +
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  #scale_fill_gradientn(limits = c(0, 0.8), colours = c("#440154FF", "#453781FF", "#33638DFF", "#238A8DFF", "#29AF7FFF", "#73D055FF", "#DCE319FF")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Themeda triandra Predicted Spatial Plot for 2011 Climatic Data (glm)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### Base INLA Model

```{r}
### Spatial Random Effect

# Create Spatial Points
j2.spat.points <- SpatialPointsDataFrame(coords = j2.coords, data = j2, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Create Spatial dataframe
x <- data.frame(matrix(NA, nrow = nrow(j2.spat.points), ncol = 0))
x$Longitude <- j2.spat.points$c3c4.Longitude..Decimal.Degrees.
x$Latitude <- j2.spat.points$c3c4.Latitude..Decimal.Degrees.

# Calculate Clusters using Mean Shift Clustering
j2.mean.shift <- ms(x, h = 0.1, scaled = FALSE, iter = 200, plotms = -1)

# Observed Data 1982
df.obs.1982 <- j2 %>% dplyr::select(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees., clay, awc, carb, nitr, phos, rain, tmax, tdif, `Themeda triandra`)

df.obs.1982$ID <- j2.mean.shift$cluster.label

colnames(df.obs.1982) <- c("Longitude", "Latitude", "clay", "awc", "carb", "nitr", "phos", "rain", "tmax", "tdif", "Themeda triandra", "ID")

# Prediction Data 1982
df.pred.1982$`Themeda triandra` <- NA

### Spatial Random Effect

# Create Spatial Points
j2.spat.points <- SpatialPointsDataFrame(coords = df.pred.1982[,1:2], data = df.pred.1982, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Create Spatial dataframe
x <- data.frame(matrix(NA, nrow = nrow(j2.spat.points), ncol = 0))
x$Longitude <- j2.spat.points$Longitude
x$Latitude <- j2.spat.points$Latitude

# Calculate Clusters using Mean Shift Clustering
j2.pred.mean.shift <- ms(x, h = 0.1, scaled = FALSE, iter = 200, plotms = -1)

# Add Spatial Component to Prediction Data 1982
df.pred.1982$ID <- j2.pred.mean.shift$cluster.label

# Combined Data 1982
df.pred.inla.1982 <- rbind(df.obs.1982, df.pred.1982)

formula <- "`Themeda triandra`" ~ nitr + awc + phos + clay + rain + tmax + tdif + f(ID, model = "iid")

# Predict New Values using Base INLA 1982
extrap.base.inla.1982 <- inla(formula,
                  family = "binomial",
                  data = df.pred.inla.1982,
                  control.family = list(link = "logit"),
                  control.predictor = list(link = 1, compute = TRUE),
                  control.compute = list(dic = TRUE, cpo = TRUE, waic = TRUE),
                  verbose = FALSE)

# Predicted Values for Plotting 1982
df.extrap.base.inla.1982 <- as.data.frame(extrap.base.inla.1982$summary.fitted.values$mean[(nrow(j2) + 1):length(extrap.base.inla.1982$summary.fitted.values$mean)])

###
df.extrap.base.inla.1982$Upper <- extrap.base.inla.1982$summary.fitted.values$`0.975quant`[(nrow(j2) + 1):length(extrap.base.inla.1982$summary.fitted.values$`0.975quant`)]
df.extrap.base.inla.1982$Lower <- extrap.base.inla.1982$summary.fitted.values$`0.025quant`[(nrow(j2) + 1):length(extrap.base.inla.1982$summary.fitted.values$`0.025quant`)]
###

df.extrap.base.inla.1982$Longitude <- df.pred.1982$Longitude
df.extrap.base.inla.1982$Latitude <- df.pred.1982$Latitude

colnames(df.extrap.base.inla.1982) <- c("Presence Probability", "Upper", "Lower",  "Longitude", "Latitude")
df.extrap.base.inla.1982$`Predicted Range` <- df.extrap.base.inla.1982$Upper - df.extrap.base.inla.1982$Lower

# Observed Data 2011
df.obs.2011 <- j2 %>% dplyr::select(c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees., clay, awc, carb, nitr, phos, rain, tmax, tdif, `Themeda triandra`)

df.obs.2011$ID <- j2.mean.shift$cluster.label

colnames(df.obs.2011) <- c("Longitude", "Latitude", "clay", "awc", "carb", "nitr", "phos", "rain", "tmax", "tdif", "Themeda triandra", "ID")

# Prediction Data 2011
df.pred.2011$`Themeda triandra` <- NA

### Spatial Random Effect

# Create Spatial Points
j2.spat.points <- SpatialPointsDataFrame(coords = df.pred.2011[,1:2], data = df.pred.2011, proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84"))

# Create Spatial dataframe
x <- data.frame(matrix(NA, nrow = nrow(j2.spat.points), ncol = 0))
x$Longitude <- j2.spat.points$Longitude
x$Latitude <- j2.spat.points$Latitude

# Calculate Clusters using Mean Shift Clustering
j2.pred.mean.shift <- ms(x, h = 0.1, scaled = FALSE, iter = 200, plotms = -1)

# Add Spatial Component to Prediction Data 1982
df.pred.2011$ID <- j2.pred.mean.shift$cluster.label

# Combined Data 2011
df.pred.inla.2011 <- rbind(df.obs.2011, df.pred.2011)

formula <- "`Themeda triandra`" ~ nitr + awc + phos + clay + rain + tmax + tdif + f(ID, model = "iid")

# Predict New Values using Base INLA 2011
extrap.base.inla.2011 <- inla(formula,
                  family = "binomial",
                  data = df.pred.inla.2011,
                  control.family = list(link = "logit"),
                  control.predictor = list(link = 1, compute = TRUE),
                  control.compute = list(dic = TRUE, cpo = TRUE, waic = TRUE),
                  verbose = FALSE)

# Predicted Values for Plotting 2011
df.extrap.base.inla.2011 <- as.data.frame(extrap.base.inla.2011$summary.fitted.values$mean[1616:length(extrap.base.inla.2011$summary.fitted.values$mean)])

###
df.extrap.base.inla.2011$Upper <- extrap.base.inla.2011$summary.fitted.values$`0.975quant`[(nrow(j2) + 1):length(extrap.base.inla.2011$summary.fitted.values$`0.975quant`)]
df.extrap.base.inla.2011$Lower <- extrap.base.inla.2011$summary.fitted.values$`0.025quant`[(nrow(j2) + 1):length(extrap.base.inla.2011$summary.fitted.values$`0.025quant`)]
###

df.extrap.base.inla.2011$Longitude <- df.pred.2011$Longitude
df.extrap.base.inla.2011$Latitude <- df.pred.2011$Latitude

colnames(df.extrap.base.inla.2011) <- c("Presence Probability", "Upper", "Lower",  "Longitude", "Latitude")
df.extrap.base.inla.2011$`Predicted Range` <- df.extrap.base.inla.2011$Upper - df.extrap.base.inla.2011$Lower
```

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
xxx.spat.plot.tt.inla.82 <- ggplot() +
  geom_tile(data = df.extrap.base.inla.1982, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Themeda triandra Predicted Spatial Plot for 1982 Climatic Data (Base INLA)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())

### Spatial Plot with 2011 Climatic Data
xxx.spat.plot.tt.inla.11 <- ggplot() +
  geom_tile(data = df.extrap.base.inla.2011, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Themeda triandra Predicted Spatial Plot for 2011 Climatic Data (Base INLA)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### Predicted Range Plots

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
rrr.spat.plot.tt.inla.82 <- ggplot() +
  geom_tile(data = df.extrap.base.inla.1982, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Themeda triandra Predicted Spatial Plot for 1982 Climatic Data (Base INLA)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())

### Spatial Plot with 2011 Climatic Data
rrr.spat.plot.tt.inla.11 <- ggplot() +
  geom_tile(data = df.extrap.base.inla.2011, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_viridis() +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#000080")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Themeda triandra Predicted Spatial Plot for 2011 Climatic Data (Base INLA)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### INLA-SPDE Model

```{r}
# Create Observed Data Mesh
j2.coord <- cbind(j2$c3c4.Longitude..Decimal.Degrees., j2$c3c4.Latitude..Decimal.Degrees.)
mesh <- inla.mesh.2d(loc = j2.coord, max.edge = c(5, 10), offset = c(3, 7))
spde <- inla.spde2.matern(mesh = mesh, alpha = 2, constr = TRUE)
indexs <- inla.spde.make.index("s", spde$n.spde)
A <- inla.spde.make.A(mesh = mesh, loc = j2.coord) # Create Projection Matrix A

# Create Predicted Data Mesh 
j2.coord.pred <- cbind(extrap_df$Longitude, extrap_df$Latitude)
mesh.pred <- inla.mesh.2d(loc = j2.coord.pred, max.edge = c(5, 10), offset = c(3, 7))
spde.p <- inla.spde2.matern(mesh = mesh.pred, alpha = 2, constr = TRUE)
indexsp <- inla.spde.make.index("sp", spde.p$n.spde)
A.pred <- inla.spde.make.A(mesh = mesh.pred, loc = j2.coord.pred) # Create Predicted Projection Matrix A


# Create Observed Stack
stk.obs <- inla.stack(tag = "obs", data = list(y = j2$`Themeda triandra`), 
                    A = list(1, A), effects = list(data.frame(b0 = 1, nitr = j2$nitr,
                    awc = j2$awc, phos = j2$phos, clay = j2$clay,
                    rain = j2$rain, tmax = j2$tmax, tdif = j2$tdif), s = indexs))

# Create Prediction Stack
stk.pred <- inla.stack(tag = "pred", data = list(y = NA), A = list(1, A.pred), 
                       effects = list(data.frame(b0 = 1, nitr = extrap_df$nitr,
                       awc = extrap_df$awc, phos = extrap_df$phos, 
                       clay = extrap_df$clay, rain = extrap_df$rain1982, 
                       tmax = extrap_df$tmax1982, tdif = extrap_df$tdif1982), sp = indexsp))

# Combine Stacks
stk.full <- inla.stack(stk.obs, stk.pred)

formula <- y ~ 0 + b0 + nitr + awc + phos + clay + rain + tmax + tdif + f(sp, model = spde)

extrap.inla.spde.1982 <- inla(formula, family = "binomial", 
            control.family = list(link = "logit"),
            data = inla.stack.data(stk.full),
            control.predictor = list(compute = TRUE, link = 1, A = inla.stack.A(stk.full)))

###

index <- inla.stack.index(stack = stk.full, tag = "pred")$data
pres_mean <- extrap.inla.spde.1982$summary.fitted.values[index, "mean"]

###
Upper <- extrap.inla.spde.1982$summary.fitted.values[index, "0.975quant"]
Lower <- extrap.inla.spde.1982$summary.fitted.values[index, "0.025quant"]
###

# Predicted Values for Plotting 1982
df.extrap.inla.spde.1982 <- as.data.frame(pres_mean)

df.extrap.inla.spde.1982$Upper <- Upper
df.extrap.inla.spde.1982$Lower <- Lower

df.extrap.inla.spde.1982$Longitude <- extrap_df$Longitude
df.extrap.inla.spde.1982$Latitude <- extrap_df$Latitude

colnames(df.extrap.inla.spde.1982) <- c("Presence Probability", "Upper", "Lower", "Longitude", "Latitude")
df.extrap.inla.spde.1982$`Predicted Range` <- df.extrap.inla.spde.1982$Upper - df.extrap.inla.spde.1982$Lower
```

```{r}
# Create Observed Data Mesh
j2.coord <- cbind(j2$c3c4.Longitude..Decimal.Degrees., j2$c3c4.Latitude..Decimal.Degrees.)
mesh <- inla.mesh.2d(loc = j2.coord, max.edge = c(5, 10), offset = c(3, 7))
spde <- inla.spde2.matern(mesh = mesh, alpha = 2, constr = TRUE)
indexs <- inla.spde.make.index("s", spde$n.spde)
A <- inla.spde.make.A(mesh = mesh, loc = j2.coord) # Create Projection Matrix A

# Create Predicted Data Mesh 
j2.coord.pred <- cbind(extrap_df$Longitude, extrap_df$Latitude)
mesh.pred <- inla.mesh.2d(loc = j2.coord.pred, max.edge = c(5, 10), offset = c(3, 7))
spde.p <- inla.spde2.matern(mesh = mesh.pred, alpha = 2, constr = TRUE)
indexsp <- inla.spde.make.index("sp", spde.p$n.spde)
A.pred <- inla.spde.make.A(mesh = mesh.pred, loc = j2.coord.pred) # Create Predicted Projection Matrix A


# Create Observed Stack
stk.obs <- inla.stack(tag = "obs", data = list(y = j2$`Themeda triandra`), 
                    A = list(1, A), effects = list(data.frame(b0 = 1, nitr = j2$nitr,
                    awc = j2$awc, phos = j2$phos, clay = j2$clay,
                    rain = j2$rain, tmax = j2$tmax, tdif = j2$tdif), s = indexs))

# Create Prediction Stack
stk.pred <- inla.stack(tag = "pred", data = list(y = NA), A = list(1, A.pred), 
                       effects = list(data.frame(b0 = 1, nitr = extrap_df$nitr,
                       awc = extrap_df$awc, phos = extrap_df$phos, 
                       clay = extrap_df$clay, rain = extrap_df$rain2011, 
                       tmax = extrap_df$tmax2011, tdif = extrap_df$tdif2011), sp = indexsp))

# Combine Stacks
stk.full <- inla.stack(stk.obs, stk.pred)

formula <- y ~ 0 + b0 + nitr + awc + phos + clay + rain + tmax + tdif + f(sp, model = spde)

extrap.inla.spde.2011 <- inla(formula, family = "binomial", 
            control.family = list(link = "logit"),
            data = inla.stack.data(stk.full),
            control.predictor = list(compute = TRUE, link = 1, A = inla.stack.A(stk.full)))

###

index <- inla.stack.index(stack = stk.full, tag = "pred")$data
pres_mean <- extrap.inla.spde.2011$summary.fitted.values[index, "mean"]

###
Upper <- extrap.inla.spde.2011$summary.fitted.values[index, "0.975quant"]
Lower <- extrap.inla.spde.2011$summary.fitted.values[index, "0.025quant"]
###

# Predicted Values for Plotting 2011
df.extrap.inla.spde.2011 <- as.data.frame(pres_mean)

df.extrap.inla.spde.2011$Upper <- Upper
df.extrap.inla.spde.2011$Lower <- Lower

df.extrap.inla.spde.2011$Longitude <- extrap_df$Longitude
df.extrap.inla.spde.2011$Latitude <- extrap_df$Latitude

colnames(df.extrap.inla.spde.2011) <- c("Presence Probability", "Upper", "Lower", "Longitude", "Latitude")
df.extrap.inla.spde.2011$`Predicted Range` <- df.extrap.inla.spde.2011$Upper - df.extrap.inla.spde.2011$Lower
```

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
xxx.spat.plot.tt.inla.spde.82 <- ggplot() +
  geom_tile(data = df.extrap.inla.spde.1982, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Themeda triandra Predicted Spatial Plot for 1982 Climatic Data (INLA-SPDE)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

```{r}
### Spatial Plot with 2011 Climatic Data
xxx.spat.plot.tt.inla.spde.11 <- ggplot() +
  geom_tile(data = df.extrap.inla.spde.2011, aes(x = Longitude, y = Latitude, fill = `Presence Probability`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 0.8), colours = c("#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Themeda triandra Predicted Spatial Plot for 2011 Climatic Data (INLA-SPDE)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### Predicted Range Plots

```{r}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Spatial Plot with 1982 Climatic Data
rrr.spat.plot.tt.inla.spde.82 <- ggplot() +
  geom_tile(data = df.extrap.inla.spde.1982, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Themeda triandra Predicted Spatial Plot for 1982 Climatic Data (INLA-SPDE)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

```{r}
### Spatial Plot with 2011 Climatic Data
rrr.spat.plot.tt.inla.spde.11 <- ggplot() +
  geom_tile(data = df.extrap.inla.spde.2011, aes(x = Longitude, y = Latitude, fill = `Predicted Range`), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#142833", mid = "#00997c", high = "#edfb11", midpoint = 0.3) +
  #scale_fill_gradient2(low = "#FFFFFF", mid = "#142833", high = "#000000", midpoint = 0.5) +
  #scale_fill_gradient(low = "#FFFFFF", high = "#142833") +
  scale_fill_gradientn(limits = c(0, 1.0), colours = c("#FFFFFF", "#000080")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  #annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "tl", which_north = "true", 
                         #pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         #style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  #ggtitle("Themeda triandra Predicted Spatial Plot for 2011 Climatic Data (INLA-SPDE)") +
  #theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank()) +
  theme(axis.title.y = element_blank())
```

### Spatial Difference Plots

```{r eval=FALSE, include=FALSE}
df.diff.glm.inla.spde <- as.data.frame(extrap.glm.1982$`Presence Probability`)
df.diff.glm.inla.spde$inla.spde.1982 <- df.extrap.inla.spde.1982$`Presence Probability`

colnames(df.diff.glm.inla.spde) <- c("glm.1982.pres", "inla.spde.1982.pres")

df.diff.glm.inla.spde$Longitude <- extrap_df$Longitude
df.diff.glm.inla.spde$Latitude <- extrap_df$Latitude

df.diff.glm.inla.spde$difference <- df.diff.glm.inla.spde$inla.spde.1982.pres - df.diff.glm.inla.spde$glm.1982.pres
```

```{r eval=FALSE, include=FALSE}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Difference Plots Colours
diff.col.pal <- c("red", "orange", "white", "white", "lightgreen", "green", "darkgreen", "#003300")

### Spatial Difference Plot with 1982 Climatic Data
ggplot() +
  geom_tile(data = df.diff.glm.inla.spde, aes(x = Longitude, y = Latitude, fill = difference), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#90242b", mid = "#FFFFFF", high = "#142833", midpoint = 0) +
  scale_fill_gradientn(limits = c(-0.3, 0.3), colours = c("#800000", "#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  annotation_scale(location = "bl", width_hint = 0.5) +
  annotation_north_arrow(location = "tl", which_north = "true", 
                         pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  ggtitle("Themeda triandra Spatial Difference Plot for\n1982 Climatic Data (glm vs INLA-SPDE)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal()
```

```{r eval=FALSE, include=FALSE}
ggplot() +
  geom_histogram(data = df.diff.glm.inla.spde, aes(x = difference), binwidth = 0.025) +
  geom_vline(xintercept = median(df.diff.glm.inla.spde$difference, na.rm = TRUE)) +
  geom_label(label = paste0("Median = ", round(median(df.diff.glm.inla.spde$difference, na.rm = TRUE), 4)), aes(x = 0.2, y = 400))
```

```{r eval=FALSE, include=FALSE}
df.diff.glm.inla.spde <- as.data.frame(extrap.glm.2011$`Presence Probability`)
df.diff.glm.inla.spde$inla.spde.2011 <- df.extrap.inla.spde.2011$`Presence Probability`

colnames(df.diff.glm.inla.spde) <- c("glm.2011.pres", "inla.spde.2011.pres")

df.diff.glm.inla.spde$Longitude <- extrap_df$Longitude
df.diff.glm.inla.spde$Latitude <- extrap_df$Latitude

df.diff.glm.inla.spde$difference <- df.diff.glm.inla.spde$inla.spde.2011.pres - df.diff.glm.inla.spde$glm.2011.pres
```

```{r eval=FALSE, include=FALSE}
### Create Spatial Objects
mask <- aus_shp %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5) %>%
  st_difference(aus_shp) %>%
  st_as_sf()

### Difference Plots Colours
diff.col.pal <- c("white", "white", "lightgreen", "green", "darkgreen", "#003300", "#002200", "#001100")

### Spatial Difference Plot with 1982 Climatic Data
ggplot() +
  geom_tile(data = df.diff.glm.inla.spde, aes(x = Longitude, y = Latitude, fill = difference), alpha = 0.8, width = 1, height = 1) +
  #scale_fill_continuous(na.value = "white") +
  #scale_fill_gradient2(low = "#90242b", mid = "#FFFFFF", high = "#142833", midpoint = 0) +
  scale_fill_gradientn(limits = c(-0.3, 0.3), colours = c("#800000", "#FFFFFF", "#008000")) +
  geom_sf(data = mask, fill = "white", color = NA) +
  coord_sf(xlim = c(110.00, 158.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  borders("world", colour = "black") +
  annotation_scale(location = "bl", width_hint = 0.5) +
  annotation_north_arrow(location = "tl", which_north = "true", 
                         pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"),
                         style = north_arrow_fancy_orienteering) + 
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  ggtitle("Themeda triandra Spatial Difference Plot for\n2011 Climatic Data (glm vs INLA-SPDE)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal()
```

```{r eval=FALSE, include=FALSE}
ggplot() +
  geom_histogram(data = df.diff.glm.inla.spde, aes(x = difference), binwidth = 0.025) +
  geom_vline(xintercept = median(df.diff.glm.inla.spde$difference, na.rm = TRUE)) +
  geom_label(label = paste0("Median = ", round(median(df.diff.glm.inla.spde$difference, na.rm = TRUE), 4)), aes(x = 0.2, y = 400))
```

## Figures for Paper

### ROC-AUC

```{r, fig.height=5,fig.width=7}
plot.roc <- ggarrange(zzz.plot.ap.roc, zzz.plot.be.roc, zzz.plot.df.roc, zzz.plot.tt.roc, nrow = 2, ncol = 2, labels = c("a)", "b)", "c)", "d)"), left = "Sensitivity", bottom = "1 - Specificity", vjust = 0.55)
plot.roc$`1`
ggsave("ROC-AUC.jpg", plot = plot.roc$`1`, device = "jpg", width = 7, height = 4.5, units = "in")
```

### Model Parameter Estimate Plots

```{r, fig.height=5,fig.width=7}
plot.mpe <- ggarrange(yyy.plot.mpe.ap, yyy.plot.mpe.be, yyy.plot.mpe.df, yyy.plot.mpe.tt, nrow = 2, ncol = 2, labels = c("a)", "b)", "c)", "d)"), common.legend = TRUE, vjust = 0.8)
annotate_figure(plot.mpe, left = "Model Parameters", bottom = "Effect Size (Standardised)")
#plot.mpe
ggsave("Model Parameter Estimates.jpg", plot = plot.mpe, device = "jpg", width = 7, height = 5, units = "in")
```

### Astrebla pectinata Spatial Extrapolation Plots

```{r, fig.height=8,fig.width=7}
plot.se.ap <- ggarrange(xxx.spat.plot.ap.glm.82, xxx.spat.plot.ap.glm.11, xxx.spat.plot.ap.inla.82, xxx.spat.plot.ap.inla.11, xxx.spat.plot.ap.inla.spde.82, xxx.spat.plot.ap.inla.spde.11, nrow = 3, ncol = 2, labels = c("a)", "b)", "c)", "d)", "e)", "f)"), heights = c(20, 20, 20), common.legend = TRUE)
plot.se.ap <- annotate_figure(plot.se.ap, bottom = text_grob("     1982 Climatic Variables                                   2011 Climatic Variables"))
plot.se.ap <- annotate_figure(plot.se.ap, left = text_grob("               INLA-SPDE                                           INLA                                            glm                      ", rot = 90))
ggsave("Spatial Extrap AP.jpg", plot = plot.se.ap, device = "jpg")
```

### Astrebla pectinata Spatial Predicted Range Plots

```{r, fig.height=8,fig.width=7}
plot.pr.ap <- ggarrange(rrr.spat.plot.ap.glm.82, rrr.spat.plot.ap.glm.11, rrr.spat.plot.ap.inla.82, rrr.spat.plot.ap.inla.11, rrr.spat.plot.ap.inla.spde.82, rrr.spat.plot.ap.inla.spde.11, nrow = 3, ncol = 2, labels = c("a)", "b)", "c)", "d)", "e)", "f)"), heights = c(20, 20, 20), common.legend = TRUE)
plot.pr.ap <- annotate_figure(plot.pr.ap, bottom = text_grob("     1982 Climatic Variables                                   2011 Climatic Variables"))
plot.pr.ap <- annotate_figure(plot.pr.ap, left = text_grob("               INLA-SPDE                                           INLA                                            glm                      ", rot = 90))
ggsave("Spatial Predicted Range AP.jpg", plot = plot.pr.ap, device = "jpg")
```


### Bothriochloa ewartiana Spatial Extrapolation Plots

```{r, fig.height=8,fig.width=7}
plot.se.be <- ggarrange(xxx.spat.plot.be.glm.82, xxx.spat.plot.be.glm.11, xxx.spat.plot.be.inla.82, xxx.spat.plot.be.inla.11, xxx.spat.plot.be.inla.spde.82, xxx.spat.plot.be.inla.spde.11, nrow = 3, ncol = 2, labels = c("a)", "b)", "c)", "d)", "e)", "f)"), heights = c(20, 20, 20), common.legend = TRUE)
plot.se.be <- annotate_figure(plot.se.be, bottom = text_grob("     1982 Climatic Variables                                   2011 Climatic Variables"))
plot.se.be <- annotate_figure(plot.se.be, left = text_grob("               INLA-SPDE                                           INLA                                            glm                      ", rot = 90))
ggsave("Spatial Extrap BE.jpg", plot = plot.se.be, device = "jpg")
```

### Bothriochloa ewartiana Predicted Range Plots

```{r, fig.height=8,fig.width=7}
plot.pr.be <- ggarrange(rrr.spat.plot.be.glm.82, rrr.spat.plot.be.glm.11, rrr.spat.plot.be.inla.82, rrr.spat.plot.be.inla.11, rrr.spat.plot.be.inla.spde.82, rrr.spat.plot.be.inla.spde.11, nrow = 3, ncol = 2, labels = c("a)", "b)", "c)", "d)", "e)", "f)"), heights = c(20, 20, 20), common.legend = TRUE)
plot.pr.be <- annotate_figure(plot.pr.be, bottom = text_grob("     1982 Climatic Variables                                   2011 Climatic Variables"))
plot.pr.be <- annotate_figure(plot.pr.be, left = text_grob("               INLA-SPDE                                           INLA                                            glm                      ", rot = 90))
ggsave("Spatial Predicted Range BE.jpg", plot = plot.pr.be, device = "jpg")
```

### Dichanthium fecundum Spatial Extrapolation Plots

```{r, fig.height=8,fig.width=7}
plot.se.df <- ggarrange(xxx.spat.plot.df.glm.82, xxx.spat.plot.df.glm.11, xxx.spat.plot.df.inla.82, xxx.spat.plot.df.inla.11, xxx.spat.plot.df.inla.spde.82, xxx.spat.plot.df.inla.spde.11, nrow = 3, ncol = 2, labels = c("a)", "b)", "c)", "d)", "e)", "f)"), heights = c(20, 20, 20), common.legend = TRUE)
plot.se.df <- annotate_figure(plot.se.df, bottom = text_grob("     1982 Climatic Variables                                   2011 Climatic Variables"))
plot.se.df <- annotate_figure(plot.se.df, left = text_grob("               INLA-SPDE                                           INLA                                            glm                      ", rot = 90))
ggsave("Spatial Extrap DF.jpg", plot = plot.se.df, device = "jpg")
```

### Dichanthium fecundum Predicted Range Plots

```{r, fig.height=8,fig.width=7}
plot.pr.df <- ggarrange(rrr.spat.plot.df.glm.82, rrr.spat.plot.df.glm.11, rrr.spat.plot.df.inla.82, rrr.spat.plot.df.inla.11, rrr.spat.plot.df.inla.spde.82, rrr.spat.plot.df.inla.spde.11, nrow = 3, ncol = 2, labels = c("a)", "b)", "c)", "d)", "e)", "f)"), heights = c(20, 20, 20), common.legend = TRUE)
plot.pr.df <- annotate_figure(plot.pr.df, bottom = text_grob("     1982 Climatic Variables                                   2011 Climatic Variables"))
plot.pr.df <- annotate_figure(plot.pr.df, left = text_grob("               INLA-SPDE                                           INLA                                            glm                      ", rot = 90))
ggsave("Spatial Predicted Range DF.jpg", plot = plot.pr.df, device = "jpg")
```

### Themeda triandra Spatial Extrapolation Plots

```{r, fig.height=8,fig.width=7}
plot.se.tt <- ggarrange(xxx.spat.plot.tt.glm.82, xxx.spat.plot.tt.glm.11, xxx.spat.plot.tt.inla.82, xxx.spat.plot.tt.inla.11, xxx.spat.plot.tt.inla.spde.82, xxx.spat.plot.tt.inla.spde.11, nrow = 3, ncol = 2, labels = c("a)", "b)", "c)", "d)", "e)", "f)"), heights = c(20, 20, 20), common.legend = TRUE)
plot.se.tt <- annotate_figure(plot.se.tt, bottom = text_grob("     1982 Climatic Variables                                   2011 Climatic Variables"))
plot.se.tt <- annotate_figure(plot.se.tt, left = text_grob("               INLA-SPDE                                           INLA                                            glm                      ", rot = 90))
ggsave("Spatial Extrap TT.jpg", plot = plot.se.tt, device = "jpg")
```

### Themeda triandra Predicted Range Plots

```{r, fig.height=8,fig.width=7}
plot.pr.tt <- ggarrange(rrr.spat.plot.tt.glm.82, rrr.spat.plot.tt.glm.11, rrr.spat.plot.tt.inla.82, rrr.spat.plot.tt.inla.11, rrr.spat.plot.tt.inla.spde.82, rrr.spat.plot.tt.inla.spde.11, nrow = 3, ncol = 2, labels = c("a)", "b)", "c)", "d)", "e)", "f)"), heights = c(20, 20, 20), common.legend = TRUE)
plot.pr.tt <- annotate_figure(plot.pr.tt, bottom = text_grob("     1982 Climatic Variables                                   2011 Climatic Variables"))
plot.pr.tt <- annotate_figure(plot.pr.tt, left = text_grob("               INLA-SPDE                                           INLA                                            glm                      ", rot = 90))
ggsave("Spatial Predicted Range TT.jpg", plot = plot.pr.tt, device = "jpg")
```

### Astrebla pectinata Spatial Difference Plots

```{r eval=FALSE, fig.height=4, fig.width=7, include=FALSE}
plot.dp.ap <- ggarrange(www.diff.plot.ap.82, www.diff.plot.ap.11, nrow = 1, ncol = 2, labels = c("a)", "b)"), heights = c(20), common.legend = TRUE)
plot.dp.ap
ggsave("Spatial Diff AP.jpg", plot = plot.dp.ap, device = "jpg")
```

```{r eval=FALSE, include=FALSE}
# Checking Climatic Variables between 1982 and 2011
ggplot() +
  geom_density(extrap_df, mapping = aes(x = tmax1982), fill = "red", alpha = 0.5) +
  geom_density(extrap_df, mapping = aes(x = tmax2011), fill = "blue", alpha = 0.5)
```

```{r eval=FALSE, include=FALSE}
# Checking Climatic Variables between 1982 and 2011
ggplot() +
  geom_density(extrap_df, mapping = aes(x = rain1982), fill = "red", alpha = 0.5) +
  geom_density(extrap_df, mapping = aes(x = rain2011), fill = "blue", alpha = 0.5)
```

```{r eval=FALSE, include=FALSE}
leaflet() %>% addTiles() %>%
  addCircles(lng = df.extrap.inla.spde.2011$Longitude, lat = df.extrap.inla.spde.2011$Latitude, color = pal(df.extrap.inla.spde.2011$`Presence Probability`)) %>%
  addLegend("bottomright", pal = pal, values = df.extrap.inla.spde.2011$`Presence Probability`, title = "Mean Presence Prob") %>%
  addScaleBar(position = c("bottomleft"))
```

```{r eval=FALSE, include=FALSE}
leaflet() %>% addTiles() %>%
  addCircles(lng = df.extrap.inla.spde.1982$Longitude, lat = df.extrap.inla.spde.1982$Latitude, color = pal(df.extrap.inla.spde.1982$`Presence Probability`)) %>%
  addLegend("bottomright", pal = pal, values = df.extrap.inla.spde.1982$`Presence Probability`, title = "Mean Presence Prob") %>%
  addScaleBar(position = c("bottomleft"))
```

## Variogram Fitting for Determination of INLA-SPDE Range Parameter

### Reload j2 dataset

```{r eval=FALSE, include=FALSE}
# Load Dataset
load("j2_clay515.Rdata")
j2 <- j2_clay515
remove(j2_clay515)

# Subset Dataset for `Astrebla pectinata`
j2 <- dplyr::select(j2, nitrogen515, awc515, phosphorus515, carbon515, clay515, rain18, tmin18, tmax18, tdiff18, c3c4.Longitude..Decimal.Degrees., c3c4.Latitude..Decimal.Degrees., `Astrebla pectinata`)

# Manage Dataset
# Convert Longitude and Latitude Variables to double type
j2$c3c4.Longitude..Decimal.Degrees. <- as.double(j2$c3c4.Longitude..Decimal.Degrees.)
j2$c3c4.Latitude..Decimal.Degrees. <- as.double(j2$c3c4.Latitude..Decimal.Degrees.)
```

### Rename j2 Variables

```{r eval=FALSE, include=FALSE}
colnames(j2) <- c("nitr", "awc", "phos", "carb", "clay", "rain", "tmin", "tmax", "tdif", "c3c4.Longitude..Decimal.Degrees.", "c3c4.Latitude..Decimal.Degrees.", "Astrebla pectinata")
```

### Data Cleaning and Preparation

```{r eval=FALSE, include=FALSE}
# Remove Observations with 'NA' values
j2 <- j2[complete.cases(j2),]
#
# Removal of Anomolous Data points
j2 <- subset(j2, j2$nitr != 0)
#
# Removal of Outliers using the IQR Criterion
#
# Remove Outliers - 'nitr' covariate
ol.quantile.nitr <- quantile(j2$nitr, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.nitr <- IQR(j2$nitr, na.rm = TRUE)
ol.upper.nitr <- ol.quantile.nitr[2] + 1.5*ol.iqr.nitr
ol.lower.nitr <- ol.quantile.nitr[1] - 1.5*ol.iqr.nitr
#
# Remove Outliers - 'awc' covariate
ol.quantile.awc <- quantile(j2$awc, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.awc <- IQR(j2$awc, na.rm = TRUE)
ol.upper.awc <- ol.quantile.awc[2] + 1.5*ol.iqr.awc
ol.lower.awc <- ol.quantile.awc[1] - 1.5*ol.iqr.awc
#
# Remove Outliers - 'phos' covariate
ol.quantile.phos <- quantile(j2$phos, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.phos <- IQR(j2$phos, na.rm = TRUE)
ol.upper.phos <- ol.quantile.phos[2] + 1.5*ol.iqr.phos
ol.lower.phos <- ol.quantile.phos[1] - 1.5*ol.iqr.phos
#
# Remove Outliers - 'carb' covariate
ol.quantile.carb <- quantile(j2$carb, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.carb <- IQR(j2$carb, na.rm = TRUE)
ol.upper.carb <- ol.quantile.carb[2] + 1.5*ol.iqr.carb
ol.lower.carb <- ol.quantile.carb[1] - 1.5*ol.iqr.carb
#
# Remove Outliers - 'clay' covariate
ol.quantile.clay <- quantile(j2$clay, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.clay <- IQR(j2$clay, na.rm = TRUE)
ol.upper.clay <- ol.quantile.clay[2] + 1.5*ol.iqr.clay
ol.lower.clay <- ol.quantile.clay[1] - 1.5*ol.iqr.clay
#
# Remove Outliers - 'rain' covariate
ol.quantile.rain <- quantile(j2$rain, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.rain <- IQR(j2$rain, na.rm = TRUE)
ol.upper.rain <- ol.quantile.rain[2] + 1.5*ol.iqr.rain
ol.lower.rain <- ol.quantile.rain[1] - 1.5*ol.iqr.rain
#
# Remove Outliers - 'tmin' covariate
ol.quantile.tmin <- quantile(j2$tmin, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.tmin <- IQR(j2$tmin, na.rm = TRUE)
ol.upper.tmin <- ol.quantile.tmin[2] + 1.5*ol.iqr.tmin
ol.lower.tmin <- ol.quantile.tmin[1] - 1.5*ol.iqr.tmin
#
# Remove Outliers - 'tmin' covariate
ol.quantile.tmin <- quantile(j2$tmin, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.tmin <- IQR(j2$tmin, na.rm = TRUE)
ol.upper.tmin <- ol.quantile.tmin[2] + 1.5*ol.iqr.tmin
ol.lower.tmin <- ol.quantile.tmin[1] - 1.5*ol.iqr.tmin
#
# Remove Outliers - 'tdif' covariate
ol.quantile.tdif <- quantile(j2$tdif, probs = c(0.25, 0.75), na.rm = TRUE)
ol.iqr.tdif <- IQR(j2$tdif, na.rm = TRUE)
ol.upper.tdif <- ol.quantile.tdif[2] + 1.5*ol.iqr.tdif
ol.lower.tdif <- ol.quantile.tdif[1] - 1.5*ol.iqr.tdif
#
# Subsetting
j2 <- subset(j2, nitr > ol.lower.nitr & nitr < ol.upper.nitr)
j2 <- subset(j2, awc > ol.lower.awc & awc < ol.upper.awc)
j2 <- subset(j2, phos > ol.lower.phos & phos < ol.upper.phos)
j2 <- subset(j2, carb > ol.lower.carb & carb < ol.upper.carb)
j2 <- subset(j2, clay > ol.lower.clay & clay < ol.upper.clay)
j2 <- subset(j2, rain > ol.lower.rain & rain < ol.upper.rain)
j2 <- subset(j2, tmin > ol.lower.tmin & tmin < ol.upper.tmin)
j2 <- subset(j2, tmin > ol.lower.tmin & tmin < ol.upper.tmin)
j2 <- subset(j2, tdif > ol.lower.tdif & tdif < ol.upper.tdif)
#
```

```{r eval=FALSE, include=FALSE}
j2.geo.data.ap <- as.geodata(j2, coords.col = 10:11, data.col = 12)
vario.ap <- variog(j2.geo.data.ap, option = "bin", estimator.type = "classical",
                   uvec = seq(0,5,0.01))

fit.matern <- variofit(vario.ap, ini.cov.pars = c(0.6, 10), cov.model = "matern", kappa = 0.3, fix.nugget = T, nugget = 0.03)
plot(vario.ap)
lines(fit.matern, col = "blue")
abline(v = 2, col = "red", lty = 2)
abline(v = 0.573, col = "darkgreen", lty = 2)
```

```{r eval=FALSE, include=FALSE}
# tausq is the fixed nugget value "the micro-scale spatial variation"
# sigmasq is the sill "the amount of variance in the data where correlation between observations levels off"
# phi is the range parameter "the distance where correlation between observations drops below 5%
print(fit.matern)
```

### Predicted Spatial Range

```{r}
# Extract the calculated range parameter 'phi' from the observed INLA SPDE Model
r.f.tt <- inla.spde2.result(inla.spde.results.tt, "s", spde, do.transf = TRUE)
par(mfrow = c(2, 2))
plot(inla.spde.results.tt$marginals.fixed[[1]], type = "l", xlab = "Intercept", ylab = "Density")
plot(inla.spde.results.tt$marginals.hyperpar[[1]], type = "l", ylab = "Density", xlab = expression(phi))
plot.default(r.f.tt$marginals.variance.nominal[[1]], type = "l", xlab = expression(sigma[x]^2), ylab = "Density")
plot.default(r.f.tt$marginals.range.nominal[[1]], type = "l", xlab = "Practical range", ylab = "Density")
#
temp.df.tt <- as.data.frame(r.f.tt$marginals.range.nominal)
abline(v = max(temp.df.tt$range.nominal.1.x[which.max(temp.df.tt$range.nominal.1.y)]), col = "red", lty = 2)
paste0("Practical Range (Maximum Likelihood): ", round(max(temp.df.tt$range.nominal.1.x[which.max(temp.df.tt$range.nominal.1.y)]), 2), " Arc Degrees")
```

```{r}
par(mfrow = c(2, 2))
plot.default(r.f.ap$marginals.range.nominal[[1]], type = "l", xlab = "Practical range", ylab = "Density")
abline(v = max(temp.df.ap$range.nominal.1.x[which.max(temp.df.ap$range.nominal.1.y)]), col = "red", lty = 2)

plot.default(r.f.be$marginals.range.nominal[[1]], type = "l", xlab = "Practical range", ylab = "Density")
abline(v = max(temp.df.be$range.nominal.1.x[which.max(temp.df.be$range.nominal.1.y)]), col = "red", lty = 2)

plot.default(r.f.df$marginals.range.nominal[[1]], type = "l", xlab = "Practical range", ylab = "Density")
abline(v = max(temp.df.df$range.nominal.1.x[which.max(temp.df.df$range.nominal.1.y)]), col = "red", lty = 2)

plot.default(r.f.tt$marginals.range.nominal[[1]], type = "l", xlab = "Practical range", ylab = "Density")
abline(v = max(temp.df.tt$range.nominal.1.x[which.max(temp.df.tt$range.nominal.1.y)]), col = "red", lty = 2)
par(mfrow = c(1, 1))
```